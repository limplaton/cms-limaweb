import{B as ce,E as $,a2 as re}from"./app-BQnv5pK3.js";function ue(Z,ne){for(var Q=0;Q<ne.length;Q++){const J=ne[Q];if(typeof J!="string"&&!Array.isArray(J)){for(const O in J)if(O!=="default"&&!(O in Z)){const F=Object.getOwnPropertyDescriptor(J,O);F&&Object.defineProperty(Z,O,F.get?F:{enumerable:!0,get:()=>J[O]})}}}return Object.freeze(Object.defineProperty(Z,Symbol.toStringTag,{value:"Module"}))}var ae={};(function(){(function(Z){var ne=function(){function O(F,w,y){function p(S,g){if(!w[S]){if(!F[S]){var b=typeof re=="function"&&re;if(!g&&b)return b(S,!0);if(d)return d(S,!0);var h=new Error("Cannot find module '"+S+"'");throw h.code="MODULE_NOT_FOUND",h}var T=w[S]={exports:{}};F[S][0].call(T.exports,function(u){var a=F[S][1][u];return p(a||u)},T,T.exports,O,F,w,y)}return w[S].exports}for(var d=typeof re=="function"&&re,l=0;l<y.length;l++)p(y[l]);return p}return O}()({1:[function(O,F,w){Object.defineProperty(w,"__esModule",{value:!0}),w.TwilioError=w.Logger=w.PreflightTest=w.Device=w.Call=void 0;var y=O("./twilio/call");w.Call=y.default;var p=O("./twilio/device");w.Device=p.default;var d=O("./twilio/errors");w.TwilioError=d;var l=O("./twilio/log");Object.defineProperty(w,"Logger",{enumerable:!0,get:function(){return l.Logger}});var S=O("./twilio/preflight/preflight");Object.defineProperty(w,"PreflightTest",{enumerable:!0,get:function(){return S.PreflightTest}})},{"./twilio/call":8,"./twilio/device":11,"./twilio/errors":14,"./twilio/log":17,"./twilio/preflight/preflight":19}],2:[function(O,F,w){var y=this&&this.__awaiter||function(S,g,b,h){function T(u){return u instanceof b?u:new b(function(a){a(u)})}return new(b||(b=Promise))(function(u,a){function v(n){try{i(h.next(n))}catch(e){a(e)}}function o(n){try{i(h.throw(n))}catch(e){a(e)}}function i(n){n.done?u(n.value):T(n.value).then(v,o)}i((h=h.apply(S,g||[])).next())})},p=this&&this.__generator||function(S,g){var b={label:0,sent:function(){if(u[0]&1)throw u[1];return u[1]},trys:[],ops:[]},h,T,u,a;return a={next:v(0),throw:v(1),return:v(2)},typeof Symbol=="function"&&(a[Symbol.iterator]=function(){return this}),a;function v(i){return function(n){return o([i,n])}}function o(i){if(h)throw new TypeError("Generator is already executing.");for(;b;)try{if(h=1,T&&(u=i[0]&2?T.return:i[0]?T.throw||((u=T.return)&&u.call(T),0):T.next)&&!(u=u.call(T,i[1])).done)return u;switch(T=0,u&&(i=[i[0]&2,u.value]),i[0]){case 0:case 1:u=i;break;case 4:return b.label++,{value:i[1],done:!1};case 5:b.label++,T=i[1],i=[0];continue;case 7:i=b.ops.pop(),b.trys.pop();continue;default:if(u=b.trys,!(u=u.length>0&&u[u.length-1])&&(i[0]===6||i[0]===2)){b=0;continue}if(i[0]===3&&(!u||i[1]>u[0]&&i[1]<u[3])){b.label=i[1];break}if(i[0]===6&&b.label<u[1]){b.label=u[1],u=i;break}if(u&&b.label<u[2]){b.label=u[2],b.ops.push(i);break}u[2]&&b.ops.pop(),b.trys.pop();continue}i=g.call(S,b)}catch(n){i=[6,n],T=0}finally{h=u=0}if(i[0]&5)throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}};Object.defineProperty(w,"__esModule",{value:!0}),w.AsyncQueue=void 0;var d=O("./deferred"),l=function(){function S(){this._operations=[]}return S.prototype.enqueue=function(g){var b=!!this._operations.length,h=new d.default;return this._operations.push({deferred:h,callback:g}),b||this._processQueue(),h.promise},S.prototype._processQueue=function(){return y(this,void 0,void 0,function(){var g,b,h,T,u,a,v;return p(this,function(o){switch(o.label){case 0:if(!this._operations.length)return[3,5];g=this._operations[0],b=g.deferred,h=g.callback,T=void 0,u=void 0,a=void 0,o.label=1;case 1:return o.trys.push([1,3,,4]),[4,h()];case 2:return T=o.sent(),a=!0,[3,4];case 3:return v=o.sent(),u=v,[3,4];case 4:return this._operations.shift(),a?b.resolve(T):b.reject(u),[3,0];case 5:return[2]}})})},S}();w.AsyncQueue=l},{"./deferred":10}],3:[function(O,F,w){var y=this&&this.__extends||function(){var v=function(o,i){return v=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,e){n.__proto__=e}||function(n,e){for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(n[t]=e[t])},v(o,i)};return function(o,i){v(o,i);function n(){this.constructor=o}o.prototype=i===null?Object.create(i):(n.prototype=i.prototype,new n)}}();Object.defineProperty(w,"__esModule",{value:!0});var p=O("events"),d=O("./device"),l=O("./errors"),S=O("./log"),g=O("./outputdevicecollection"),b=O("./shims/mediadeviceinfo"),h=O("./shims/mediadevices"),T=O("./util"),u={audioinput:"Audio Input",audiooutput:"Audio Output"},a=function(v){y(o,v);function o(i,n,e,t){var r,s=v.call(this)||this;s.availableInputDevices=new Map,s.availableOutputDevices=new Map,s._audioConstraints=null,s._enabledSounds=(r={},r[d.default.SoundName.Disconnect]=!0,r[d.default.SoundName.Incoming]=!0,r[d.default.SoundName.Outgoing]=!0,r),s._inputDevice=null,s._inputStream=null,s._isPollingInputVolume=!1,s._log=S.default.getInstance(),s._unknownDeviceIndexes={audioinput:{},audiooutput:{}},s._removeLostInput=function(I){if(!s.inputDevice||s.inputDevice.deviceId!==I.deviceId)return!1;s._replaceStream(null),s._inputDevice=null,s._maybeStopPollingVolume();var M=s.availableInputDevices.get("default")||Array.from(s.availableInputDevices.values())[0];return M&&s.setInputDevice(M.deviceId),!0},s._removeLostOutput=function(I){var M=s.speakerDevices.delete(I),R=s.ringtoneDevices.delete(I);return M||R},s._updateAvailableDevices=function(){return!s._mediaDevices||!s._enumerateDevices?Promise.reject("Enumeration not supported"):s._enumerateDevices().then(function(I){s._updateDevices(I.filter(function(R){return R.kind==="audiooutput"}),s.availableOutputDevices,s._removeLostOutput),s._updateDevices(I.filter(function(R){return R.kind==="audioinput"}),s.availableInputDevices,s._removeLostInput);var M=s.availableOutputDevices.get("default")||Array.from(s.availableOutputDevices.values())[0];[s.speakerDevices,s.ringtoneDevices].forEach(function(R){!R.get().size&&s.availableOutputDevices.size&&s.isOutputSelectionSupported&&R.set(M.deviceId).catch(function(x){s._log.warn("Unable to set audio output devices. "+x)})})})},t=Object.assign({AudioContext:typeof AudioContext<"u"&&AudioContext,setSinkId:typeof HTMLAudioElement<"u"&&HTMLAudioElement.prototype.setSinkId},t),s._getUserMedia=e,s._mediaDevices=t.mediaDevices||h.default(),s._onActiveInputChanged=n,s._enumerateDevices=typeof t.enumerateDevices=="function"?t.enumerateDevices:s._mediaDevices&&s._mediaDevices.enumerateDevices;var m=!!(t.AudioContext||t.audioContext),_=!!s._enumerateDevices;t.enabledSounds&&(s._enabledSounds=t.enabledSounds);var E=typeof t.setSinkId=="function";return s.isOutputSelectionSupported=_&&E,s.isVolumeSupported=m,s.isVolumeSupported&&(s._audioContext=t.audioContext||t.AudioContext&&new t.AudioContext,s._audioContext&&(s._inputVolumeAnalyser=s._audioContext.createAnalyser(),s._inputVolumeAnalyser.fftSize=32,s._inputVolumeAnalyser.smoothingTimeConstant=.3)),s.ringtoneDevices=new g.default("ringtone",s.availableOutputDevices,i,s.isOutputSelectionSupported),s.speakerDevices=new g.default("speaker",s.availableOutputDevices,i,s.isOutputSelectionSupported),s.addListener("newListener",function(I){I==="inputVolume"&&s._maybeStartPollingVolume()}),s.addListener("removeListener",function(I){I==="inputVolume"&&s._maybeStopPollingVolume()}),s.once("newListener",function(){s.isOutputSelectionSupported||s._log.warn("Warning: This browser does not support audio output selection."),s.isVolumeSupported||s._log.warn("Warning: This browser does not support Twilio's volume indicator feature.")}),_&&s._initializeEnumeration(),s}return Object.defineProperty(o.prototype,"audioConstraints",{get:function(){return this._audioConstraints},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"inputDevice",{get:function(){return this._inputDevice},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"inputStream",{get:function(){return this._inputStream},enumerable:!1,configurable:!0}),o.prototype._getEnabledSounds=function(){return this._enabledSounds},o.prototype._maybeStartPollingVolume=function(){var i=this;if(!(!this.isVolumeSupported||!this._inputStream)&&(this._updateVolumeSource(),!(this._isPollingInputVolume||!this._inputVolumeAnalyser))){var n=this._inputVolumeAnalyser.frequencyBinCount,e=new Uint8Array(n);this._isPollingInputVolume=!0;var t=function(){if(i._isPollingInputVolume){if(i._inputVolumeAnalyser){i._inputVolumeAnalyser.getByteFrequencyData(e);var r=T.average(e);i.emit("inputVolume",r/255)}requestAnimationFrame(t)}};requestAnimationFrame(t)}},o.prototype._maybeStopPollingVolume=function(){this.isVolumeSupported&&(!this._isPollingInputVolume||this._inputStream&&this.listenerCount("inputVolume")||(this._inputVolumeSource&&(this._inputVolumeSource.disconnect(),delete this._inputVolumeSource),this._isPollingInputVolume=!1))},o.prototype._unbind=function(){if(!this._mediaDevices||!this._enumerateDevices)throw new l.NotSupportedError("Enumeration is not supported");this._mediaDevices.removeEventListener&&(this._mediaDevices.removeEventListener("devicechange",this._updateAvailableDevices),this._mediaDevices.removeEventListener("deviceinfochange",this._updateAvailableDevices))},o.prototype.disconnect=function(i){return this._maybeEnableSound(d.default.SoundName.Disconnect,i)},o.prototype.incoming=function(i){return this._maybeEnableSound(d.default.SoundName.Incoming,i)},o.prototype.outgoing=function(i){return this._maybeEnableSound(d.default.SoundName.Outgoing,i)},o.prototype.setAudioConstraints=function(i){return this._audioConstraints=Object.assign({},i),delete this._audioConstraints.deviceId,this.inputDevice?this._setInputDevice(this.inputDevice.deviceId,!0):Promise.resolve()},o.prototype.setInputDevice=function(i){return T.isFirefox()?Promise.reject(new l.NotSupportedError(`Firefox does not currently support opening multiple audio input tracks simultaneously, even across different tabs. As a result, Device.audio.setInputDevice is disabled on Firefox until support is added.
Related BugZilla thread: https://bugzilla.mozilla.org/show_bug.cgi?id=1299324`)):this._setInputDevice(i,!1)},o.prototype.unsetAudioConstraints=function(){return this._audioConstraints=null,this.inputDevice?this._setInputDevice(this.inputDevice.deviceId,!0):Promise.resolve()},o.prototype.unsetInputDevice=function(){var i=this;return this.inputDevice?this._onActiveInputChanged(null).then(function(){i._replaceStream(null),i._inputDevice=null,i._maybeStopPollingVolume()}):Promise.resolve()},o.prototype._getUnknownDeviceIndex=function(i){var n=i.deviceId,e=i.kind,t=this._unknownDeviceIndexes[e][n];return t||(t=Object.keys(this._unknownDeviceIndexes[e]).length+1,this._unknownDeviceIndexes[e][n]=t),t},o.prototype._initializeEnumeration=function(){var i=this;if(!this._mediaDevices||!this._enumerateDevices)throw new l.NotSupportedError("Enumeration is not supported");this._mediaDevices.addEventListener&&(this._mediaDevices.addEventListener("devicechange",this._updateAvailableDevices),this._mediaDevices.addEventListener("deviceinfochange",this._updateAvailableDevices)),this._updateAvailableDevices().then(function(){i.isOutputSelectionSupported&&Promise.all([i.speakerDevices.set("default"),i.ringtoneDevices.set("default")]).catch(function(n){i._log.warn("Warning: Unable to set audio output devices. "+n)})})},o.prototype._maybeEnableSound=function(i,n){return typeof n<"u"&&(this._enabledSounds[i]=n),this._enabledSounds[i]},o.prototype._replaceStream=function(i){this._inputStream&&this._inputStream.getTracks().forEach(function(n){n.stop()}),this._inputStream=i},o.prototype._setInputDevice=function(i,n){var e=this;if(typeof i!="string")return Promise.reject(new l.InvalidArgumentError("Must specify the device to set"));var t=this.availableInputDevices.get(i);if(!t)return Promise.reject(new l.InvalidArgumentError("Device not found: "+i));if(this._inputDevice&&this._inputDevice.deviceId===i&&this._inputStream){if(!n)return Promise.resolve();this._inputStream.getTracks().forEach(function(s){s.stop()})}var r={audio:Object.assign({deviceId:{exact:i}},this.audioConstraints)};return this._getUserMedia(r).then(function(s){return e._onActiveInputChanged(s).then(function(){e._replaceStream(s),e._inputDevice=t,e._maybeStartPollingVolume()})})},o.prototype._updateDevices=function(i,n,e){var t=this,r=i.map(function(I){return I.deviceId}),s=Array.from(n.values()).map(function(I){return I.deviceId}),m=[],_=T.difference(s,r);_.forEach(function(I){var M=n.get(I);M&&(n.delete(I),e(M)&&m.push(M))});var E=!1;i.forEach(function(I){var M=n.get(I.deviceId),R=t._wrapMediaDeviceInfo(I);(!M||M.label!==R.label)&&(n.set(I.deviceId,R),E=!0)}),(E||_.length)&&(this.inputDevice!==null&&this.inputDevice.deviceId==="default"&&(this._log.warn("Calling getUserMedia after device change to ensure that the           tracks of the active device (default) have not gone stale."),this._setInputDevice(this.inputDevice.deviceId,!0)),this.emit("deviceChange",m))},o.prototype._updateVolumeSource=function(){if(!(!this._inputStream||!this._audioContext||!this._inputVolumeAnalyser)){this._inputVolumeSource&&this._inputVolumeSource.disconnect();try{this._inputVolumeSource=this._audioContext.createMediaStreamSource(this._inputStream),this._inputVolumeSource.connect(this._inputVolumeAnalyser)}catch(i){this._log.warn("Unable to update volume source",i),delete this._inputVolumeSource}}},o.prototype._wrapMediaDeviceInfo=function(i){var n={deviceId:i.deviceId,groupId:i.groupId,kind:i.kind,label:i.label};if(!n.label)if(n.deviceId==="default")n.label="Default";else{var e=this._getUnknownDeviceIndex(i);n.label="Unknown "+u[n.kind]+" Device "+e}return new b.default(n)},o}(p.EventEmitter);a||(a={}),w.default=a},{"./device":11,"./errors":14,"./log":17,"./outputdevicecollection":18,"./shims/mediadeviceinfo":33,"./shims/mediadevices":34,"./util":37,events:40}],4:[function(O,F,w){var y=this&&this.__extends||function(){var h=function(T,u){return h=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(a,v){a.__proto__=v}||function(a,v){for(var o in v)Object.prototype.hasOwnProperty.call(v,o)&&(a[o]=v[o])},h(T,u)};return function(T,u){h(T,u);function a(){this.constructor=T}T.prototype=u===null?Object.create(u):(a.prototype=u.prototype,new a)}}(),p=this&&this.__awaiter||function(h,T,u,a){function v(o){return o instanceof u?o:new u(function(i){i(o)})}return new(u||(u=Promise))(function(o,i){function n(r){try{t(a.next(r))}catch(s){i(s)}}function e(r){try{t(a.throw(r))}catch(s){i(s)}}function t(r){r.done?o(r.value):v(r.value).then(n,e)}t((a=a.apply(h,T||[])).next())})},d=this&&this.__generator||function(h,T){var u={label:0,sent:function(){if(o[0]&1)throw o[1];return o[1]},trys:[],ops:[]},a,v,o,i;return i={next:n(0),throw:n(1),return:n(2)},typeof Symbol=="function"&&(i[Symbol.iterator]=function(){return this}),i;function n(t){return function(r){return e([t,r])}}function e(t){if(a)throw new TypeError("Generator is already executing.");for(;u;)try{if(a=1,v&&(o=t[0]&2?v.return:t[0]?v.throw||((o=v.return)&&o.call(v),0):v.next)&&!(o=o.call(v,t[1])).done)return o;switch(v=0,o&&(t=[t[0]&2,o.value]),t[0]){case 0:case 1:o=t;break;case 4:return u.label++,{value:t[1],done:!1};case 5:u.label++,v=t[1],t=[0];continue;case 7:t=u.ops.pop(),u.trys.pop();continue;default:if(o=u.trys,!(o=o.length>0&&o[o.length-1])&&(t[0]===6||t[0]===2)){u=0;continue}if(t[0]===3&&(!o||t[1]>o[0]&&t[1]<o[3])){u.label=t[1];break}if(t[0]===6&&u.label<o[1]){u.label=o[1],o=t;break}if(o&&u.label<o[2]){u.label=o[2],u.ops.push(t);break}o[2]&&u.ops.pop(),u.trys.pop();continue}t=T.call(h,u)}catch(r){t=[6,r],v=0}finally{a=o=0}if(t[0]&5)throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}};Object.defineProperty(w,"__esModule",{value:!0});var l=O("./deferred"),S=O("./eventtarget"),g=function(h){y(T,h);function T(u,a,v){a===void 0&&(a={}),v===void 0&&(v={});var o=h.call(this)||this;return o._audioNode=null,o._loop=!1,o._pendingPlayDeferreds=[],o._sinkId="default",o._src="",typeof a!="string"&&(v=a),o._audioContext=u,o._audioElement=new(v.AudioFactory||Audio),o._bufferPromise=o._createPlayDeferred().promise,o._destination=o._audioContext.destination,o._gainNode=o._audioContext.createGain(),o._gainNode.connect(o._destination),o._XMLHttpRequest=v.XMLHttpRequestFactory||XMLHttpRequest,o.addEventListener("canplaythrough",function(){o._resolvePlayDeferreds()}),typeof a=="string"&&(o.src=a),o}return Object.defineProperty(T.prototype,"destination",{get:function(){return this._destination},enumerable:!1,configurable:!0}),Object.defineProperty(T.prototype,"loop",{get:function(){return this._loop},set:function(u){var a=this;function v(){a._audioNode.removeEventListener("ended",v),a.pause()}!u&&this.loop&&!this.paused&&this._audioNode.addEventListener("ended",v),this._loop=u},enumerable:!1,configurable:!0}),Object.defineProperty(T.prototype,"muted",{get:function(){return this._gainNode.gain.value===0},set:function(u){this._gainNode.gain.value=u?0:1},enumerable:!1,configurable:!0}),Object.defineProperty(T.prototype,"paused",{get:function(){return this._audioNode===null},enumerable:!1,configurable:!0}),Object.defineProperty(T.prototype,"src",{get:function(){return this._src},set:function(u){this._load(u)},enumerable:!1,configurable:!0}),Object.defineProperty(T.prototype,"srcObject",{get:function(){return this._audioElement.srcObject},set:function(u){this._audioElement.srcObject=u},enumerable:!1,configurable:!0}),Object.defineProperty(T.prototype,"sinkId",{get:function(){return this._sinkId},enumerable:!1,configurable:!0}),T.prototype.load=function(){this._load(this._src)},T.prototype.pause=function(){this.paused||(this._audioElement.pause(),this._audioNode.stop(),this._audioNode.disconnect(this._gainNode),this._audioNode=null,this._rejectPlayDeferreds(new Error("The play() request was interrupted by a call to pause().")))},T.prototype.play=function(){return p(this,void 0,void 0,function(){var u,a=this;return d(this,function(v){switch(v.label){case 0:return this.paused?[3,2]:[4,this._bufferPromise];case 1:if(v.sent(),!this.paused)return[2];throw new Error("The play() request was interrupted by a call to pause().");case 2:return this._audioNode=this._audioContext.createBufferSource(),this._audioNode.loop=this.loop,this._audioNode.addEventListener("ended",function(){a._audioNode&&a._audioNode.loop||a.dispatchEvent("ended")}),[4,this._bufferPromise];case 3:if(u=v.sent(),this.paused)throw new Error("The play() request was interrupted by a call to pause().");return this._audioNode.buffer=u,this._audioNode.connect(this._gainNode),this._audioNode.start(),this._audioElement.srcObject?[2,this._audioElement.play()]:[2]}})})},T.prototype.setSinkId=function(u){return p(this,void 0,void 0,function(){return d(this,function(a){switch(a.label){case 0:if(typeof this._audioElement.setSinkId!="function")throw new Error("This browser does not support setSinkId.");return u===this.sinkId?[2]:u==="default"?(this.paused||this._gainNode.disconnect(this._destination),this._audioElement.srcObject=null,this._destination=this._audioContext.destination,this._gainNode.connect(this._destination),this._sinkId=u,[2]):[4,this._audioElement.setSinkId(u)];case 1:return a.sent(),this._audioElement.srcObject?[2]:(this._gainNode.disconnect(this._audioContext.destination),this._destination=this._audioContext.createMediaStreamDestination(),this._audioElement.srcObject=this._destination.stream,this._sinkId=u,this._gainNode.connect(this._destination),[2])}})})},T.prototype._createPlayDeferred=function(){var u=new l.default;return this._pendingPlayDeferreds.push(u),u},T.prototype._load=function(u){var a=this;this._src&&this._src!==u&&this.pause(),this._src=u,this._bufferPromise=new Promise(function(v,o){return p(a,void 0,void 0,function(){var i;return d(this,function(n){switch(n.label){case 0:return u?[4,b(this._audioContext,this._XMLHttpRequest,u)]:[2,this._createPlayDeferred().promise];case 1:return i=n.sent(),this.dispatchEvent("canplaythrough"),v(i),[2]}})})})},T.prototype._rejectPlayDeferreds=function(u){var a=this._pendingPlayDeferreds;a.splice(0,a.length).forEach(function(v){var o=v.reject;return o(u)})},T.prototype._resolvePlayDeferreds=function(u){var a=this._pendingPlayDeferreds;a.splice(0,a.length).forEach(function(v){var o=v.resolve;return o(u)})},T}(S.default);function b(h,T,u){return p(this,void 0,void 0,function(){var a,v;return d(this,function(o){switch(o.label){case 0:return a=new T,a.open("GET",u,!0),a.responseType="arraybuffer",[4,new Promise(function(i){a.addEventListener("load",i),a.send()})];case 1:v=o.sent();try{return[2,h.decodeAudioData(v.target.response)]}catch{return[2,new Promise(function(n){h.decodeAudioData(v.target.response,n)})]}return[2]}})})}w.default=g},{"./deferred":5,"./eventtarget":6}],5:[function(O,F,w){Object.defineProperty(w,"__esModule",{value:!0});var y=function(){function p(){var d=this;this.promise=new Promise(function(l,S){d._resolve=l,d._reject=S})}return Object.defineProperty(p.prototype,"reject",{get:function(){return this._reject},enumerable:!1,configurable:!0}),Object.defineProperty(p.prototype,"resolve",{get:function(){return this._resolve},enumerable:!1,configurable:!0}),p}();w.default=y},{}],6:[function(O,F,w){var y=this&&this.__spreadArrays||function(){for(var l=0,S=0,g=arguments.length;S<g;S++)l+=arguments[S].length;for(var b=Array(l),h=0,S=0;S<g;S++)for(var T=arguments[S],u=0,a=T.length;u<a;u++,h++)b[h]=T[u];return b};Object.defineProperty(w,"__esModule",{value:!0});var p=O("events"),d=function(){function l(){this._eventEmitter=new p.EventEmitter}return l.prototype.addEventListener=function(S,g){return this._eventEmitter.addListener(S,g)},l.prototype.dispatchEvent=function(S){for(var g,b=[],h=1;h<arguments.length;h++)b[h-1]=arguments[h];return(g=this._eventEmitter).emit.apply(g,y([S],b))},l.prototype.removeEventListener=function(S,g){return this._eventEmitter.removeListener(S,g)},l}();w.default=d},{events:40}],7:[function(O,F,w){var y=this&&this.__extends||function(){var l=function(S,g){return l=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(b,h){b.__proto__=h}||function(b,h){for(var T in h)Object.prototype.hasOwnProperty.call(h,T)&&(b[T]=h[T])},l(S,g)};return function(S,g){l(S,g);function b(){this.constructor=S}S.prototype=g===null?Object.create(g):(b.prototype=g.prototype,new b)}}();Object.defineProperty(w,"__esModule",{value:!0});var p=O("events"),d=function(l){y(S,l);function S(g){var b=l.call(this)||this;return Object.defineProperties(b,{_attempts:{value:0,writable:!0},_duration:{enumerable:!1,get:function(){var h=this._min*Math.pow(this._factor,this._attempts);if(this._jitter){var T=Math.random(),u=Math.floor(T*this._jitter*h);h=Math.floor(T*10)&1?h+u:h-u}return Math.min(h,this._max)|0}},_factor:{value:g.factor||2},_jitter:{value:g.jitter>0&&g.jitter<=1?g.jitter:0},_max:{value:g.max||1e4},_min:{value:g.min||100},_timeoutID:{value:null,writable:!0}}),b}return S.prototype.backoff=function(){var g=this,b=this._duration;this._timeoutID&&(clearTimeout(this._timeoutID),this._timeoutID=null),this.emit("backoff",this._attempts,b),this._timeoutID=setTimeout(function(){g.emit("ready",g._attempts,b),g._attempts++},b)},S.prototype.reset=function(){this._attempts=0,this._timeoutID&&(clearTimeout(this._timeoutID),this._timeoutID=null)},S}(p.EventEmitter);w.default=d},{events:40}],8:[function(O,F,w){var y=this&&this.__extends||function(){var D=function(f,C){return D=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(k,c){k.__proto__=c}||function(k,c){for(var P in c)Object.prototype.hasOwnProperty.call(c,P)&&(k[P]=c[P])},D(f,C)};return function(f,C){D(f,C);function k(){this.constructor=f}f.prototype=C===null?Object.create(C):(k.prototype=C.prototype,new k)}}(),p=this&&this.__assign||function(){return p=Object.assign||function(D){for(var f,C=1,k=arguments.length;C<k;C++){f=arguments[C];for(var c in f)Object.prototype.hasOwnProperty.call(f,c)&&(D[c]=f[c])}return D},p.apply(this,arguments)};Object.defineProperty(w,"__esModule",{value:!0});var d=O("events"),l=O("./backoff"),S=O("./device"),g=O("./errors"),b=O("./log"),h=O("./rtc"),T=O("./rtc/icecandidate"),u=O("./rtc/sdp"),a=O("./statsMonitor"),v=O("./util"),o=O("./uuid"),i=O("./constants"),n={factor:1.1,jitter:.5,max:3e4,min:1},e=70,t=500,r=160,s=10,m=5e3,_={disconnect:!0,info:{code:31003,message:"Connection with Twilio was interrupted.",twilioError:new g.MediaErrors.ConnectionError}},E={packetsLostFraction:{max:"packet-loss",maxAverage:"packets-lost-fraction"}},I={audioInputLevel:"audio-input-level",audioOutputLevel:"audio-output-level",bytesReceived:"bytes-received",bytesSent:"bytes-sent",jitter:"jitter",mos:"mos",rtt:"rtt"},M={max:"high-",maxAverage:"high-",maxDuration:"constant-",min:"low-",minStandardDeviation:"constant-"},R=function(D){y(f,D);function f(C,k){var c=D.call(this)||this;c.parameters={},c._inputVolumeStreak=0,c._isAnswered=!1,c._isCancelled=!1,c._isRejected=!1,c._latestInputVolume=0,c._latestOutputVolume=0,c._log=b.default.getInstance(),c._mediaStatus=f.State.Pending,c._messages=new Map,c._metricsSamples=[],c._options={MediaHandler:h.PeerConnection,offerSdp:null,shouldPlayDisconnect:function(){return!0},voiceEventSidGenerator:o.generateVoiceEventSid},c._outputVolumeStreak=0,c._shouldSendHangup=!0,c._signalingStatus=f.State.Pending,c._soundcache=new Map,c._status=f.State.Pending,c._wasConnected=!1,c.toString=function(){return"[Twilio.Call instance]"},c._emitWarning=function(A,L,j,N,H,G){var V=H?"-cleared":"-raised",W=A+"warning"+V;if(!(L==="constant-audio-input-level"&&c.isMuted())){var z=H?"info":"warning";L==="constant-audio-output-level"&&(z="info");var q={threshold:j};if(N&&(N instanceof Array?q.values=N.map(function(Y){return typeof Y=="number"?Math.round(Y*100)/100:N}):q.value=N),c._publisher.post(z,W,L,{data:q},c),L!=="constant-audio-output-level"){var X=H?"warning-cleared":"warning";c.emit(X,L,G&&!H?G:null)}}},c._onAck=function(A){var L=A.acktype,j=A.callsid,N=A.voiceeventsid;if(c.parameters.CallSid!==j){c._log.warn("Received ack from a different callsid: "+j);return}L==="message"&&c._onMessageSent(N)},c._onAnswer=function(A){typeof A.reconnect=="string"&&(c._signalingReconnectToken=A.reconnect),!(c._isAnswered&&c._status!==f.State.Reconnecting)&&(c._setCallSid(A),c._isAnswered=!0,c._maybeTransitionToOpen())},c._onCancel=function(A){var L=A.callsid;c.parameters.CallSid===L&&(c._isCancelled=!0,c._publisher.info("connection","cancel",null,c),c._cleanupEventListeners(),c._mediaHandler.close(),c._status=f.State.Closed,c.emit("cancel"),c._pstream.removeListener("cancel",c._onCancel))},c._onConnected=function(){c._log.info("Received connected from pstream"),c._signalingReconnectToken&&c._pstream.reconnect(c._mediaHandler.version.getSDP(),c.parameters.CallSid,c._signalingReconnectToken)},c._onHangup=function(A){if(c.status()!==f.State.Closed){if(A.callsid&&(c.parameters.CallSid||c.outboundConnectionId)){if(A.callsid!==c.parameters.CallSid&&A.callsid!==c.outboundConnectionId)return}else if(A.callsid)return;if(c._log.info("Received HANGUP from gateway"),A.error){var L=new g.GeneralErrors.ConnectionError("Error sent from gateway in HANGUP");c._log.error("Received an error from the gateway:",L),c.emit("error",L)}c._shouldSendHangup=!1,c._publisher.info("connection","disconnected-by-remote",null,c),c._disconnect(null,!0),c._cleanupEventListeners()}},c._onMediaFailure=function(A){var L=f.MediaFailure,j=L.ConnectionDisconnected,N=L.ConnectionFailed,H=L.IceGatheringFailed,G=L.LowBytes,V=A===N||A===H;if(!v.isChrome(window,window.navigator)&&A===N)return c._mediaHandler.onerror(_);if(c._mediaStatus===f.State.Reconnecting){if(V){if(Date.now()-c._mediaReconnectStartTime>n.max)return c._log.info("Exceeded max ICE retries"),c._mediaHandler.onerror(_);try{c._mediaReconnectBackoff.backoff()}catch(Y){if(!(Y.message&&Y.message==="Backoff in progress."))throw Y}}return}var W=c._mediaHandler.version.pc,z=W&&W.iceConnectionState==="disconnected",q=c._monitor.hasActiveWarning("bytesSent","min")||c._monitor.hasActiveWarning("bytesReceived","min");if(A===G&&z||A===j&&q||V){var X=new g.MediaErrors.ConnectionError("Media connection failed.");c._log.warn("ICE Connection disconnected."),c._publisher.warn("connection","error",X,c),c._publisher.info("connection","reconnecting",null,c),c._mediaReconnectStartTime=Date.now(),c._status=f.State.Reconnecting,c._mediaStatus=f.State.Reconnecting,c._mediaReconnectBackoff.reset(),c._mediaReconnectBackoff.backoff(),c.emit("reconnecting",X)}},c._onMediaReconnected=function(){c._mediaStatus===f.State.Reconnecting&&(c._log.info("ICE Connection reestablished."),c._mediaStatus=f.State.Open,c._signalingStatus===f.State.Open&&(c._publisher.info("connection","reconnected",null,c),c.emit("reconnected"),c._status=f.State.Open))},c._onMessageReceived=function(A){var L=A.callsid,j=A.content,N=A.contenttype,H=A.messagetype,G=A.voiceeventsid;if(c.parameters.CallSid!==L){c._log.warn("Received a message from a different callsid: "+L);return}c.emit("messageReceived",{content:j,contentType:N,messageType:H,voiceEventSid:G})},c._onMessageSent=function(A){if(!c._messages.has(A)){c._log.warn("Received a messageSent with a voiceEventSid that doesn't exists: "+A);return}var L=c._messages.get(A);c._messages.delete(A),c.emit("messageSent",L)},c._onRinging=function(A){if(c._setCallSid(A),!(c._status!==f.State.Connecting&&c._status!==f.State.Ringing)){var L=!!A.sdp;c._status=f.State.Ringing,c._publisher.info("connection","outgoing-ringing",{hasEarlyMedia:L},c),c.emit("ringing",L)}},c._onRTCSample=function(A){var L=p(p({},A),{inputVolume:c._latestInputVolume,outputVolume:c._latestOutputVolume});c._codec=L.codecName,c._metricsSamples.push(L),c._metricsSamples.length>=s&&c._publishMetrics(),c.emit("sample",A)},c._onSignalingError=function(A){var L=A.callsid,j=A.voiceeventsid;if(c.parameters.CallSid!==L){c._log.warn("Received an error from a different callsid: "+L);return}j&&c._messages.has(j)&&(c._messages.delete(j),c._log.warn("Received an error while sending a message.",A))},c._onSignalingReconnected=function(){c._signalingStatus===f.State.Reconnecting&&(c._log.info("Signaling Connection reestablished."),c._signalingStatus=f.State.Open,c._mediaStatus===f.State.Open&&(c._publisher.info("connection","reconnected",null,c),c.emit("reconnected"),c._status=f.State.Open))},c._onTransportClose=function(){c._log.error("Received transportClose from pstream"),c.emit("transportClose"),c._signalingReconnectToken?(c._status=f.State.Reconnecting,c._signalingStatus=f.State.Reconnecting,c.emit("reconnecting",new g.SignalingErrors.ConnectionDisconnected)):(c._status=f.State.Closed,c._signalingStatus=f.State.Closed)},c._reemitWarning=function(A,L){var j=/^audio/.test(A.name)?"audio-level-":"network-quality-",N=M[A.threshold.name],H;A.name in E?H=E[A.name][A.threshold.name]:A.name in I&&(H=I[A.name]);var G=N+H;c._emitWarning(j,G,A.threshold.value,A.values||A.value,L,A)},c._reemitWarningCleared=function(A){c._reemitWarning(A,!0)},c._isUnifiedPlanDefault=C.isUnifiedPlanDefault,c._soundcache=C.soundcache,typeof C.onIgnore=="function"&&(c._onIgnore=C.onIgnore);var P=k&&k.twimlParams||{};c.customParameters=new Map(Object.entries(P).map(function(A){var L=A[0],j=A[1];return[L,String(j)]})),Object.assign(c._options,k),c._options.callParameters&&(c.parameters=c._options.callParameters),c._options.reconnectToken&&(c._signalingReconnectToken=c._options.reconnectToken),c._voiceEventSidGenerator=c._options.voiceEventSidGenerator||o.generateVoiceEventSid,c._direction=c.parameters.CallSid?f.CallDirection.Incoming:f.CallDirection.Outgoing,c._direction===f.CallDirection.Incoming&&c.parameters?c.callerInfo=c.parameters.StirStatus?{isVerified:c.parameters.StirStatus==="TN-Validation-Passed-A"}:null:c.callerInfo=null,c._mediaReconnectBackoff=new l.default(n),c._mediaReconnectBackoff.on("ready",function(){return c._mediaHandler.iceRestart()}),c.outboundConnectionId=x();var U=c._publisher=C.publisher;c._direction===f.CallDirection.Incoming?U.info("connection","incoming",null,c):U.info("connection","outgoing",{preflight:c._options.preflight},c);var B=c._monitor=new(c._options.StatsMonitor||a.default);return B.on("sample",c._onRTCSample),B.disableWarnings(),setTimeout(function(){return B.enableWarnings()},m),B.on("warning",function(A,L){(A.name==="bytesSent"||A.name==="bytesReceived")&&c._onMediaFailure(f.MediaFailure.LowBytes),c._reemitWarning(A,L)}),B.on("warning-cleared",function(A){c._reemitWarningCleared(A)}),c._mediaHandler=new c._options.MediaHandler(C.audioHelper,C.pstream,C.getUserMedia,{RTCPeerConnection:c._options.RTCPeerConnection,codecPreferences:c._options.codecPreferences,dscp:c._options.dscp,forceAggressiveIceNomination:c._options.forceAggressiveIceNomination,isUnifiedPlan:c._isUnifiedPlanDefault,maxAverageBitrate:c._options.maxAverageBitrate,preflight:c._options.preflight}),c.on("volume",function(A,L){c._inputVolumeStreak=c._checkVolume(A,c._inputVolumeStreak,c._latestInputVolume,"input"),c._outputVolumeStreak=c._checkVolume(L,c._outputVolumeStreak,c._latestOutputVolume,"output"),c._latestInputVolume=A,c._latestOutputVolume=L}),c._mediaHandler.onaudio=function(A){c._log.info("Remote audio created"),c.emit("audio",A)},c._mediaHandler.onvolume=function(A,L,j,N){B.addVolumes(j/255*32767,N/255*32767),c.emit("volume",A,L)},c._mediaHandler.ondtlstransportstatechange=function(A){var L=A==="failed"?"error":"debug";c._publisher.post(L,"dtls-transport-state",A,null,c)},c._mediaHandler.onpcconnectionstatechange=function(A){var L="debug",j=c._mediaHandler.getRTCDtlsTransport();A==="failed"&&(L=j&&j.state==="failed"?"error":"warning"),c._publisher.post(L,"pc-connection-state",A,null,c)},c._mediaHandler.onicecandidate=function(A){var L=new T.IceCandidate(A).toPayload();c._publisher.debug("ice-candidate","ice-candidate",L,c)},c._mediaHandler.onselectedcandidatepairchange=function(A){var L=new T.IceCandidate(A.local).toPayload(),j=new T.IceCandidate(A.remote,!0).toPayload();c._publisher.debug("ice-candidate","selected-ice-candidate-pair",{local_candidate:L,remote_candidate:j},c)},c._mediaHandler.oniceconnectionstatechange=function(A){var L=A==="failed"?"error":"debug";c._publisher.post(L,"ice-connection-state",A,null,c)},c._mediaHandler.onicegatheringfailure=function(A){c._publisher.warn("ice-gathering-state",A,null,c),c._onMediaFailure(f.MediaFailure.IceGatheringFailed)},c._mediaHandler.onicegatheringstatechange=function(A){c._publisher.debug("ice-gathering-state",A,null,c)},c._mediaHandler.onsignalingstatechange=function(A){c._publisher.debug("signaling-state",A,null,c)},c._mediaHandler.ondisconnected=function(A){c._log.info(A),c._publisher.warn("network-quality-warning-raised","ice-connectivity-lost",{message:A},c),c.emit("warning","ice-connectivity-lost"),c._onMediaFailure(f.MediaFailure.ConnectionDisconnected)},c._mediaHandler.onfailed=function(A){c._onMediaFailure(f.MediaFailure.ConnectionFailed)},c._mediaHandler.onconnected=function(){c._status===f.State.Reconnecting&&c._onMediaReconnected()},c._mediaHandler.onreconnected=function(A){c._log.info(A),c._publisher.info("network-quality-warning-cleared","ice-connectivity-lost",{message:A},c),c.emit("warning-cleared","ice-connectivity-lost"),c._onMediaReconnected()},c._mediaHandler.onerror=function(A){A.disconnect===!0&&c._disconnect(A.info&&A.info.message);var L=A.info.twilioError||new g.GeneralErrors.UnknownError(A.info.message);c._log.error("Received an error from MediaStream:",A),c.emit("error",L)},c._mediaHandler.onopen=function(){c._status===f.State.Open||c._status===f.State.Reconnecting||(c._status===f.State.Ringing||c._status===f.State.Connecting?(c.mute(!1),c._mediaStatus=f.State.Open,c._maybeTransitionToOpen()):c._mediaHandler.close())},c._mediaHandler.onclose=function(){c._status=f.State.Closed,c._options.shouldPlayDisconnect&&c._options.shouldPlayDisconnect()&&!c._isCancelled&&!c._isRejected&&c._soundcache.get(S.default.SoundName.Disconnect).play(),B.disable(),c._publishMetrics(),!c._isCancelled&&!c._isRejected&&c.emit("disconnect",c)},c._pstream=C.pstream,c._pstream.on("ack",c._onAck),c._pstream.on("cancel",c._onCancel),c._pstream.on("error",c._onSignalingError),c._pstream.on("ringing",c._onRinging),c._pstream.on("transportClose",c._onTransportClose),c._pstream.on("connected",c._onConnected),c._pstream.on("message",c._onMessageReceived),c.on("error",function(A){c._publisher.error("connection","error",{code:A.code,message:A.message},c),c._pstream&&c._pstream.status==="disconnected"&&c._cleanupEventListeners()}),c.on("disconnect",function(){c._cleanupEventListeners()}),c}return Object.defineProperty(f.prototype,"direction",{get:function(){return this._direction},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"codec",{get:function(){return this._codec},enumerable:!1,configurable:!0}),f.prototype._setInputTracksFromStream=function(C){return this._mediaHandler.setInputTracksFromStream(C)},f.prototype._setSinkIds=function(C){return this._mediaHandler._setSinkIds(C)},f.prototype.accept=function(C){var k=this;if(this._status===f.State.Pending){C=C||{};var c=C.rtcConfiguration||this._options.rtcConfiguration,P=C.rtcConstraints||this._options.rtcConstraints||{},U=P.audio||{audio:!0};this._status=f.State.Connecting;var B=function(){if(k._status!==f.State.Connecting){k._cleanupEventListeners(),k._mediaHandler.close();return}var j=function(G,V){var W=k._direction===f.CallDirection.Incoming?"accepted-by-local":"accepted-by-remote";k._publisher.info("connection",W,null,k),typeof V=="string"&&(k._signalingReconnectToken=V);var z=u.getPreferredCodecInfo(k._mediaHandler.version.getSDP()),q=z.codecName,X=z.codecParams;k._publisher.info("settings","codec",{codec_params:X,selected_codec:q},k),k._monitor.enable(G)},N=typeof k._options.getSinkIds=="function"&&k._options.getSinkIds();if(Array.isArray(N)&&k._mediaHandler._setSinkIds(N).catch(function(){}),k._pstream.addListener("hangup",k._onHangup),k._direction===f.CallDirection.Incoming)k._isAnswered=!0,k._pstream.on("answer",k._onAnswer),k._mediaHandler.answerIncomingCall(k.parameters.CallSid,k._options.offerSdp,P,c,j);else{var H=Array.from(k.customParameters.entries()).map(function(G){return encodeURIComponent(G[0])+"="+encodeURIComponent(G[1])}).join("&");k._pstream.on("answer",k._onAnswer),k._mediaHandler.makeOutgoingCall(k._pstream.token,H,k.outboundConnectionId,P,c,j)}};this._options.beforeAccept&&this._options.beforeAccept(this);var A=typeof this._options.getInputStream=="function"&&this._options.getInputStream(),L=A?this._mediaHandler.setInputTracksFromStream(A):this._mediaHandler.openWithConstraints(U);L.then(function(){k._publisher.info("get-user-media","succeeded",{data:{audioConstraints:U}},k),B()},function(j){var N;j.code===31208||["PermissionDeniedError","NotAllowedError"].indexOf(j.name)!==-1?(N=new g.UserMediaErrors.PermissionDeniedError,k._publisher.error("get-user-media","denied",{data:{audioConstraints:U,error:j}},k)):(N=new g.UserMediaErrors.AcquisitionFailedError,k._publisher.error("get-user-media","failed",{data:{audioConstraints:U,error:j}},k)),k._disconnect(),k.emit("error",N)})}},f.prototype.disconnect=function(){this._disconnect()},f.prototype.getLocalStream=function(){return this._mediaHandler&&this._mediaHandler.stream},f.prototype.getRemoteStream=function(){return this._mediaHandler&&this._mediaHandler._remoteStream},f.prototype.ignore=function(){this._status===f.State.Pending&&(this._status=f.State.Closed,this._mediaHandler.ignore(this.parameters.CallSid),this._publisher.info("connection","ignored-by-local",null,this),this._onIgnore&&this._onIgnore())},f.prototype.isMuted=function(){return this._mediaHandler.isMuted},f.prototype.mute=function(C){C===void 0&&(C=!0);var k=this._mediaHandler.isMuted;this._mediaHandler.mute(C);var c=this._mediaHandler.isMuted;k!==c&&(this._publisher.info("connection",c?"muted":"unmuted",null,this),this.emit("mute",c,this))},f.prototype.postFeedback=function(C,k){if(typeof C>"u"||C===null)return this._postFeedbackDeclined();if(!Object.values(f.FeedbackScore).includes(C))throw new g.InvalidArgumentError("Feedback score must be one of: "+Object.values(f.FeedbackScore));if(typeof k<"u"&&k!==null&&!Object.values(f.FeedbackIssue).includes(k))throw new g.InvalidArgumentError("Feedback issue must be one of: "+Object.values(f.FeedbackIssue));return this._publisher.info("feedback","received",{issue_name:k,quality_score:C},this,!0)},f.prototype.reject=function(){this._status===f.State.Pending&&(this._isRejected=!0,this._pstream.reject(this.parameters.CallSid),this._mediaHandler.reject(this.parameters.CallSid),this._publisher.info("connection","rejected-by-local",null,this),this._cleanupEventListeners(),this._mediaHandler.close(),this._status=f.State.Closed,this.emit("reject"))},f.prototype.sendDigits=function(C){var k=this;if(C.match(/[^0-9*#w]/))throw new g.InvalidArgumentError("Illegal character passed into sendDigits");var c=this._options.customSounds||{},P=[];C.split("").forEach(function(j){var N=j!=="w"?"dtmf"+j:"";N==="dtmf*"&&(N="dtmfs"),N==="dtmf#"&&(N="dtmfh"),P.push(N)});var U=function(){var j=P.shift();j&&(k._options.dialtonePlayer&&!c[j]?k._options.dialtonePlayer.play(j):k._soundcache.get(j).play()),P.length&&setTimeout(function(){return U()},200)};U();var B=this._mediaHandler.getOrCreateDTMFSender();function A(j){if(j.length){var N=j.shift();N&&N.length&&B.insertDTMF(N,r,e),setTimeout(A.bind(null,j),t)}}if(B){if(!("canInsertDTMF"in B)||B.canInsertDTMF){this._log.info("Sending digits using RTCDTMFSender"),A(C.split("w"));return}this._log.info("RTCDTMFSender cannot insert DTMF")}if(this._log.info("Sending digits over PStream"),this._pstream!==null&&this._pstream.status!=="disconnected")this._pstream.dtmf(this.parameters.CallSid,C);else{var L=new g.GeneralErrors.ConnectionError("Could not send DTMF: Signaling channel is disconnected");this.emit("error",L)}},f.prototype.sendMessage=function(C){var k=C.content,c=C.contentType,P=C.messageType;if(typeof k>"u"||k===null)throw new g.InvalidArgumentError("`content` is empty");if(typeof P!="string")throw new g.InvalidArgumentError("`messageType` must be an enumeration value of `Call.MessageType` or a string.");if(P.length===0)throw new g.InvalidArgumentError("`messageType` must be a non-empty string.");if(this._pstream===null)throw new g.InvalidStateError("Could not send CallMessage; Signaling channel is disconnected");var U=this.parameters.CallSid;if(typeof this.parameters.CallSid>"u")throw new g.InvalidStateError("Could not send CallMessage; Call has no CallSid");var B=this._voiceEventSidGenerator();return this._messages.set(B,{content:k,contentType:c,messageType:P,voiceEventSid:B}),this._pstream.sendMessage(U,k,c,P,B),B},f.prototype.status=function(){return this._status},f.prototype._checkVolume=function(C,k,c,P){var U=k>=10,B=0;return c===C&&(B=k),B>=10?this._emitWarning("audio-level-","constant-audio-"+P+"-level",10,B,!1):U&&this._emitWarning("audio-level-","constant-audio-"+P+"-level",10,B,!0),B},f.prototype._cleanupEventListeners=function(){var C=this,k=function(){C._pstream&&(C._pstream.removeListener("ack",C._onAck),C._pstream.removeListener("answer",C._onAnswer),C._pstream.removeListener("cancel",C._onCancel),C._pstream.removeListener("error",C._onSignalingError),C._pstream.removeListener("hangup",C._onHangup),C._pstream.removeListener("ringing",C._onRinging),C._pstream.removeListener("transportClose",C._onTransportClose),C._pstream.removeListener("connected",C._onConnected),C._pstream.removeListener("message",C._onMessageReceived))};k(),setTimeout(k,0)},f.prototype._createMetricPayload=function(){var C={call_sid:this.parameters.CallSid,dscp:!!this._options.dscp,sdk_version:i.RELEASE_VERSION};return this._options.gateway&&(C.gateway=this._options.gateway),C.direction=this._direction,C},f.prototype._disconnect=function(C,k){if(C=typeof C=="string"?C:null,!(this._status!==f.State.Open&&this._status!==f.State.Connecting&&this._status!==f.State.Reconnecting&&this._status!==f.State.Ringing)){if(this._log.info("Disconnecting..."),this._pstream!==null&&this._pstream.status!=="disconnected"&&this._shouldSendHangup){var c=this.parameters.CallSid||this.outboundConnectionId;c&&this._pstream.hangup(c,C)}this._cleanupEventListeners(),this._mediaHandler.close(),k||this._publisher.info("connection","disconnected-by-local",null,this)}},f.prototype._maybeTransitionToOpen=function(){this._wasConnected,this._isAnswered&&(this._onSignalingReconnected(),this._signalingStatus=f.State.Open,this._mediaHandler&&this._mediaHandler.status==="open"&&(this._status=f.State.Open,this._wasConnected||(this._wasConnected=!0,this.emit("accept",this))))},f.prototype._postFeedbackDeclined=function(){return this._publisher.info("feedback","received-none",null,this,!0)},f.prototype._publishMetrics=function(){var C=this;this._metricsSamples.length!==0&&this._publisher.postMetrics("quality-metrics-samples","metrics-sample",this._metricsSamples.splice(0),this._createMetricPayload(),this).catch(function(k){C._log.warn("Unable to post metrics to Insights. Received error:",k)})},f.prototype._setCallSid=function(C){var k=C.callsid;k&&(this.parameters.CallSid=k,this._mediaHandler.callSid=k)},f.toString=function(){return"[Twilio.Call class]"},f}(d.EventEmitter);(function(D){(function(f){f.Closed="closed",f.Connecting="connecting",f.Open="open",f.Pending="pending",f.Reconnecting="reconnecting",f.Ringing="ringing"})(D.State||(D.State={})),function(f){f.AudioLatency="audio-latency",f.ChoppyAudio="choppy-audio",f.DroppedCall="dropped-call",f.Echo="echo",f.NoisyCall="noisy-call",f.OneWayAudio="one-way-audio"}(D.FeedbackIssue||(D.FeedbackIssue={})),function(f){f[f.One=1]="One",f[f.Two=2]="Two",f[f.Three=3]="Three",f[f.Four=4]="Four",f[f.Five=5]="Five"}(D.FeedbackScore||(D.FeedbackScore={})),function(f){f.Incoming="INCOMING",f.Outgoing="OUTGOING"}(D.CallDirection||(D.CallDirection={})),function(f){f.Opus="opus",f.PCMU="pcmu"}(D.Codec||(D.Codec={})),function(f){f.None="none",f.Timeout="timeout"}(D.IceGatheringFailureReason||(D.IceGatheringFailureReason={})),function(f){f.ConnectionDisconnected="ConnectionDisconnected",f.ConnectionFailed="ConnectionFailed",f.IceGatheringFailed="IceGatheringFailed",f.LowBytes="LowBytes"}(D.MediaFailure||(D.MediaFailure={})),function(f){f.UserDefinedMessage="user-defined-message"}(D.MessageType||(D.MessageType={}))})(R||(R={}));function x(){return"TJSxxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(D){var f=Math.random()*16|0,C=D==="x"?f:f&3|8;return C.toString(16)})}w.default=R},{"./backoff":7,"./constants":9,"./device":11,"./errors":14,"./log":17,"./rtc":25,"./rtc/icecandidate":24,"./rtc/sdp":30,"./statsMonitor":36,"./util":37,"./uuid":38,events:40}],9:[function(O,F,w){Object.defineProperty(w,"__esModule",{value:!0}),w.SOUNDS_BASE_URL=w.RELEASE_VERSION=w.PACKAGE_NAME=w.ECHO_TEST_DURATION=w.COWBELL_AUDIO_URL=void 0;var y="@twilio/voice-sdk";w.PACKAGE_NAME=y;var p="2.6.1";w.RELEASE_VERSION=p;var d="https://sdk.twilio.com/js/client/sounds/releases/1.0.0";w.SOUNDS_BASE_URL=d;var l=d+"/cowbell.mp3?cache="+p;w.COWBELL_AUDIO_URL=l;var S=2e4;w.ECHO_TEST_DURATION=S},{}],10:[function(O,F,w){Object.defineProperty(w,"__esModule",{value:!0});var y=function(){function p(){var d=this;this._promise=new Promise(function(l,S){d._resolve=l,d._reject=S})}return Object.defineProperty(p.prototype,"promise",{get:function(){return this._promise},enumerable:!1,configurable:!0}),p.prototype.reject=function(d){this._reject(d)},p.prototype.resolve=function(d){this._resolve(d)},p}();w.default=y},{}],11:[function(O,F,w){var y=this&&this.__extends||function(){var D=function(f,C){return D=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(k,c){k.__proto__=c}||function(k,c){for(var P in c)Object.prototype.hasOwnProperty.call(c,P)&&(k[P]=c[P])},D(f,C)};return function(f,C){D(f,C);function k(){this.constructor=f}f.prototype=C===null?Object.create(C):(k.prototype=C.prototype,new k)}}(),p=this&&this.__assign||function(){return p=Object.assign||function(D){for(var f,C=1,k=arguments.length;C<k;C++){f=arguments[C];for(var c in f)Object.prototype.hasOwnProperty.call(f,c)&&(D[c]=f[c])}return D},p.apply(this,arguments)},d=this&&this.__awaiter||function(D,f,C,k){function c(P){return P instanceof C?P:new C(function(U){U(P)})}return new(C||(C=Promise))(function(P,U){function B(j){try{L(k.next(j))}catch(N){U(N)}}function A(j){try{L(k.throw(j))}catch(N){U(N)}}function L(j){j.done?P(j.value):c(j.value).then(B,A)}L((k=k.apply(D,f||[])).next())})},l=this&&this.__generator||function(D,f){var C={label:0,sent:function(){if(P[0]&1)throw P[1];return P[1]},trys:[],ops:[]},k,c,P,U;return U={next:B(0),throw:B(1),return:B(2)},typeof Symbol=="function"&&(U[Symbol.iterator]=function(){return this}),U;function B(L){return function(j){return A([L,j])}}function A(L){if(k)throw new TypeError("Generator is already executing.");for(;C;)try{if(k=1,c&&(P=L[0]&2?c.return:L[0]?c.throw||((P=c.return)&&P.call(c),0):c.next)&&!(P=P.call(c,L[1])).done)return P;switch(c=0,P&&(L=[L[0]&2,P.value]),L[0]){case 0:case 1:P=L;break;case 4:return C.label++,{value:L[1],done:!1};case 5:C.label++,c=L[1],L=[0];continue;case 7:L=C.ops.pop(),C.trys.pop();continue;default:if(P=C.trys,!(P=P.length>0&&P[P.length-1])&&(L[0]===6||L[0]===2)){C=0;continue}if(L[0]===3&&(!P||L[1]>P[0]&&L[1]<P[3])){C.label=L[1];break}if(L[0]===6&&C.label<P[1]){C.label=P[1],P=L;break}if(P&&C.label<P[2]){C.label=P[2],C.ops.push(L);break}P[2]&&C.ops.pop(),C.trys.pop();continue}L=f.call(D,C)}catch(j){L=[6,j],c=0}finally{k=P=0}if(L[0]&5)throw L[1];return{value:L[0]?L[1]:void 0,done:!0}}};Object.defineProperty(w,"__esModule",{value:!0});var S=O("events"),g=O("loglevel"),b=O("./audiohelper"),h=O("./call"),T=O("./constants"),u=O("./dialtonePlayer"),a=O("./errors"),v=O("./eventpublisher"),o=O("./log"),i=O("./preflight/preflight"),n=O("./pstream"),e=O("./regions"),t=O("./rtc"),r=O("./rtc/getusermedia"),s=O("./sound"),m=O("./util"),_=O("./uuid"),E=3e4,I=2e3,M="twilio-js-sdk",R='Parameter "token" must be of type "string".',x=function(D){y(f,D);function f(C,k){var c;k===void 0&&(k={});var P=D.call(this)||this;if(P._activeCall=null,P._audio=null,P._callInputStream=null,P._calls=[],P._callSinkIds=["default"],P._chunderURIs=[],P._defaultOptions={allowIncomingWhileBusy:!1,closeProtection:!1,codecPreferences:[h.default.Codec.PCMU,h.default.Codec.Opus],dscp:!0,forceAggressiveIceNomination:!1,logLevel:g.levels.ERROR,maxCallSignalingTimeoutMs:0,preflight:!1,sounds:{},tokenRefreshMs:1e4,voiceEventSidGenerator:_.generateVoiceEventSid},P._edge=null,P._home=null,P._identity=null,P._log=o.default.getInstance(),P._options={},P._preferredURI=null,P._publisher=null,P._region=null,P._regTimer=null,P._shouldReRegister=!1,P._soundcache=new Map,P._state=f.State.Unregistered,P._stateEventMapping=(c={},c[f.State.Destroyed]=f.EventName.Destroyed,c[f.State.Unregistered]=f.EventName.Unregistered,c[f.State.Registering]=f.EventName.Registering,c[f.State.Registered]=f.EventName.Registered,c),P._stream=null,P._streamConnectedPromise=null,P._tokenWillExpireTimeout=null,P._createDefaultPayload=function(L){var j={aggressive_nomination:P._options.forceAggressiveIceNomination,browser_extension:P._isBrowserExtension,dscp:!!P._options.dscp,ice_restart_enabled:!0,platform:t.getMediaEngine(),sdk_version:T.RELEASE_VERSION};function N(G,V){V&&(j[G]=V)}if(L){var H=L.parameters.CallSid;N("call_sid",/^TJ/.test(H)?void 0:H),N("temp_call_sid",L.outboundConnectionId),N("audio_codec",L.codec),j.direction=L.direction}return N("gateway",P._stream&&P._stream.gateway),N("region",P._stream&&P._stream.region),j},P._onSignalingClose=function(){P._stream=null,P._streamConnectedPromise=null},P._onSignalingConnected=function(L){var j,N=e.getRegionShortcode(L.region);if(P._edge=L.edge||e.regionToEdge[N]||L.region,P._region=N||L.region,P._home=L.home,(j=P._publisher)===null||j===void 0||j.setHost(e.createEventGatewayURI(L.home)),L.token&&(P._identity=L.token.identity,typeof L.token.ttl=="number"&&typeof P._options.tokenRefreshMs=="number")){var H=L.token.ttl*1e3,G=Math.max(0,H-P._options.tokenRefreshMs);P._tokenWillExpireTimeout=setTimeout(function(){P.emit("tokenWillExpire",P),P._tokenWillExpireTimeout&&(clearTimeout(P._tokenWillExpireTimeout),P._tokenWillExpireTimeout=null)},G)}var V=e.getChunderURIs(P._edge);if(V.length>0){var W=V[0];P._preferredURI=e.createSignalingEndpointURL(W)}else P._log.info("Could not parse a preferred URI from the stream#connected event.");P._shouldReRegister&&P.register()},P._onSignalingError=function(L){if(typeof L=="object"){var j=L.error,N=L.callsid;if(typeof j=="object"){var H=typeof N=="string"&&P._findCall(N)||void 0,G=j.code,V=j.message,W=j.twilioError;typeof G=="number"&&(G===31201?W=new a.AuthorizationErrors.AuthenticationFailed(j):G===31204?W=new a.AuthorizationErrors.AccessTokenInvalid(j):G===31205?(P._stopRegistrationTimer(),W=new a.AuthorizationErrors.AccessTokenExpired(j)):a.hasErrorByCode(G)&&(W=new(a.getErrorByCode(G))(j))),W||(P._log.error("Unknown signaling error: ",j),W=new a.GeneralErrors.UnknownError(V,j)),P._log.info("Received error: ",W),P.emit(f.EventName.Error,W,H)}}},P._onSignalingInvite=function(L){return d(P,void 0,void 0,function(){var j,N,H,G,V,W=this,z;return l(this,function(q){switch(q.label){case 0:return j=!!this._activeCall,j&&!this._options.allowIncomingWhileBusy?(this._log.info("Device busy; ignoring incoming invite"),[2]):!L.callsid||!L.sdp?(this.emit(f.EventName.Error,new a.ClientErrors.BadRequest("Malformed invite from gateway")),[2]):(N=L.parameters||{},N.CallSid=N.CallSid||L.callsid,H=Object.assign({},m.queryToJson(N.Params)),[4,this._makeCall(H,{callParameters:N,offerSdp:L.sdp,reconnectToken:L.reconnect,voiceEventSidGenerator:this._options.voiceEventSidGenerator})]);case 1:return G=q.sent(),this._calls.push(G),G.once("accept",function(){W._soundcache.get(f.SoundName.Incoming).stop(),W._publishNetworkChange()}),V=!((z=this._audio)===null||z===void 0)&&z.incoming()&&!j?function(){return W._soundcache.get(f.SoundName.Incoming).play()}:function(){return Promise.resolve()},this._showIncomingCall(G,V),[2]}})})},P._onSignalingOffline=function(){P._log.info("Stream is offline"),P._edge=null,P._region=null,P._shouldReRegister=P.state!==f.State.Unregistered,P._setState(f.State.Unregistered)},P._onSignalingReady=function(){P._log.info("Stream is ready"),P._setState(f.State.Registered)},P._publishNetworkChange=function(){P._activeCall&&P._networkInformation&&P._publisher.info("network-information","network-change",{connection_type:P._networkInformation.type,downlink:P._networkInformation.downlink,downlinkMax:P._networkInformation.downlinkMax,effective_type:P._networkInformation.effectiveType,rtt:P._networkInformation.rtt},P._activeCall)},P._updateInputStream=function(L){var j=P._activeCall;return j&&!L?Promise.reject(new a.InvalidStateError("Cannot unset input device while a call is in progress.")):(P._callInputStream=L,j?j._setInputTracksFromStream(L):Promise.resolve())},P._updateSinkIds=function(L,j){var N=L==="ringtone"?P._updateRingtoneSinkIds(j):P._updateSpeakerSinkIds(j);return N.then(function(){P._publisher.info("audio",L+"-devices-set",{audio_device_ids:j},P._activeCall)},function(H){throw P._publisher.error("audio",L+"-devices-set-failed",{audio_device_ids:j,message:H.message},P._activeCall),H})},P.updateToken(C),m.isLegacyEdge())throw new a.NotSupportedError("Microsoft Edge Legacy (https://support.microsoft.com/en-us/help/4533505/what-is-microsoft-edge-legacy) is deprecated and will not be able to connect to Twilio to make or receive calls after September 1st, 2020. Please see this documentation for a list of supported browsers https://www.twilio.com/docs/voice/client/javascript#supported-browsers");if(!f.isSupported&&k.ignoreBrowserSupport)throw window&&window.location&&window.location.protocol==="http:"?new a.NotSupportedError("twilio.js wasn't able to find WebRTC browser support.           This is most likely because this page is served over http rather than https,           which does not support WebRTC in many browsers. Please load this page over https and           try again."):new a.NotSupportedError("twilio.js 1.3+ SDKs require WebRTC browser support.         For more information, see <https://www.twilio.com/docs/api/client/twilio-js>.         If you have any questions about this announcement, please contact         Twilio Support at <help@twilio.com>.");if(window){var U=window,B=U.msBrowser||U.browser||U.chrome;P._isBrowserExtension=!!B&&!!B.runtime&&!!B.runtime.id||!!U.safari&&!!U.safari.extension}if(P._isBrowserExtension&&P._log.info("Running as browser extension."),navigator){var A=navigator;P._networkInformation=A.connection||A.mozConnection||A.webkitConnection}return P._networkInformation&&typeof P._networkInformation.addEventListener=="function"&&P._networkInformation.addEventListener("change",P._publishNetworkChange),f._getOrCreateAudioContext(),f._audioContext&&(f._dialtonePlayer||(f._dialtonePlayer=new u.default(f._audioContext))),typeof f._isUnifiedPlanDefault>"u"&&(f._isUnifiedPlanDefault=typeof window<"u"&&typeof RTCPeerConnection<"u"&&typeof RTCRtpTransceiver<"u"?m.isUnifiedPlanDefault(window,window.navigator,RTCPeerConnection,RTCRtpTransceiver):!1),P._boundDestroy=P.destroy.bind(P),P._boundConfirmClose=P._confirmClose.bind(P),typeof window<"u"&&window.addEventListener&&(window.addEventListener("unload",P._boundDestroy),window.addEventListener("pagehide",P._boundDestroy)),P.updateOptions(k),P}return Object.defineProperty(f,"audioContext",{get:function(){return f._audioContext},enumerable:!1,configurable:!0}),Object.defineProperty(f,"extension",{get:function(){var C=typeof document<"u"?document.createElement("audio"):{canPlayType:!1},k;try{k=C.canPlayType&&!!C.canPlayType("audio/mpeg").replace(/no/,"")}catch{k=!1}var c;try{c=C.canPlayType&&!!C.canPlayType("audio/ogg;codecs='vorbis'").replace(/no/,"")}catch{c=!1}return c&&!k?"ogg":"mp3"},enumerable:!1,configurable:!0}),Object.defineProperty(f,"isSupported",{get:function(){return t.enabled()},enumerable:!1,configurable:!0}),Object.defineProperty(f,"packageName",{get:function(){return T.PACKAGE_NAME},enumerable:!1,configurable:!0}),f.runPreflight=function(C,k){return new i.PreflightTest(C,p({audioContext:f._getOrCreateAudioContext()},k))},f.toString=function(){return"[Twilio.Device class]"},Object.defineProperty(f,"version",{get:function(){return T.RELEASE_VERSION},enumerable:!1,configurable:!0}),f._getOrCreateAudioContext=function(){return f._audioContext||(typeof AudioContext<"u"?f._audioContext=new AudioContext:typeof webkitAudioContext<"u"&&(f._audioContext=new webkitAudioContext)),f._audioContext},Object.defineProperty(f.prototype,"audio",{get:function(){return this._audio},enumerable:!1,configurable:!0}),f.prototype.connect=function(C){return C===void 0&&(C={}),d(this,void 0,void 0,function(){var k,c;return l(this,function(P){switch(P.label){case 0:if(this._throwIfDestroyed(),this._activeCall)throw new a.InvalidStateError("A Call is already active");return c=this,[4,this._makeCall(C.params||{},{rtcConfiguration:C.rtcConfiguration,voiceEventSidGenerator:this._options.voiceEventSidGenerator})];case 1:return k=c._activeCall=P.sent(),this._calls.splice(0).forEach(function(U){return U.ignore()}),this._soundcache.get(f.SoundName.Incoming).stop(),k.accept({rtcConstraints:C.rtcConstraints}),this._publishNetworkChange(),[2,k]}})})},Object.defineProperty(f.prototype,"calls",{get:function(){return this._calls},enumerable:!1,configurable:!0}),f.prototype.destroy=function(){this.disconnectAll(),this._stopRegistrationTimer(),this._audio&&this._audio._unbind(),this._destroyStream(),this._destroyPublisher(),this._destroyAudioHelper(),this._networkInformation&&typeof this._networkInformation.removeEventListener=="function"&&this._networkInformation.removeEventListener("change",this._publishNetworkChange),typeof window<"u"&&window.removeEventListener&&(window.removeEventListener("beforeunload",this._boundConfirmClose),window.removeEventListener("unload",this._boundDestroy),window.removeEventListener("pagehide",this._boundDestroy)),this._setState(f.State.Destroyed),S.EventEmitter.prototype.removeAllListeners.call(this)},f.prototype.disconnectAll=function(){var C=this._calls.splice(0);C.forEach(function(k){return k.disconnect()}),this._activeCall&&this._activeCall.disconnect()},Object.defineProperty(f.prototype,"edge",{get:function(){return this._edge},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"home",{get:function(){return this._home},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"identity",{get:function(){return this._identity},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"isBusy",{get:function(){return!!this._activeCall},enumerable:!1,configurable:!0}),f.prototype.register=function(){return d(this,void 0,void 0,function(){var C,k=this;return l(this,function(c){switch(c.label){case 0:if(this.state!==f.State.Unregistered)throw new a.InvalidStateError('Attempt to register when device is in state "'+this.state+'". '+('Must be "'+f.State.Unregistered+'".'));return this._setState(f.State.Registering),[4,this._streamConnectedPromise||this._setupStream()];case 1:return c.sent(),C=new Promise(function(P){k.once(f.State.Registered,P)}),[4,this._sendPresence(!0)];case 2:return c.sent(),[4,C];case 3:return c.sent(),[2]}})})},Object.defineProperty(f.prototype,"state",{get:function(){return this._state},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"token",{get:function(){return this._token},enumerable:!1,configurable:!0}),f.prototype.toString=function(){return"[Twilio.Device instance]"},f.prototype.unregister=function(){return d(this,void 0,void 0,function(){var C,k;return l(this,function(c){switch(c.label){case 0:if(this.state!==f.State.Registered)throw new a.InvalidStateError('Attempt to unregister when device is in state "'+this.state+'". '+('Must be "'+f.State.Registered+'".'));return this._shouldReRegister=!1,[4,this._streamConnectedPromise];case 1:return C=c.sent(),k=new Promise(function(P){C.on("offline",P)}),[4,this._sendPresence(!1)];case 2:return c.sent(),[4,k];case 3:return c.sent(),[2]}})})},f.prototype.updateOptions=function(C){if(C===void 0&&(C={}),this.state===f.State.Destroyed)throw new a.InvalidStateError('Attempt to "updateOptions" when device is in state "'+this.state+'".');this._options=p(p(p({},this._defaultOptions),this._options),C);var k=new Set(this._chunderURIs),c=typeof this._options.chunderw=="string"?[this._options.chunderw]:Array.isArray(this._options.chunderw)&&this._options.chunderw,P=this._chunderURIs=(c||e.getChunderURIs(this._options.edge)).map(e.createSignalingEndpointURL),U=k.size!==P.length;if(!U)for(var B=0,A=P;B<A.length;B++){var L=A[B];if(!k.has(L)){U=!0;break}}if(this.isBusy&&U)throw new a.InvalidStateError("Cannot change Edge while on an active Call");this._log.setDefaultLevel(typeof this._options.logLevel=="number"?this._options.logLevel:g.levels.ERROR),this._options.dscp&&(this._options.rtcConstraints||(this._options.rtcConstraints={}),this._options.rtcConstraints.optional=[{googDscp:!0}]);for(var j=0,N=Object.keys(f._defaultSounds);j<N.length;j++){var H=N[j],G=f._defaultSounds[H],V=T.SOUNDS_BASE_URL+"/"+G.filename+"."+f.extension+("?cache="+T.RELEASE_VERSION),W=this._options.sounds&&this._options.sounds[H]||V,z=new(this._options.Sound||s.default)(H,W,{audioContext:this._options.disableAudioContextSounds?null:f.audioContext,maxDuration:G.maxDuration,shouldLoop:G.shouldLoop});this._soundcache.set(H,z)}this._setupAudioHelper(),this._setupPublisher(),U&&this._streamConnectedPromise&&this._setupStream(),typeof window<"u"&&typeof window.addEventListener=="function"&&this._options.closeProtection&&(window.removeEventListener("beforeunload",this._boundConfirmClose),window.addEventListener("beforeunload",this._boundConfirmClose))},f.prototype.updateToken=function(C){if(this.state===f.State.Destroyed)throw new a.InvalidStateError('Attempt to "updateToken" when device is in state "'+this.state+'".');if(typeof C!="string")throw new a.InvalidArgumentError(R);this._token=C,this._stream&&this._stream.setToken(this._token),this._publisher&&this._publisher.setToken(this._token)},f.prototype._confirmClose=function(C){if(!this._activeCall)return"";var k=this._options.closeProtection||!1,c=typeof k!="string"?"A call is currently in-progress. Leaving or reloading this page will end the call.":k;return(C||window.event).returnValue=c,c},f.prototype._destroyAudioHelper=function(){this._audio&&(this._audio.removeAllListeners(),this._audio=null)},f.prototype._destroyPublisher=function(){this._publisher&&(this._publisher=null)},f.prototype._destroyStream=function(){this._stream&&(this._stream.removeListener("close",this._onSignalingClose),this._stream.removeListener("connected",this._onSignalingConnected),this._stream.removeListener("error",this._onSignalingError),this._stream.removeListener("invite",this._onSignalingInvite),this._stream.removeListener("offline",this._onSignalingOffline),this._stream.removeListener("ready",this._onSignalingReady),this._stream.destroy(),this._stream=null),this._onSignalingOffline(),this._streamConnectedPromise=null},f.prototype._findCall=function(C){return this._calls.find(function(k){return k.parameters.CallSid===C||k.outboundConnectionId===C})||null},f.prototype._makeCall=function(C,k){return d(this,void 0,void 0,function(){var c,P,U,B,A=this;return l(this,function(L){switch(L.label){case 0:if(typeof f._isUnifiedPlanDefault>"u")throw new a.InvalidStateError("Device has not been initialized.");return B={audioHelper:this._audio,getUserMedia:this._options.getUserMedia||r.default,isUnifiedPlanDefault:f._isUnifiedPlanDefault,onIgnore:function(){A._soundcache.get(f.SoundName.Incoming).stop()}},[4,this._streamConnectedPromise||this._setupStream()];case 1:return c=(B.pstream=L.sent(),B.publisher=this._publisher,B.soundcache=this._soundcache,B),k=Object.assign({MediaStream:this._options.MediaStream||t.PeerConnection,RTCPeerConnection:this._options.RTCPeerConnection,beforeAccept:function(j){!A._activeCall||A._activeCall===j||(A._activeCall.disconnect(),A._removeCall(A._activeCall))},codecPreferences:this._options.codecPreferences,customSounds:this._options.sounds,dialtonePlayer:f._dialtonePlayer,dscp:this._options.dscp,forceAggressiveIceNomination:this._options.forceAggressiveIceNomination,getInputStream:function(){return A._options.fileInputStream||A._callInputStream},getSinkIds:function(){return A._callSinkIds},maxAverageBitrate:this._options.maxAverageBitrate,preflight:this._options.preflight,rtcConstraints:this._options.rtcConstraints,shouldPlayDisconnect:function(){var j;return(j=A._audio)===null||j===void 0?void 0:j.disconnect()},twimlParams:C,voiceEventSidGenerator:this._options.voiceEventSidGenerator},k),P=function(){if(!A._stream){A._log.warn("UnsetPreferredUri called without a stream");return}A._activeCall===null&&A._calls.length===0&&A._stream.updatePreferredURI(null)},U=new(this._options.Call||h.default)(c,k),this._publisher.info("settings","init",{RTCPeerConnection:!!this._options.RTCPeerConnection,enumerateDevices:!!this._options.enumerateDevices,getUserMedia:!!this._options.getUserMedia},U),U.once("accept",function(){var j;A._stream.updatePreferredURI(A._preferredURI),A._removeCall(U),A._activeCall=U,A._audio&&A._audio._maybeStartPollingVolume(),U.direction===h.default.CallDirection.Outgoing&&(!((j=A._audio)===null||j===void 0)&&j.outgoing())&&A._soundcache.get(f.SoundName.Outgoing).play();var N={edge:A._edge||A._region};A._options.edge&&(N.selected_edge=Array.isArray(A._options.edge)?A._options.edge:[A._options.edge]),A._publisher.info("settings","edge",N,U)}),U.addListener("error",function(j){U.status()==="closed"&&(A._removeCall(U),P()),A._audio&&A._audio._maybeStopPollingVolume(),A._maybeStopIncomingSound()}),U.once("cancel",function(){A._log.info("Canceled: "+U.parameters.CallSid),A._removeCall(U),P(),A._audio&&A._audio._maybeStopPollingVolume(),A._maybeStopIncomingSound()}),U.once("disconnect",function(){A._audio&&A._audio._maybeStopPollingVolume(),A._removeCall(U),P(),A._maybeStopIncomingSound()}),U.once("reject",function(){A._log.info("Rejected: "+U.parameters.CallSid),A._audio&&A._audio._maybeStopPollingVolume(),A._removeCall(U),P(),A._maybeStopIncomingSound()}),U.on("transportClose",function(){U.status()===h.default.State.Pending&&(A._audio&&A._audio._maybeStopPollingVolume(),A._removeCall(U),A._maybeStopIncomingSound())}),[2,U]}})})},f.prototype._maybeStopIncomingSound=function(){this._calls.length||this._soundcache.get(f.SoundName.Incoming).stop()},f.prototype._removeCall=function(C){this._activeCall===C&&(this._activeCall=null);for(var k=this._calls.length-1;k>=0;k--)C===this._calls[k]&&this._calls.splice(k,1)},f.prototype._sendPresence=function(C){return d(this,void 0,void 0,function(){var k;return l(this,function(c){switch(c.label){case 0:return[4,this._streamConnectedPromise];case 1:return k=c.sent(),k?(k.register({audio:C}),C?this._startRegistrationTimer():this._stopRegistrationTimer(),[2]):[2]}})})},f.prototype._setState=function(C){C!==this.state&&(this._state=C,this.emit(this._stateEventMapping[C]))},f.prototype._setupAudioHelper=function(){var C=this,k={audioContext:f.audioContext,enumerateDevices:this._options.enumerateDevices};this._audio&&(this._log.info("Found existing audio helper; destroying..."),k.enabledSounds=this._audio._getEnabledSounds(),this._destroyAudioHelper()),this._audio=new(this._options.AudioHelper||b.default)(this._updateSinkIds,this._updateInputStream,this._options.getUserMedia||r.default,k),this._audio.on("deviceChange",function(c){var P=C._activeCall,U=c.map(function(B){return B.deviceId});C._publisher.info("audio","device-change",{lost_active_device_ids:U},P),P&&P._mediaHandler._onInputDevicesChanged()})},f.prototype._setupPublisher=function(){var C=this;this._publisher&&(this._log.info("Found existing publisher; destroying..."),this._destroyPublisher());var k={defaultPayload:this._createDefaultPayload,log:this._log,metadata:{app_name:this._options.appName,app_version:this._options.appVersion}};return this._options.eventgw&&(k.host=this._options.eventgw),this._home&&(k.host=e.createEventGatewayURI(this._home)),this._publisher=new(this._options.Publisher||v.default)(M,this.token,k),this._options.publishEvents===!1?this._publisher.disable():this._publisher.on("error",function(c){C._log.warn("Cannot connect to insights.",c)}),this._publisher},f.prototype._setupStream=function(){var C=this;return this._stream&&(this._log.info("Found existing stream; destroying..."),this._destroyStream()),this._log.info("Setting up VSP"),this._stream=new(this._options.PStream||n.default)(this.token,this._chunderURIs,{backoffMaxMs:this._options.backoffMaxMs,maxPreferredDurationMs:this._options.maxCallSignalingTimeoutMs}),this._stream.addListener("close",this._onSignalingClose),this._stream.addListener("connected",this._onSignalingConnected),this._stream.addListener("error",this._onSignalingError),this._stream.addListener("invite",this._onSignalingInvite),this._stream.addListener("offline",this._onSignalingOffline),this._stream.addListener("ready",this._onSignalingReady),this._streamConnectedPromise=new Promise(function(k){return C._stream.once("connected",function(){k(C._stream)})})},f.prototype._showIncomingCall=function(C,k){var c=this,P;return Promise.race([k(),new Promise(function(U,B){P=setTimeout(function(){var A="Playing incoming ringtone took too long; it might not play. Continuing execution...";B(new Error(A))},I)})]).catch(function(U){c._log.info(U.message)}).then(function(){clearTimeout(P),c.emit(f.EventName.Incoming,C)})},f.prototype._startRegistrationTimer=function(){var C=this;this._stopRegistrationTimer(),this._regTimer=setTimeout(function(){C._sendPresence(!0)},E)},f.prototype._stopRegistrationTimer=function(){this._regTimer&&clearTimeout(this._regTimer)},f.prototype._throwIfDestroyed=function(){if(this.state===f.State.Destroyed)throw new a.InvalidStateError("Device has been destroyed.")},f.prototype._updateRingtoneSinkIds=function(C){return Promise.resolve(this._soundcache.get(f.SoundName.Incoming).setSinkIds(C))},f.prototype._updateSpeakerSinkIds=function(C){Array.from(this._soundcache.entries()).filter(function(c){return c[0]!==f.SoundName.Incoming}).forEach(function(c){return c[1].setSinkIds(C)}),this._callSinkIds=C;var k=this._activeCall;return k?k._setSinkIds(C):Promise.resolve()},f._defaultSounds={disconnect:{filename:"disconnect",maxDuration:3e3},dtmf0:{filename:"dtmf-0",maxDuration:1e3},dtmf1:{filename:"dtmf-1",maxDuration:1e3},dtmf2:{filename:"dtmf-2",maxDuration:1e3},dtmf3:{filename:"dtmf-3",maxDuration:1e3},dtmf4:{filename:"dtmf-4",maxDuration:1e3},dtmf5:{filename:"dtmf-5",maxDuration:1e3},dtmf6:{filename:"dtmf-6",maxDuration:1e3},dtmf7:{filename:"dtmf-7",maxDuration:1e3},dtmf8:{filename:"dtmf-8",maxDuration:1e3},dtmf9:{filename:"dtmf-9",maxDuration:1e3},dtmfh:{filename:"dtmf-hash",maxDuration:1e3},dtmfs:{filename:"dtmf-star",maxDuration:1e3},incoming:{filename:"incoming",shouldLoop:!0},outgoing:{filename:"outgoing",maxDuration:3e3}},f}(S.EventEmitter);(function(D){(function(f){f.Error="error",f.Incoming="incoming",f.Destroyed="destroyed",f.Unregistered="unregistered",f.Registering="registering",f.Registered="registered",f.TokenWillExpire="tokenWillExpire"})(D.EventName||(D.EventName={})),function(f){f.Destroyed="destroyed",f.Unregistered="unregistered",f.Registering="registering",f.Registered="registered"}(D.State||(D.State={})),function(f){f.Incoming="incoming",f.Outgoing="outgoing",f.Disconnect="disconnect",f.Dtmf0="dtmf0",f.Dtmf1="dtmf1",f.Dtmf2="dtmf2",f.Dtmf3="dtmf3",f.Dtmf4="dtmf4",f.Dtmf5="dtmf5",f.Dtmf6="dtmf6",f.Dtmf7="dtmf7",f.Dtmf8="dtmf8",f.Dtmf9="dtmf9",f.DtmfS="dtmfs",f.DtmfH="dtmfh"}(D.SoundName||(D.SoundName={}))})(x||(x={})),w.default=x},{"./audiohelper":3,"./call":8,"./constants":9,"./dialtonePlayer":12,"./errors":14,"./eventpublisher":16,"./log":17,"./preflight/preflight":19,"./pstream":20,"./regions":21,"./rtc":25,"./rtc/getusermedia":23,"./sound":35,"./util":37,"./uuid":38,events:40,loglevel:44}],12:[function(O,F,w){Object.defineProperty(w,"__esModule",{value:!0});var y=O("./errors"),p={dtmf0:[1360,960],dtmf1:[1230,720],dtmf2:[1360,720],dtmf3:[1480,720],dtmf4:[1230,790],dtmf5:[1360,790],dtmf6:[1480,790],dtmf7:[1230,870],dtmf8:[1360,870],dtmf9:[1480,870],dtmfh:[1480,960],dtmfs:[1230,960]},d=function(){function l(S){var g=this;this._context=S,this._gainNodes=[],this._gainNodes=[this._context.createGain(),this._context.createGain()],this._gainNodes.forEach(function(b){b.connect(g._context.destination),b.gain.value=.1,g._gainNodes.push(b)})}return l.prototype.cleanup=function(){this._gainNodes.forEach(function(S){S.disconnect()})},l.prototype.play=function(S){var g=this,b=p[S];if(!b)throw new y.InvalidArgumentError("Invalid DTMF sound name");var h=[this._context.createOscillator(),this._context.createOscillator()];h.forEach(function(T,u){T.type="sine",T.frequency.value=b[u],T.connect(g._gainNodes[u]),T.start(),T.stop(g._context.currentTime+.1),T.addEventListener("ended",function(){return T.disconnect()})})},l}();w.default=d},{"./errors":14}],13:[function(O,F,w){var y=this&&this.__extends||function(){var u=function(a,v){return u=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(o,i){o.__proto__=i}||function(o,i){for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(o[n]=i[n])},u(a,v)};return function(a,v){u(a,v);function o(){this.constructor=a}a.prototype=v===null?Object.create(v):(o.prototype=v.prototype,new o)}}();Object.defineProperty(w,"__esModule",{value:!0}),w.errorsByCode=w.MediaErrors=w.SignalingErrors=w.UserMediaErrors=w.MalformedRequestErrors=w.GeneralErrors=w.ClientErrors=w.AuthorizationErrors=w.TwilioError=void 0;var p=O("./twilioError");w.TwilioError=p.default;var d;(function(u){var a=function(i){y(n,i);function n(e,t){var r=i.call(this,e,t)||this;r.causes=[],r.code=20101,r.description="Invalid access token",r.explanation="Twilio was unable to validate your Access Token",r.name="AccessTokenInvalid",r.solutions=[],Object.setPrototypeOf(r,u.AccessTokenInvalid.prototype);var s=typeof e=="string"?e:r.explanation,m=typeof e=="object"?e:t;return r.message=r.name+" ("+r.code+"): "+s,r.originalError=m,r}return n}(p.default);u.AccessTokenInvalid=a;var v=function(i){y(n,i);function n(e,t){var r=i.call(this,e,t)||this;r.causes=[],r.code=20104,r.description="Access token expired or expiration date invalid",r.explanation="The Access Token provided to the Twilio API has expired, the expiration time specified in the token was invalid, or the expiration time specified was too far in the future",r.name="AccessTokenExpired",r.solutions=[],Object.setPrototypeOf(r,u.AccessTokenExpired.prototype);var s=typeof e=="string"?e:r.explanation,m=typeof e=="object"?e:t;return r.message=r.name+" ("+r.code+"): "+s,r.originalError=m,r}return n}(p.default);u.AccessTokenExpired=v;var o=function(i){y(n,i);function n(e,t){var r=i.call(this,e,t)||this;r.causes=[],r.code=20151,r.description="Authentication Failed",r.explanation="The Authentication with the provided JWT failed",r.name="AuthenticationFailed",r.solutions=[],Object.setPrototypeOf(r,u.AuthenticationFailed.prototype);var s=typeof e=="string"?e:r.explanation,m=typeof e=="object"?e:t;return r.message=r.name+" ("+r.code+"): "+s,r.originalError=m,r}return n}(p.default);u.AuthenticationFailed=o})(d=w.AuthorizationErrors||(w.AuthorizationErrors={}));var l;(function(u){var a=function(v){y(o,v);function o(i,n){var e=v.call(this,i,n)||this;e.causes=[],e.code=31400,e.description="Bad Request (HTTP/SIP)",e.explanation="The request could not be understood due to malformed syntax.",e.name="BadRequest",e.solutions=[],Object.setPrototypeOf(e,u.BadRequest.prototype);var t=typeof i=="string"?i:e.explanation,r=typeof i=="object"?i:n;return e.message=e.name+" ("+e.code+"): "+t,e.originalError=r,e}return o}(p.default);u.BadRequest=a})(l=w.ClientErrors||(w.ClientErrors={}));var S;(function(u){var a=function(n){y(e,n);function e(t,r){var s=n.call(this,t,r)||this;s.causes=[],s.code=31e3,s.description="Unknown Error",s.explanation="An unknown error has occurred. See error details for more information.",s.name="UnknownError",s.solutions=[],Object.setPrototypeOf(s,u.UnknownError.prototype);var m=typeof t=="string"?t:s.explanation,_=typeof t=="object"?t:r;return s.message=s.name+" ("+s.code+"): "+m,s.originalError=_,s}return e}(p.default);u.UnknownError=a;var v=function(n){y(e,n);function e(t,r){var s=n.call(this,t,r)||this;s.causes=[],s.code=31005,s.description="Connection error",s.explanation="A connection error occurred during the call",s.name="ConnectionError",s.solutions=[],Object.setPrototypeOf(s,u.ConnectionError.prototype);var m=typeof t=="string"?t:s.explanation,_=typeof t=="object"?t:r;return s.message=s.name+" ("+s.code+"): "+m,s.originalError=_,s}return e}(p.default);u.ConnectionError=v;var o=function(n){y(e,n);function e(t,r){var s=n.call(this,t,r)||this;s.causes=["The incoming call was cancelled because it was not answered in time or it was accepted/rejected by another application instance registered with the same identity."],s.code=31008,s.description="Call cancelled",s.explanation="Unable to answer because the call has ended",s.name="CallCancelledError",s.solutions=[],Object.setPrototypeOf(s,u.CallCancelledError.prototype);var m=typeof t=="string"?t:s.explanation,_=typeof t=="object"?t:r;return s.message=s.name+" ("+s.code+"): "+m,s.originalError=_,s}return e}(p.default);u.CallCancelledError=o;var i=function(n){y(e,n);function e(t,r){var s=n.call(this,t,r)||this;s.causes=[],s.code=31009,s.description="Transport error",s.explanation="No transport available to send or receive messages",s.name="TransportError",s.solutions=[],Object.setPrototypeOf(s,u.TransportError.prototype);var m=typeof t=="string"?t:s.explanation,_=typeof t=="object"?t:r;return s.message=s.name+" ("+s.code+"): "+m,s.originalError=_,s}return e}(p.default);u.TransportError=i})(S=w.GeneralErrors||(w.GeneralErrors={}));var g;(function(u){var a=function(v){y(o,v);function o(i,n){var e=v.call(this,i,n)||this;e.causes=["Invalid content or MessageType passed to sendMessage method."],e.code=31100,e.description="The request had malformed syntax.",e.explanation="The request could not be understood due to malformed syntax.",e.name="MalformedRequestError",e.solutions=["Ensure content and MessageType passed to sendMessage method are valid."],Object.setPrototypeOf(e,u.MalformedRequestError.prototype);var t=typeof i=="string"?i:e.explanation,r=typeof i=="object"?i:n;return e.message=e.name+" ("+e.code+"): "+t,e.originalError=r,e}return o}(p.default);u.MalformedRequestError=a})(g=w.MalformedRequestErrors||(w.MalformedRequestErrors={})),function(u){var a=function(o){y(i,o);function i(n,e){var t=o.call(this,n,e)||this;t.causes=["Rate limit exceeded."],t.code=31206,t.description="Rate exceeded authorized limit.",t.explanation="The request performed exceeds the authorized limit.",t.name="RateExceededError",t.solutions=["Ensure message send rate does not exceed authorized limits."],Object.setPrototypeOf(t,u.RateExceededError.prototype);var r=typeof n=="string"?n:t.explanation,s=typeof n=="object"?n:e;return t.message=t.name+" ("+t.code+"): "+r,t.originalError=s,t}return i}(p.default);u.RateExceededError=a;var v=function(o){y(i,o);function i(n,e){var t=o.call(this,n,e)||this;t.causes=["The payload size of Call Message Event exceeds the authorized limit."],t.code=31209,t.description="Call Message Event Payload size exceeded authorized limit.",t.explanation="The request performed to send a Call Message Event exceeds the payload size authorized limit",t.name="PayloadSizeExceededError",t.solutions=["Reduce payload size of Call Message Event to be within the authorized limit and try again."],Object.setPrototypeOf(t,u.PayloadSizeExceededError.prototype);var r=typeof n=="string"?n:t.explanation,s=typeof n=="object"?n:e;return t.message=t.name+" ("+t.code+"): "+r,t.originalError=s,t}return i}(p.default);u.PayloadSizeExceededError=v}(d=w.AuthorizationErrors||(w.AuthorizationErrors={}));var b;(function(u){var a=function(o){y(i,o);function i(n,e){var t=o.call(this,n,e)||this;t.causes=["The user denied the getUserMedia request.","The browser denied the getUserMedia request."],t.code=31401,t.description="UserMedia Permission Denied Error",t.explanation="The browser or end-user denied permissions to user media. Therefore we were unable to acquire input audio.",t.name="PermissionDeniedError",t.solutions=["The user should accept the request next time prompted. If the browser saved the deny, the user should change that permission in their browser.","The user should to verify that the browser has permission to access the microphone at this address."],Object.setPrototypeOf(t,u.PermissionDeniedError.prototype);var r=typeof n=="string"?n:t.explanation,s=typeof n=="object"?n:e;return t.message=t.name+" ("+t.code+"): "+r,t.originalError=s,t}return i}(p.default);u.PermissionDeniedError=a;var v=function(o){y(i,o);function i(n,e){var t=o.call(this,n,e)||this;t.causes=["NotFoundError - The deviceID specified was not found.","The getUserMedia constraints were overconstrained and no devices matched."],t.code=31402,t.description="UserMedia Acquisition Failed Error",t.explanation="The browser and end-user allowed permissions, however getting the media failed. Usually this is due to bad constraints, but can sometimes fail due to browser, OS or hardware issues.",t.name="AcquisitionFailedError",t.solutions=["Ensure the deviceID being specified exists.","Try acquiring media with fewer constraints."],Object.setPrototypeOf(t,u.AcquisitionFailedError.prototype);var r=typeof n=="string"?n:t.explanation,s=typeof n=="object"?n:e;return t.message=t.name+" ("+t.code+"): "+r,t.originalError=s,t}return i}(p.default);u.AcquisitionFailedError=v})(b=w.UserMediaErrors||(w.UserMediaErrors={}));var h;(function(u){var a=function(o){y(i,o);function i(n,e){var t=o.call(this,n,e)||this;t.causes=[],t.code=53e3,t.description="Signaling connection error",t.explanation="Raised whenever a signaling connection error occurs that is not covered by a more specific error code.",t.name="ConnectionError",t.solutions=[],Object.setPrototypeOf(t,u.ConnectionError.prototype);var r=typeof n=="string"?n:t.explanation,s=typeof n=="object"?n:e;return t.message=t.name+" ("+t.code+"): "+r,t.originalError=s,t}return i}(p.default);u.ConnectionError=a;var v=function(o){y(i,o);function i(n,e){var t=o.call(this,n,e)||this;t.causes=["The device running your application lost its Internet connection."],t.code=53001,t.description="Signaling connection disconnected",t.explanation="Raised whenever the signaling connection is unexpectedly disconnected.",t.name="ConnectionDisconnected",t.solutions=["Ensure the device running your application has access to a stable Internet connection."],Object.setPrototypeOf(t,u.ConnectionDisconnected.prototype);var r=typeof n=="string"?n:t.explanation,s=typeof n=="object"?n:e;return t.message=t.name+" ("+t.code+"): "+r,t.originalError=s,t}return i}(p.default);u.ConnectionDisconnected=v})(h=w.SignalingErrors||(w.SignalingErrors={}));var T;(function(u){var a=function(i){y(n,i);function n(e,t){var r=i.call(this,e,t)||this;r.causes=["The Client may not be using a supported WebRTC implementation.","The Client may not have the necessary resources to create or apply a new media description."],r.code=53400,r.description="Client is unable to create or apply a local media description",r.explanation="Raised whenever a Client is unable to create or apply a local media description.",r.name="ClientLocalDescFailed",r.solutions=["If you are experiencing this error using the JavaScript SDK, ensure you are running it with a supported WebRTC implementation."],Object.setPrototypeOf(r,u.ClientLocalDescFailed.prototype);var s=typeof e=="string"?e:r.explanation,m=typeof e=="object"?e:t;return r.message=r.name+" ("+r.code+"): "+s,r.originalError=m,r}return n}(p.default);u.ClientLocalDescFailed=a;var v=function(i){y(n,i);function n(e,t){var r=i.call(this,e,t)||this;r.causes=["The Client may not be using a supported WebRTC implementation.","The Client may be connecting peer-to-peer with another Participant that is not using a supported WebRTC implementation.","The Client may not have the necessary resources to apply a new media description."],r.code=53402,r.description="Client is unable to apply a remote media description",r.explanation="Raised whenever the Client receives a remote media description but is unable to apply it.",r.name="ClientRemoteDescFailed",r.solutions=["If you are experiencing this error using the JavaScript SDK, ensure you are running it with a supported WebRTC implementation."],Object.setPrototypeOf(r,u.ClientRemoteDescFailed.prototype);var s=typeof e=="string"?e:r.explanation,m=typeof e=="object"?e:t;return r.message=r.name+" ("+r.code+"): "+s,r.originalError=m,r}return n}(p.default);u.ClientRemoteDescFailed=v;var o=function(i){y(n,i);function n(e,t){var r=i.call(this,e,t)||this;r.causes=["The Client was unable to establish a media connection.","A media connection which was active failed liveliness checks."],r.code=53405,r.description="Media connection failed",r.explanation="Raised by the Client or Server whenever a media connection fails.",r.name="ConnectionError",r.solutions=["If the problem persists, try connecting to another region.","Check your Client's network connectivity.","If you've provided custom ICE Servers then ensure that the URLs and credentials are valid."],Object.setPrototypeOf(r,u.ConnectionError.prototype);var s=typeof e=="string"?e:r.explanation,m=typeof e=="object"?e:t;return r.message=r.name+" ("+r.code+"): "+s,r.originalError=m,r}return n}(p.default);u.ConnectionError=o})(T=w.MediaErrors||(w.MediaErrors={})),w.errorsByCode=new Map([[20101,d.AccessTokenInvalid],[20104,d.AccessTokenExpired],[20151,d.AuthenticationFailed],[31400,l.BadRequest],[31e3,S.UnknownError],[31005,S.ConnectionError],[31008,S.CallCancelledError],[31009,S.TransportError],[31100,g.MalformedRequestError],[31206,d.RateExceededError],[31209,d.PayloadSizeExceededError],[31401,b.PermissionDeniedError],[31402,b.AcquisitionFailedError],[53e3,h.ConnectionError],[53001,h.ConnectionDisconnected],[53400,T.ClientLocalDescFailed],[53402,T.ClientRemoteDescFailed],[53405,T.ConnectionError]]),Object.freeze(w.errorsByCode)},{"./twilioError":15}],14:[function(O,F,w){var y=this&&this.__extends||function(){var h=function(T,u){return h=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(a,v){a.__proto__=v}||function(a,v){for(var o in v)Object.prototype.hasOwnProperty.call(v,o)&&(a[o]=v[o])},h(T,u)};return function(T,u){h(T,u);function a(){this.constructor=T}T.prototype=u===null?Object.create(u):(a.prototype=u.prototype,new a)}}();Object.defineProperty(w,"__esModule",{value:!0}),w.UserMediaErrors=w.TwilioError=w.SignalingErrors=w.MediaErrors=w.GeneralErrors=w.ClientErrors=w.AuthorizationErrors=w.hasErrorByCode=w.getErrorByCode=w.NotSupportedError=w.InvalidStateError=w.InvalidArgumentError=void 0;var p=O("./generated");Object.defineProperty(w,"AuthorizationErrors",{enumerable:!0,get:function(){return p.AuthorizationErrors}}),Object.defineProperty(w,"ClientErrors",{enumerable:!0,get:function(){return p.ClientErrors}}),Object.defineProperty(w,"GeneralErrors",{enumerable:!0,get:function(){return p.GeneralErrors}}),Object.defineProperty(w,"MediaErrors",{enumerable:!0,get:function(){return p.MediaErrors}}),Object.defineProperty(w,"SignalingErrors",{enumerable:!0,get:function(){return p.SignalingErrors}}),Object.defineProperty(w,"TwilioError",{enumerable:!0,get:function(){return p.TwilioError}}),Object.defineProperty(w,"UserMediaErrors",{enumerable:!0,get:function(){return p.UserMediaErrors}});var d=function(h){y(T,h);function T(u){var a=h.call(this,u)||this;return a.name="InvalidArgumentError",a}return T}(Error);w.InvalidArgumentError=d;var l=function(h){y(T,h);function T(u){var a=h.call(this,u)||this;return a.name="InvalidStateError",a}return T}(Error);w.InvalidStateError=l;var S=function(h){y(T,h);function T(u){var a=h.call(this,u)||this;return a.name="NotSupportedError",a}return T}(Error);w.NotSupportedError=S;function g(h){var T=p.errorsByCode.get(h);if(!T)throw new d("Error code "+h+" not found");return T}w.getErrorByCode=g;function b(h){return p.errorsByCode.has(h)}w.hasErrorByCode=b},{"./generated":13}],15:[function(O,F,w){var y=this&&this.__extends||function(){var d=function(l,S){return d=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(g,b){g.__proto__=b}||function(g,b){for(var h in b)Object.prototype.hasOwnProperty.call(b,h)&&(g[h]=b[h])},d(l,S)};return function(l,S){d(l,S);function g(){this.constructor=l}l.prototype=S===null?Object.create(S):(g.prototype=S.prototype,new g)}}();Object.defineProperty(w,"__esModule",{value:!0});var p=function(d){y(l,d);function l(S,g){var b=d.call(this)||this;Object.setPrototypeOf(b,l.prototype);var h=typeof S=="string"?S:b.explanation,T=typeof S=="object"?S:g;return b.message=b.name+" ("+b.code+"): "+h,b.originalError=T,b}return l}(Error);w.default=p},{}],16:[function(O,F,w){var y=this&&this.__extends||function(){var g=function(b,h){return g=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(T,u){T.__proto__=u}||function(T,u){for(var a in u)Object.prototype.hasOwnProperty.call(u,a)&&(T[a]=u[a])},g(b,h)};return function(b,h){g(b,h);function T(){this.constructor=b}b.prototype=h===null?Object.create(h):(T.prototype=h.prototype,new T)}}();Object.defineProperty(w,"__esModule",{value:!0});var p=O("events"),d=O("./request"),l=function(g){y(b,g);function b(h,T,u){var a=g.call(this)||this;if(!(a instanceof b))return new b(h,T,u);u=Object.assign({defaultPayload:function(){return{}}},u);var v=u.defaultPayload;typeof v!="function"&&(v=function(){return Object.assign({},u.defaultPayload)});var o=!0,i=Object.assign({app_name:void 0,app_version:void 0},u.metadata);return Object.defineProperties(a,{_defaultPayload:{value:v},_host:{value:u.host,writable:!0},_isEnabled:{get:function(){return o},set:function(n){o=n}},_log:{value:u.log},_request:{value:u.request||d.default,writable:!0},_token:{value:T,writable:!0},isEnabled:{enumerable:!0,get:function(){return o}},metadata:{enumerable:!0,get:function(){return i}},productName:{enumerable:!0,value:h},token:{enumerable:!0,get:function(){return this._token}}}),a}return b}(p.EventEmitter);l.prototype._post=function(b,h,T,u,a,v,o){var i=this;if(!this.isEnabled&&!o||!this._host||!v||(!v.parameters||!v.parameters.CallSid)&&!v.outboundConnectionId)return Promise.resolve();var n={group:T,level:h.toUpperCase(),name:u,payload:a&&a.forEach?a.slice(0):Object.assign(this._defaultPayload(v),a),payload_type:"application/json",private:!1,publisher:this.productName,timestamp:new Date().toISOString()};this.metadata&&(n.publisher_metadata=this.metadata);var e={body:n,headers:{"Content-Type":"application/json","X-Twilio-Token":this.token},url:"https://"+this._host+"/v4/"+b};return new Promise(function(t,r){i._request.post(e,function(s){s?(i.emit("error",s),r(s)):t()})}).catch(function(t){i._log.warn("Unable to post "+T+" "+u+" event to Insights. Received error: "+t)})},l.prototype.post=function(b,h,T,u,a,v){return this._post("EndpointEvents",b,h,T,u,a,v)},l.prototype.debug=function(b,h,T,u){return this.post("debug",b,h,T,u)},l.prototype.info=function(b,h,T,u){return this.post("info",b,h,T,u)},l.prototype.warn=function(b,h,T,u){return this.post("warning",b,h,T,u)},l.prototype.error=function(b,h,T,u){return this.post("error",b,h,T,u)},l.prototype.postMetrics=function(b,h,T,u,a){var v=this;return new Promise(function(o){var i=T.map(S).map(function(n){return Object.assign(n,u)});o(v._post("EndpointMetrics","info",b,h,i,a))})},l.prototype.setHost=function(b){this._host=b},l.prototype.setToken=function(b){this._token=b},l.prototype.enable=function(){this._isEnabled=!0},l.prototype.disable=function(){this._isEnabled=!1};function S(g){return{audio_codec:g.codecName,audio_level_in:g.audioInputLevel,audio_level_out:g.audioOutputLevel,bytes_received:g.bytesReceived,bytes_sent:g.bytesSent,call_volume_input:g.inputVolume,call_volume_output:g.outputVolume,jitter:g.jitter,mos:g.mos&&Math.round(g.mos*100)/100,packets_lost:g.packetsLost,packets_lost_fraction:g.packetsLostFraction&&Math.round(g.packetsLostFraction*100)/100,packets_received:g.packetsReceived,rtt:g.rtt,timestamp:new Date(g.timestamp).toISOString(),total_bytes_received:g.totals.bytesReceived,total_bytes_sent:g.totals.bytesSent,total_packets_lost:g.totals.packetsLost,total_packets_received:g.totals.packetsReceived,total_packets_sent:g.totals.packetsSent}}w.default=l},{"./request":22,events:40}],17:[function(O,F,w){Object.defineProperty(w,"__esModule",{value:!0}),w.Logger=void 0;var y=O("loglevel"),p=O("./constants"),d=function(){function l(S){try{this._log=(S&&S.LogLevelModule?S.LogLevelModule:y).getLogger(p.PACKAGE_NAME)}catch{console.warn("Cannot create custom logger"),this._log=console}}return l.getInstance=function(){return l.instance||(l.instance=new l),l.instance},l.prototype.debug=function(){for(var S,g=[],b=0;b<arguments.length;b++)g[b]=arguments[b];(S=this._log).debug.apply(S,g)},l.prototype.error=function(){for(var S,g=[],b=0;b<arguments.length;b++)g[b]=arguments[b];(S=this._log).error.apply(S,g)},l.prototype.getLogLevelInstance=function(){return this._log},l.prototype.info=function(){for(var S,g=[],b=0;b<arguments.length;b++)g[b]=arguments[b];(S=this._log).info.apply(S,g)},l.prototype.setDefaultLevel=function(S){this._log.setDefaultLevel?this._log.setDefaultLevel(S):console.warn("Logger cannot setDefaultLevel")},l.prototype.warn=function(){for(var S,g=[],b=0;b<arguments.length;b++)g[b]=arguments[b];(S=this._log).warn.apply(S,g)},l.levels=y.levels,l}();w.Logger=d.getInstance().getLogLevelInstance(),w.default=d},{"./constants":9,loglevel:44}],18:[function(O,F,w){Object.defineProperty(w,"__esModule",{value:!0});var y=O("./constants"),p=O("./errors"),d=y.SOUNDS_BASE_URL+"/outgoing.mp3",l=function(){function S(g,b,h,T){this._name=g,this._availableDevices=b,this._beforeChange=h,this._isSupported=T,this._activeDevices=new Set}return S.prototype.delete=function(g){var b=!!this._activeDevices.delete(g),h=this._availableDevices.get("default")||Array.from(this._availableDevices.values())[0];!this._activeDevices.size&&h&&this._activeDevices.add(h);var T=Array.from(this._activeDevices.values()).map(function(u){return u.deviceId});return this._beforeChange(this._name,T),!!b},S.prototype.get=function(){return this._activeDevices},S.prototype.set=function(g){var b=this;if(!this._isSupported)return Promise.reject(new p.NotSupportedError("This browser does not support audio output selection"));var h=Array.isArray(g)?g:[g];if(!h.length)return Promise.reject(new p.InvalidArgumentError("Must specify at least one device to set"));var T=[],u=h.map(function(a){var v=b._availableDevices.get(a);return v||T.push(a),v});return T.length?Promise.reject(new p.InvalidArgumentError("Devices not found: "+T.join(", "))):new Promise(function(a){a(b._beforeChange(b._name,h))}).then(function(){b._activeDevices.clear(),u.forEach(b._activeDevices.add,b._activeDevices)})},S.prototype.test=function(g){return g===void 0&&(g=d),this._isSupported?this._activeDevices.size?Promise.all(Array.from(this._activeDevices).map(function(b){var h;return new Promise(function(T){h=new Audio(g),h.oncanplay=T}).then(function(){return h.setSinkId(b.deviceId).then(function(){return h.play()})})})):Promise.reject(new p.InvalidStateError("No active output devices to test")):Promise.reject(new p.NotSupportedError("This browser does not support audio output selection"))},S}();w.default=l},{"./constants":9,"./errors":14}],19:[function(O,F,w){var y=this&&this.__extends||function(){var v=function(o,i){return v=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,e){n.__proto__=e}||function(n,e){for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(n[t]=e[t])},v(o,i)};return function(o,i){v(o,i);function n(){this.constructor=o}o.prototype=i===null?Object.create(i):(n.prototype=i.prototype,new n)}}(),p=this&&this.__assign||function(){return p=Object.assign||function(v){for(var o,i=1,n=arguments.length;i<n;i++){o=arguments[i];for(var e in o)Object.prototype.hasOwnProperty.call(o,e)&&(v[e]=o[e])}return v},p.apply(this,arguments)},d=this&&this.__awaiter||function(v,o,i,n){function e(t){return t instanceof i?t:new i(function(r){r(t)})}return new(i||(i=Promise))(function(t,r){function s(E){try{_(n.next(E))}catch(I){r(I)}}function m(E){try{_(n.throw(E))}catch(I){r(I)}}function _(E){E.done?t(E.value):e(E.value).then(s,m)}_((n=n.apply(v,o||[])).next())})},l=this&&this.__generator||function(v,o){var i={label:0,sent:function(){if(t[0]&1)throw t[1];return t[1]},trys:[],ops:[]},n,e,t,r;return r={next:s(0),throw:s(1),return:s(2)},typeof Symbol=="function"&&(r[Symbol.iterator]=function(){return this}),r;function s(_){return function(E){return m([_,E])}}function m(_){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,e&&(t=_[0]&2?e.return:_[0]?e.throw||((t=e.return)&&t.call(e),0):e.next)&&!(t=t.call(e,_[1])).done)return t;switch(e=0,t&&(_=[_[0]&2,t.value]),_[0]){case 0:case 1:t=_;break;case 4:return i.label++,{value:_[1],done:!1};case 5:i.label++,e=_[1],_=[0];continue;case 7:_=i.ops.pop(),i.trys.pop();continue;default:if(t=i.trys,!(t=t.length>0&&t[t.length-1])&&(_[0]===6||_[0]===2)){i=0;continue}if(_[0]===3&&(!t||_[1]>t[0]&&_[1]<t[3])){i.label=_[1];break}if(_[0]===6&&i.label<t[1]){i.label=t[1],t=_;break}if(t&&i.label<t[2]){i.label=t[2],i.ops.push(_);break}t[2]&&i.ops.pop(),i.trys.pop();continue}_=o.call(v,i)}catch(E){_=[6,E],e=0}finally{n=t=0}if(_[0]&5)throw _[1];return{value:_[0]?_[1]:void 0,done:!0}}};Object.defineProperty(w,"__esModule",{value:!0}),w.PreflightTest=void 0;var S=O("events"),g=O("../call"),b=O("../device"),h=O("../errors"),T=O("../rtc/stats"),u=O("../constants"),a=function(v){y(o,v);function o(i,n){var e=v.call(this)||this;return e._hasInsightsErrored=!1,e._networkTiming={},e._options={codecPreferences:[g.default.Codec.PCMU,g.default.Codec.Opus],edge:"roaming",fakeMicInput:!1,logLevel:"error",signalingTimeoutMs:1e4},e._status=o.Status.Connecting,Object.assign(e._options,n),e._samples=[],e._warnings=[],e._startTime=Date.now(),e._initDevice(i,p(p({},e._options),{fileInputStream:e._options.fakeMicInput?e._getStreamFromFile():void 0})),e}return o.prototype.stop=function(){var i=this,n=new h.GeneralErrors.CallCancelledError;this._device?(this._device.once(b.default.EventName.Unregistered,function(){return i._onFailed(n)}),this._device.destroy()):this._onFailed(n)},o.prototype._emitWarning=function(i,n,e){var t={name:i,description:n};e&&(t.rtcWarning=e),this._warnings.push(t),this.emit(o.Events.Warning,t)},o.prototype._getCallQuality=function(i){return i>4.2?o.CallQuality.Excellent:i>=4.1&&i<=4.2?o.CallQuality.Great:i>=3.7&&i<=4?o.CallQuality.Good:i>=3.1&&i<=3.6?o.CallQuality.Fair:o.CallQuality.Degraded},o.prototype._getReport=function(){var i=this._getRTCStats(),n={start:this._startTime};this._endTime&&(n.end=this._endTime,n.duration=this._endTime-this._startTime);var e={callSid:this._callSid,edge:this._edge,iceCandidateStats:this._rtcIceCandidateStatsReport.iceCandidateStats,networkTiming:this._networkTiming,samples:this._samples,selectedEdge:this._options.edge,stats:i,testTiming:n,totals:this._getRTCSampleTotals(),warnings:this._warnings},t=this._rtcIceCandidateStatsReport.selectedIceCandidatePairStats;return t&&(e.selectedIceCandidatePairStats=t,e.isTurnRequired=t.localCandidate.candidateType==="relay"||t.remoteCandidate.candidateType==="relay"),i&&(e.callQuality=this._getCallQuality(i.mos.average)),e},o.prototype._getRTCSampleTotals=function(){if(this._latestSample)return p({},this._latestSample.totals)},o.prototype._getRTCStats=function(){var i=this._samples.findIndex(function(e){return typeof e.mos=="number"&&e.mos>0}),n=i>=0?this._samples.slice(i):[];if(!(!n||!n.length))return["jitter","mos","rtt"].reduce(function(e,t){var r,s=n.map(function(m){return m[t]});return p(p({},e),(r={},r[t]={average:Number((s.reduce(function(m,_){return m+_})/s.length).toPrecision(5)),max:Math.max.apply(Math,s),min:Math.min.apply(Math,s)},r))},{})},o.prototype._getStreamFromFile=function(){var i=this._options.audioContext;if(!i)throw new h.NotSupportedError("Cannot fake input audio stream: AudioContext is not supported by this browser.");var n=new Audio(u.COWBELL_AUDIO_URL);n.addEventListener("canplaythrough",function(){return n.play()}),typeof n.setAttribute=="function"&&n.setAttribute("crossorigin","anonymous");var e=i.createMediaElementSource(n),t=i.createMediaStreamDestination();return e.connect(t),t.stream},o.prototype._initDevice=function(i,n){var e=this;try{this._device=new(n.deviceFactory||b.default)(i,{codecPreferences:n.codecPreferences,edge:n.edge,fileInputStream:n.fileInputStream,logLevel:n.logLevel,preflight:!0}),this._device.once(b.default.EventName.Registered,function(){e._onDeviceRegistered()}),this._device.once(b.default.EventName.Error,function(t){e._onDeviceError(t)}),this._device.register()}catch(t){setTimeout(function(){e._onFailed(t)});return}this._signalingTimeoutTimer=setTimeout(function(){e._onDeviceError(new h.SignalingErrors.ConnectionError("WebSocket Connection Timeout"))},n.signalingTimeoutMs)},o.prototype._onDeviceError=function(i){this._device.destroy(),this._onFailed(i)},o.prototype._onDeviceRegistered=function(){return d(this,void 0,void 0,function(){var i,n,e,t=this;return l(this,function(r){switch(r.label){case 0:return clearTimeout(this._echoTimer),clearTimeout(this._signalingTimeoutTimer),i=this,[4,this._device.connect({rtcConfiguration:this._options.rtcConfiguration})];case 1:return i._call=r.sent(),this._networkTiming.signaling={start:Date.now()},this._setupCallHandlers(this._call),this._edge=this._device.edge||void 0,this._options.fakeMicInput&&(this._echoTimer=setTimeout(function(){return t._device.disconnectAll()},u.ECHO_TEST_DURATION),n=this._device.audio,n&&(n.disconnect(!1),n.outgoing(!1))),this._call.once("disconnect",function(){t._device.once(b.default.EventName.Unregistered,function(){return t._onUnregistered()}),t._device.destroy()}),e=this._call._publisher,e.on("error",function(){t._hasInsightsErrored||t._emitWarning("insights-connection-error","Received an error when attempting to connect to Insights gateway"),t._hasInsightsErrored=!0}),[2]}})})},o.prototype._onFailed=function(i){clearTimeout(this._echoTimer),clearTimeout(this._signalingTimeoutTimer),this._releaseHandlers(),this._endTime=Date.now(),this._status=o.Status.Failed,this.emit(o.Events.Failed,i)},o.prototype._onUnregistered=function(){var i=this;setTimeout(function(){i._status!==o.Status.Failed&&(clearTimeout(i._echoTimer),clearTimeout(i._signalingTimeoutTimer),i._releaseHandlers(),i._endTime=Date.now(),i._status=o.Status.Completed,i._report=i._getReport(),i.emit(o.Events.Completed,i._report))},10)},o.prototype._releaseHandlers=function(){[this._device,this._call].forEach(function(i){i&&i.eventNames().forEach(function(n){return i.removeAllListeners(n)})})},o.prototype._setupCallHandlers=function(i){var n=this;this._options.fakeMicInput&&i.once("volume",function(){i._mediaHandler.outputs.forEach(function(e){return e.audio.muted=!0})}),i.on("warning",function(e,t){n._emitWarning(e,"Received an RTCWarning. See .rtcWarning for the RTCWarning",t)}),i.once("accept",function(){n._callSid=i._mediaHandler.callSid,n._status=o.Status.Connected,n.emit(o.Events.Connected)}),i.on("sample",function(e){return d(n,void 0,void 0,function(){var t;return l(this,function(r){switch(r.label){case 0:return this._latestSample?[3,2]:(t=this,[4,(this._options.getRTCIceCandidateStatsReport||T.getRTCIceCandidateStatsReport)(i._mediaHandler.version.pc)]);case 1:t._rtcIceCandidateStatsReport=r.sent(),r.label=2;case 2:return this._latestSample=e,this._samples.push(e),this.emit(o.Events.Sample,e),[2]}})})}),[{reportLabel:"peerConnection",type:"pcconnection"},{reportLabel:"ice",type:"iceconnection"},{reportLabel:"dtls",type:"dtlstransport"},{reportLabel:"signaling",type:"signaling"}].forEach(function(e){var t=e.type,r=e.reportLabel,s="on"+t+"statechange",m=i._mediaHandler[s];i._mediaHandler[s]=function(_){var E=n._networkTiming[r]=n._networkTiming[r]||{start:0};_==="connecting"||_==="checking"?E.start=Date.now():(_==="connected"||_==="stable")&&!E.duration&&(E.end=Date.now(),E.duration=E.end-E.start),m(_)}})},Object.defineProperty(o.prototype,"callSid",{get:function(){return this._callSid},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"endTime",{get:function(){return this._endTime},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"latestSample",{get:function(){return this._latestSample},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"report",{get:function(){return this._report},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"startTime",{get:function(){return this._startTime},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"status",{get:function(){return this._status},enumerable:!1,configurable:!0}),o}(S.EventEmitter);w.PreflightTest=a,function(v){(function(o){o.Excellent="excellent",o.Great="great",o.Good="good",o.Fair="fair",o.Degraded="degraded"})(v.CallQuality||(v.CallQuality={})),function(o){o.Completed="completed",o.Connected="connected",o.Failed="failed",o.Sample="sample",o.Warning="warning"}(v.Events||(v.Events={})),function(o){o.Connecting="connecting",o.Connected="connected",o.Completed="completed",o.Failed="failed"}(v.Status||(v.Status={}))}(a=w.PreflightTest||(w.PreflightTest={})),w.PreflightTest=a},{"../call":8,"../constants":9,"../device":11,"../errors":14,"../rtc/stats":31,events:40}],20:[function(O,F,w){var y=this&&this.__extends||function(){var u=function(a,v){return u=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(o,i){o.__proto__=i}||function(o,i){for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(o[n]=i[n])},u(a,v)};return function(a,v){u(a,v);function o(){this.constructor=a}a.prototype=v===null?Object.create(v):(o.prototype=v.prototype,new o)}}();Object.defineProperty(w,"__esModule",{value:!0});var p=O("events"),d=O("./constants"),l=O("./errors"),S=O("./log"),g=O("./wstransport"),b="1.6",h=function(u){y(a,u);function a(v,o,i){var n=u.call(this)||this;if(!(n instanceof a))return new a(v,o,i);var e={TransportFactory:g.default};i=i||{};for(var t in e)t in i||(i[t]=e[t]);n.options=i,n.token=v||"",n.status="disconnected",n.gateway=null,n.region=null,n._messageQueue=[],n._preferredUri=null,n._uris=o,n._handleTransportClose=n._handleTransportClose.bind(n),n._handleTransportError=n._handleTransportError.bind(n),n._handleTransportMessage=n._handleTransportMessage.bind(n),n._handleTransportOpen=n._handleTransportOpen.bind(n),n._log=S.default.getInstance(),n.on("error",function(){n._log.warn("Unexpected error handled in pstream")});var r=n;return n.addListener("ready",function(){r.status="ready"}),n.addListener("offline",function(){r.status="offline"}),n.addListener("close",function(){r._log.info('Received "close" from server. Destroying PStream...'),r._destroy()}),n.transport=new n.options.TransportFactory(n._uris,{backoffMaxMs:n.options.backoffMaxMs,maxPreferredDurationMs:n.options.maxPreferredDurationMs}),Object.defineProperties(n,{uri:{enumerable:!0,get:function(){return this.transport.uri}}}),n.transport.on("close",n._handleTransportClose),n.transport.on("error",n._handleTransportError),n.transport.on("message",n._handleTransportMessage),n.transport.on("open",n._handleTransportOpen),n.transport.open(),n}return a}(p.EventEmitter);h.prototype._handleTransportClose=function(){this.emit("transportClose"),this.status!=="disconnected"&&(this.status!=="offline"&&this.emit("offline",this),this.status="disconnected")},h.prototype._handleTransportError=function(u){if(!u){this.emit("error",{error:{code:31e3,message:"Websocket closed without a provided reason",twilioError:new l.SignalingErrors.ConnectionDisconnected}});return}this.emit("error",typeof u.code<"u"?{error:u}:u)},h.prototype._handleTransportMessage=function(u){if(!(!u||!u.data||typeof u.data!="string")){var a=JSON.parse(u.data),v=a.type,o=a.payload,i=o===void 0?{}:o;this.gateway=i.gateway||this.gateway,this.region=i.region||this.region,v==="error"&&i.error&&(i.error.twilioError=new l.SignalingErrors.ConnectionError),this.emit(v,i)}},h.prototype._handleTransportOpen=function(){var u=this;this.status="connected",this.setToken(this.token),this.emit("transportOpen");var a=this._messageQueue.splice(0,this._messageQueue.length);a.forEach(function(v){return u._publish.apply(u,v)})},h.toString=function(){return"[Twilio.PStream class]"},h.prototype.toString=function(){return"[Twilio.PStream instance]"},h.prototype.setToken=function(u){this._log.info("Setting token and publishing listen"),this.token=u;var a={browserinfo:T(),token:u};this._publish("listen",a)},h.prototype.sendMessage=function(u,a,v,o,i){v===void 0&&(v="application/json");var n={callsid:u,content:a,contenttype:v,messagetype:o,voiceeventsid:i};this._publish("message",n,!0)},h.prototype.register=function(u){var a={media:u};this._publish("register",a,!0)},h.prototype.invite=function(u,a,v,o){var i={callsid:a,preflight:!!v,sdp:u,twilio:o?{params:o}:{}};this._publish("invite",i,!0)},h.prototype.reconnect=function(u,a,v,o){var i={callsid:a,preflight:!1,reconnect:v,sdp:u,twilio:o?{params:o}:{}};this._publish("invite",i,!0)},h.prototype.answer=function(u,a){this._publish("answer",{sdp:u,callsid:a},!0)},h.prototype.dtmf=function(u,a){this._publish("dtmf",{callsid:u,dtmf:a},!0)},h.prototype.hangup=function(u,a){var v=a?{callsid:u,message:a}:{callsid:u};this._publish("hangup",v,!0)},h.prototype.reject=function(u){this._publish("reject",{callsid:u},!0)},h.prototype.reinvite=function(u,a){this._publish("reinvite",{sdp:u,callsid:a},!1)},h.prototype._destroy=function(){this.transport.removeListener("close",this._handleTransportClose),this.transport.removeListener("error",this._handleTransportError),this.transport.removeListener("message",this._handleTransportMessage),this.transport.removeListener("open",this._handleTransportOpen),this.transport.close(),this.emit("offline",this)},h.prototype.destroy=function(){return this._log.info("PStream.destroy() called..."),this._destroy(),this},h.prototype.updatePreferredURI=function(u){this._preferredUri=u,this.transport.updatePreferredURI(u)},h.prototype.updateURIs=function(u){this._uris=u,this.transport.updateURIs(this._uris)},h.prototype.publish=function(u,a){return this._publish(u,a,!0)},h.prototype._publish=function(u,a,v){var o=JSON.stringify({payload:a,type:u,version:b}),i=!!this.transport.send(o);i||(this.emit("error",{error:{code:31009,message:"No transport available to send or receive messages",twilioError:new l.GeneralErrors.TransportError}}),v&&this._messageQueue.push([u,a,!0]))};function T(){var u=typeof navigator<"u"?navigator:{},a={browser:{platform:u.platform||"unknown",userAgent:u.userAgent||"unknown"},p:"browser",plugin:"rtc",v:d.RELEASE_VERSION};return a}w.default=h},{"./constants":9,"./errors":14,"./log":17,"./wstransport":39,events:40}],21:[function(O,F,w){var y;Object.defineProperty(w,"__esModule",{value:!0}),w.getRegionShortcode=w.getChunderURIs=w.createSignalingEndpointURL=w.createEventGatewayURI=w.defaultEdge=w.regionToEdge=w.regionShortcodes=w.Region=w.Edge=void 0;var p=O("./errors"),d;(function(a){a.Sydney="sydney",a.SaoPaulo="sao-paulo",a.Dublin="dublin",a.Frankfurt="frankfurt",a.Tokyo="tokyo",a.Singapore="singapore",a.Ashburn="ashburn",a.Umatilla="umatilla",a.Roaming="roaming",a.AshburnIx="ashburn-ix",a.SanJoseIx="san-jose-ix",a.LondonIx="london-ix",a.FrankfurtIx="frankfurt-ix",a.SingaporeIx="singapore-ix",a.SydneyIx="sydney-ix",a.TokyoIx="tokyo-ix"})(d=w.Edge||(w.Edge={}));var l;(function(a){a.Au1="au1",a.Au1Ix="au1-ix",a.Br1="br1",a.De1="de1",a.De1Ix="de1-ix",a.Gll="gll",a.Ie1="ie1",a.Ie1Ix="ie1-ix",a.Ie1Tnx="ie1-tnx",a.Jp1="jp1",a.Jp1Ix="jp1-ix",a.Sg1="sg1",a.Sg1Ix="sg1-ix",a.Sg1Tnx="sg1-tnx",a.Us1="us1",a.Us1Ix="us1-ix",a.Us1Tnx="us1-tnx",a.Us2="us2",a.Us2Ix="us2-ix",a.Us2Tnx="us2-tnx"})(l=w.Region||(w.Region={})),w.regionShortcodes={ASIAPAC_SINGAPORE:l.Sg1,ASIAPAC_SYDNEY:l.Au1,ASIAPAC_TOKYO:l.Jp1,EU_FRANKFURT:l.De1,EU_IRELAND:l.Ie1,SOUTH_AMERICA_SAO_PAULO:l.Br1,US_EAST_VIRGINIA:l.Us1,US_WEST_OREGON:l.Us2},w.regionToEdge=(y={},y[l.Au1]=d.Sydney,y[l.Br1]=d.SaoPaulo,y[l.Ie1]=d.Dublin,y[l.De1]=d.Frankfurt,y[l.Jp1]=d.Tokyo,y[l.Sg1]=d.Singapore,y[l.Us1]=d.Ashburn,y[l.Us2]=d.Umatilla,y[l.Gll]=d.Roaming,y[l.Us1Ix]=d.AshburnIx,y[l.Us2Ix]=d.SanJoseIx,y[l.Ie1Ix]=d.LondonIx,y[l.De1Ix]=d.FrankfurtIx,y[l.Sg1Ix]=d.SingaporeIx,y[l.Au1Ix]=d.SydneyIx,y[l.Jp1Ix]=d.TokyoIx,y[l.Us1Tnx]=d.AshburnIx,y[l.Us2Tnx]=d.AshburnIx,y[l.Ie1Tnx]=d.LondonIx,y[l.Sg1Tnx]=d.SingaporeIx,y),w.defaultEdge=d.Roaming;var S="eventgw.twilio.com";function g(a){return"voice-js."+a+".twilio.com"}function b(a){return a?"eventgw."+a+".twilio.com":S}w.createEventGatewayURI=b;function h(a){return"wss://"+a+"/signal"}w.createSignalingEndpointURL=h;function T(a){if(a&&typeof a!="string"&&!Array.isArray(a))throw new p.InvalidArgumentError("If `edge` is provided, it must be of type `string` or an array of strings.");var v;if(a){var o=Array.isArray(a)?a:[a];v=o.map(function(i){return g(i)})}else v=[g(w.defaultEdge)];return v}w.getChunderURIs=T;function u(a){return w.regionShortcodes[a]||null}w.getRegionShortcode=u},{"./errors":14}],22:[function(O,F,w){Object.defineProperty(w,"__esModule",{value:!0});function y(d,l,S){var g=JSON.stringify(l.body||{}),b=new Headers;l.headers=l.headers||[],Object.entries(l.headers).forEach(function(h){var T=h[0],u=h[1];return b.append(T,u)}),fetch(l.url,{body:g,headers:b,method:d}).then(function(h){return h.text()},S).then(function(h){return S(null,h)},S)}var p=y;p.get=function(l,S){return new this("GET",l,S)},p.post=function(l,S){return new this("POST",l,S)},w.default=p},{}],23:[function(O,F,w){Object.defineProperty(w,"__esModule",{value:!0});var y=O("../errors"),p=O("../util");function d(l,S){return S=S||{},S.util=S.util||p,S.navigator=S.navigator||(typeof navigator<"u"?navigator:null),new Promise(function(g,b){if(!S.navigator)throw new y.NotSupportedError("getUserMedia is not supported");switch("function"){case typeof(S.navigator.mediaDevices&&S.navigator.mediaDevices.getUserMedia):return g(S.navigator.mediaDevices.getUserMedia(l));case typeof S.navigator.webkitGetUserMedia:return S.navigator.webkitGetUserMedia(l,g,b);case typeof S.navigator.mozGetUserMedia:return S.navigator.mozGetUserMedia(l,g,b);case typeof S.navigator.getUserMedia:return S.navigator.getUserMedia(l,g,b);default:throw new y.NotSupportedError("getUserMedia is not supported")}}).catch(function(g){throw S.util.isFirefox()&&g.name==="NotReadableError"?new y.NotSupportedError(`Firefox does not currently support opening multiple audio input trackssimultaneously, even across different tabs.
Related Bugzilla thread: https://bugzilla.mozilla.org/show_bug.cgi?id=1299324`):g})}w.default=d},{"../errors":14,"../util":37}],24:[function(O,F,w){Object.defineProperty(w,"__esModule",{value:!0}),w.IceCandidate=void 0;var y=function(){function p(d,l){l===void 0&&(l=!1),this.deleted=!1;var S,g=d.candidate.split("network-cost ");g[1]&&(S=parseInt(g[1],10)),this.candidateType=d.type,this.ip=d.ip||d.address,this.isRemote=l,this.networkCost=S,this.port=d.port,this.priority=d.priority,this.protocol=d.protocol,this.relatedAddress=d.relatedAddress,this.relatedPort=d.relatedPort,this.tcpType=d.tcpType,this.transportId=d.sdpMid}return p.prototype.toPayload=function(){return{candidate_type:this.candidateType,deleted:this.deleted,ip:this.ip,is_remote:this.isRemote,"network-cost":this.networkCost,port:this.port,priority:this.priority,protocol:this.protocol,related_address:this.relatedAddress,related_port:this.relatedPort,tcp_type:this.tcpType,transport_id:this.transportId}},p}();w.IceCandidate=y},{}],25:[function(O,F,w){Object.defineProperty(w,"__esModule",{value:!0}),w.PeerConnection=w.getMediaEngine=w.enabled=void 0;var y=O("./peerconnection");w.PeerConnection=y.default;var p=O("./rtcpc");function d(){return p.default.test()}w.enabled=d;function l(){return typeof RTCIceGatherer<"u"?"ORTC":"WebRTC"}w.getMediaEngine=l},{"./peerconnection":28,"./rtcpc":29}],26:[function(O,F,w){Object.defineProperty(w,"__esModule",{value:!0});var y=32767,p=typeof window<"u"?window.RTCStatsReport:void 0;function d(m){if(!(this instanceof d))return new d(m);var _=this;Object.defineProperties(this,{_map:{value:m},size:{enumerable:!0,get:function(){return _._map.size}}}),this[Symbol.iterator]=m[Symbol.iterator]}p&&(d.prototype=Object.create(p.prototype),d.prototype.constructor=d),["entries","forEach","get","has","keys","values"].forEach(function(m){d.prototype[m]=function(){for(var _,E=[],I=0;I<arguments.length;I++)E[I]=arguments[I];return(_=this._map)[m].apply(_,E)}}),d.fromArray=function(_){return new d(_.reduce(function(E,I){return E.set(I.id,I),E},new Map))},d.fromRTCStatsResponse=function(_){var E,I=new Map,M=_.result().reduce(function(x,D){var f=D.id;switch(D.type){case"googCertificate":x.set(f,v(D));break;case"datachannel":x.set(f,o(D));break;case"googCandidatePair":r(D,"googActiveConnection")&&(E=f),x.set(f,a(D));break;case"localcandidate":x.set(f,u(D,!1));break;case"remotecandidate":x.set(f,u(D,!0));break;case"ssrc":s(D,"packetsReceived")?x.set("rtp-"+f,h(D)):x.set("rtp-"+f,T(D)),x.set("track-"+f,g(D)),x.set("codec-"+f,S(D));break;case"googComponent":var C=l(D);I.set(C.selectedCandidatePairId,f),x.set(f,l(D));break}return x},new Map);if(E){var R=I.get(E);R&&(M.get(R).dtlsState="connected")}return new d(M)};function l(m){return{bytesReceived:void 0,bytesSent:void 0,dtlsState:void 0,id:m.id,localCertificateId:m.stat("localCertificateId"),remoteCertificateId:m.stat("remoteCertificateId"),rtcpTransportStatsId:void 0,selectedCandidatePairId:m.stat("selectedCandidatePairId"),timestamp:Date.parse(m.timestamp),type:"transport"}}function S(m){return{channels:void 0,clockRate:void 0,id:m.id,implementation:void 0,mimeType:m.stat("mediaType")+"/"+m.stat("googCodecName"),payloadType:void 0,sdpFmtpLine:void 0,timestamp:Date.parse(m.timestamp),type:"codec"}}function g(m){return{audioLevel:s(m,"audioOutputLevel")?e(m,"audioOutputLevel")/y:(e(m,"audioInputLevel")||0)/y,detached:void 0,echoReturnLoss:t(m,"googEchoCancellationReturnLoss"),echoReturnLossEnhancement:t(m,"googEchoCancellationReturnLossEnhancement"),ended:void 0,frameHeight:s(m,"googFrameHeightReceived")?e(m,"googFrameHeightReceived"):e(m,"googFrameHeightSent"),frameWidth:s(m,"googFrameWidthReceived")?e(m,"googFrameWidthReceived"):e(m,"googFrameWidthSent"),framesCorrupted:void 0,framesDecoded:e(m,"framesDecoded"),framesDropped:void 0,framesPerSecond:void 0,framesReceived:void 0,framesSent:e(m,"framesEncoded"),fullFramesLost:void 0,id:m.id,kind:m.stat("mediaType"),partialFramesLost:void 0,remoteSource:void 0,ssrcIds:void 0,timestamp:Date.parse(m.timestamp),trackIdentifier:m.stat("googTrackId"),type:"track"}}function b(m,_){return{associateStatsId:void 0,codecId:"codec-"+m.id,firCount:_?e(m,"googFirsSent"):void 0,id:m.id,isRemote:void 0,mediaType:m.stat("mediaType"),nackCount:_?e(m,"googNacksSent"):e(m,"googNacksReceived"),pliCount:_?e(m,"googPlisSent"):e(m,"googPlisReceived"),qpSum:e(m,"qpSum"),sliCount:void 0,ssrc:m.stat("ssrc"),timestamp:Date.parse(m.timestamp),trackId:"track-"+m.id,transportId:m.stat("transportId")}}function h(m){var _=b(m,!0);return Object.assign(_,{burstDiscardCount:void 0,burstDiscardRate:void 0,burstLossCount:void 0,burstLossRate:void 0,burstPacketsDiscarded:void 0,burstPacketsLost:void 0,bytesReceived:e(m,"bytesReceived"),fractionLost:void 0,framesDecoded:e(m,"framesDecoded"),gapDiscardRate:void 0,gapLossRate:void 0,jitter:i(m.stat("googJitterReceived")),packetsDiscarded:void 0,packetsLost:e(m,"packetsLost"),packetsReceived:e(m,"packetsReceived"),packetsRepaired:void 0,roundTripTime:i(m.stat("googRtt")),type:"inbound-rtp"}),_}function T(m){var _=b(m,!1);return Object.assign(_,{bytesSent:e(m,"bytesSent"),framesEncoded:e(m,"framesEncoded"),packetsSent:e(m,"packetsSent"),remoteTimestamp:void 0,targetBitrate:void 0,type:"outbound-rtp"}),_}function u(m,_){return{candidateType:n(m.stat("candidateType")),deleted:void 0,id:m.id,ip:m.stat("ipAddress"),isRemote:_,port:e(m,"portNumber"),priority:t(m,"priority"),protocol:m.stat("transport"),relayProtocol:void 0,timestamp:Date.parse(m.timestamp),transportId:void 0,type:_?"remote-candidate":"local-candidate",url:void 0}}function a(m){return{availableIncomingBitrate:void 0,availableOutgoingBitrate:void 0,bytesReceived:e(m,"bytesReceived"),bytesSent:e(m,"bytesSent"),consentRequestsSent:e(m,"consentRequestsSent"),currentRoundTripTime:i(m.stat("googRtt")),id:m.id,lastPacketReceivedTimestamp:void 0,lastPacketSentTimestamp:void 0,localCandidateId:m.stat("localCandidateId"),nominated:void 0,priority:void 0,readable:void 0,remoteCandidateId:m.stat("remoteCandidateId"),requestsReceived:e(m,"requestsReceived"),requestsSent:e(m,"requestsSent"),responsesReceived:e(m,"responsesReceived"),responsesSent:e(m,"responsesSent"),retransmissionsReceived:void 0,retransmissionsSent:void 0,state:void 0,timestamp:Date.parse(m.timestamp),totalRoundTripTime:void 0,transportId:m.stat("googChannelId"),type:"candidate-pair",writable:r(m,"googWritable")}}function v(m){return{base64Certificate:m.stat("googDerBase64"),fingerprint:m.stat("googFingerprint"),fingerprintAlgorithm:m.stat("googFingerprintAlgorithm"),id:m.id,issuerCertificateId:m.stat("googIssuerId"),timestamp:Date.parse(m.timestamp),type:"certificate"}}function o(m){return{bytesReceived:void 0,bytesSent:void 0,datachannelid:m.stat("datachannelid"),id:m.id,label:m.stat("label"),messagesReceived:void 0,messagesSent:void 0,protocol:m.stat("protocol"),state:m.stat("state"),timestamp:Date.parse(m.timestamp),transportId:m.stat("transportId"),type:"data-channel"}}function i(m){return isNaN(m)||m===""?void 0:parseInt(m,10)/1e3}function n(m){switch(m){case"peerreflexive":return"prflx";case"serverreflexive":return"srflx";case"host":case"relay":default:return m}}function e(m,_){var E=m.stat(_);return s(m,_)?parseInt(E,10):void 0}function t(m,_){var E=m.stat(_);return s(m,_)?parseFloat(E):void 0}function r(m,_){var E=m.stat(_);return s(m,_)?E==="true"||E===!0:void 0}function s(m,_){var E=m.stat(_);return typeof E<"u"&&E!==""}w.default=d},{}],27:[function(O,F,w){Object.defineProperty(w,"__esModule",{value:!0}),w.isNonNegativeNumber=w.calculate=void 0;var y=94.768;function p(l,S,g){if(typeof l!="number"||typeof S!="number"||typeof g!="number"||!d(l)||!d(S)||!d(g))return null;var b=l+S*2+10,h=0;switch(!0){case b<160:h=y-b/40;break;case b<1e3:h=y-(b-120)/10;break}switch(!0){case g<=h/2.5:h=Math.max(h-g*2.5,6.52);break;default:h=0;break}var T=1+.035*h+7e-6*h*(h-60)*(100-h);return T}w.calculate=p;function d(l){return typeof l=="number"&&!isNaN(l)&&isFinite(l)&&l>=0}w.isNonNegativeNumber=d,w.default={calculate:p,isNonNegativeNumber:d}},{}],28:[function(O,F,w){Object.defineProperty(w,"__esModule",{value:!0});var y=O("../errors"),p=O("../log"),d=O("../util"),l=O("./rtcpc"),S=O("./sdp"),g=15e3,b="none",h="timeout",T="new",u=50;function a(e,t,r,s){if(!e||!t||!r)throw new y.InvalidArgumentError("Audiohelper, pstream and getUserMedia are required arguments");if(!(this instanceof a))return new a(e,t,r,s);this._log=p.default.getInstance();function m(){this._log.warn("Unexpected noop call in peerconnection")}this.onaudio=m,this.onopen=m,this.onerror=m,this.onclose=m,this.ondisconnected=m,this.onfailed=m,this.onconnected=m,this.onreconnected=m,this.onsignalingstatechange=m,this.ondtlstransportstatechange=m,this.onicegatheringfailure=m,this.onicegatheringstatechange=m,this.oniceconnectionstatechange=m,this.onpcconnectionstatechange=m,this.onicecandidate=m,this.onselectedcandidatepairchange=m,this.onvolume=m,this.version=null,this.pstream=t,this.stream=null,this.sinkIds=new Set(["default"]),this.outputs=new Map,this.status="connecting",this.callSid=null,this.isMuted=!1,this.getUserMedia=r;var _=typeof window<"u"&&(window.AudioContext||window.webkitAudioContext);return this._isSinkSupported=!!_&&typeof HTMLAudioElement<"u"&&HTMLAudioElement.prototype.setSinkId,this._audioContext=_&&e._audioContext,this._hasIceCandidates=!1,this._hasIceGatheringFailures=!1,this._iceGatheringTimeoutId=null,this._masterAudio=null,this._masterAudioDeviceId=null,this._mediaStreamSource=null,this._dtmfSender=null,this._dtmfSenderUnsupported=!1,this._callEvents=[],this._nextTimeToPublish=Date.now(),this._onAnswerOrRinging=m,this._onHangup=m,this._remoteStream=null,this._shouldManageStream=!0,this._iceState=T,this._isUnifiedPlan=s.isUnifiedPlan,this.options=s=s||{},this.navigator=s.navigator||(typeof navigator<"u"?navigator:null),this.util=s.util||d,this.codecPreferences=s.codecPreferences,this}a.prototype.uri=function(){return this._uri},a.prototype.openWithConstraints=function(e){return this.getUserMedia({audio:e}).then(this._setInputTracksFromStream.bind(this,!1))},a.prototype.setInputTracksFromStream=function(e){var t=this;return this._setInputTracksFromStream(!0,e).then(function(){t._shouldManageStream=!1})},a.prototype._createAnalyser=function(e,t){t=Object.assign({fftSize:32,smoothingTimeConstant:.3},t);var r=e.createAnalyser();for(var s in t)r[s]=t[s];return r},a.prototype._setVolumeHandler=function(e){this.onvolume=e},a.prototype._startPollingVolume=function(){if(!(!this._audioContext||!this.stream||!this._remoteStream)){var e=this._audioContext,t=this._inputAnalyser=this._createAnalyser(e),r=t.frequencyBinCount,s=new Uint8Array(r);this._inputAnalyser2=this._createAnalyser(e,{maxDecibels:0,minDecibels:-127,smoothingTimeConstant:0});var m=this._outputAnalyser=this._createAnalyser(e),_=m.frequencyBinCount,E=new Uint8Array(_);this._outputAnalyser2=this._createAnalyser(e,{maxDecibels:0,minDecibels:-127,smoothingTimeConstant:0}),this._updateInputStreamSource(this.stream),this._updateOutputStreamSource(this._remoteStream);var I=this;setTimeout(function M(){if(I._audioContext){if(I.status==="closed"){I._inputAnalyser.disconnect(),I._outputAnalyser.disconnect(),I._inputAnalyser2.disconnect(),I._outputAnalyser2.disconnect();return}}else return;I._inputAnalyser.getByteFrequencyData(s);var R=I.util.average(s);I._inputAnalyser2.getByteFrequencyData(s);var x=I.util.average(s);I._outputAnalyser.getByteFrequencyData(E);var D=I.util.average(E);I._outputAnalyser2.getByteFrequencyData(E);var f=I.util.average(E);I.onvolume(R/255,D/255,x,f),setTimeout(M,u)},u)}},a.prototype._stopStream=function(t){if(this._shouldManageStream)if(typeof MediaStreamTrack.prototype.stop=="function"){var r=typeof t.getAudioTracks=="function"?t.getAudioTracks():t.audioTracks;r.forEach(function(s){s.stop()})}else t.stop()},a.prototype._updateInputStreamSource=function(e){this._inputStreamSource&&this._inputStreamSource.disconnect();try{this._inputStreamSource=this._audioContext.createMediaStreamSource(e),this._inputStreamSource.connect(this._inputAnalyser),this._inputStreamSource.connect(this._inputAnalyser2)}catch(t){this._log.warn("Unable to update input MediaStreamSource",t),this._inputStreamSource=null}},a.prototype._updateOutputStreamSource=function(e){this._outputStreamSource&&this._outputStreamSource.disconnect();try{this._outputStreamSource=this._audioContext.createMediaStreamSource(e),this._outputStreamSource.connect(this._outputAnalyser),this._outputStreamSource.connect(this._outputAnalyser2)}catch(t){this._log.warn("Unable to update output MediaStreamSource",t),this._outputStreamSource=null}},a.prototype._setInputTracksFromStream=function(e,t){return this._isUnifiedPlan?this._setInputTracksForUnifiedPlan(e,t):this._setInputTracksForPlanB(e,t)},a.prototype._setInputTracksForPlanB=function(e,t){var r=this;if(!t)return Promise.reject(new y.InvalidArgumentError("Can not set input stream to null while in a call"));if(!t.getAudioTracks().length)return Promise.reject(new y.InvalidArgumentError("Supplied input stream has no audio tracks"));var s=this.stream;return s?(this._stopStream(s),i(this.version.pc,s),s.getAudioTracks().forEach(s.removeTrack,s),t.getAudioTracks().forEach(s.addTrack,s),v(this.version.pc,t),this._updateInputStreamSource(this.stream)):this.stream=e?o(t):t,this.mute(this.isMuted),this.version?new Promise(function(m,_){r.version.createOffer(r.options.maxAverageBitrate,r.codecPreferences,{audio:!0},function(){r.version.processAnswer(r.codecPreferences,r._answerSdp,function(){m(r.stream)},_)},_)}):Promise.resolve(this.stream)},a.prototype._setInputTracksForUnifiedPlan=function(e,t){var r=this;if(!t)return Promise.reject(new y.InvalidArgumentError("Can not set input stream to null while in a call"));if(!t.getAudioTracks().length)return Promise.reject(new y.InvalidArgumentError("Supplied input stream has no audio tracks"));var s=this.stream,m=function(){return r.mute(r.isMuted),Promise.resolve(r.stream)};if(!s)this.stream=e?o(t):t;else return this._shouldManageStream&&this._stopStream(s),this._sender||(this._sender=this.version.pc.getSenders()[0]),this._sender.replaceTrack(t.getAudioTracks()[0]).then(function(){return r._updateInputStreamSource(t),m()});return m()},a.prototype._onInputDevicesChanged=function(){if(this.stream){var e=this.stream.getAudioTracks().every(function(t){return t.readyState==="ended"});e&&this._shouldManageStream&&this.openWithConstraints(!0)}},a.prototype._onIceGatheringFailure=function(e){this._hasIceGatheringFailures=!0,this.onicegatheringfailure(e)},a.prototype._onMediaConnectionStateChange=function(e){var t=this._iceState;if(!(t===e||e!=="connected"&&e!=="disconnected"&&e!=="failed")){this._iceState=e;var r;switch(e){case"connected":t==="disconnected"||t==="failed"?(r="ICE liveliness check succeeded. Connection with Twilio restored",this._log.info(r),this.onreconnected(r)):(r="Media connection established.",this._log.info(r),this.onconnected(r)),this._stopIceGatheringTimeout(),this._hasIceGatheringFailures=!1;break;case"disconnected":r="ICE liveliness check failed. May be having trouble connecting to Twilio",this._log.info(r),this.ondisconnected(r);break;case"failed":r="Connection with Twilio was interrupted.",this._log.info(r),this.onfailed(r);break}}},a.prototype._setSinkIds=function(e){return this._isSinkSupported?(this.sinkIds=new Set(e.forEach?e:[e]),this.version?this._updateAudioOutputs():Promise.resolve()):Promise.reject(new y.NotSupportedError("Audio output selection is not supported by this browser"))},a.prototype._startIceGatheringTimeout=function(){var t=this;this._stopIceGatheringTimeout(),this._iceGatheringTimeoutId=setTimeout(function(){t._onIceGatheringFailure(h)},g)},a.prototype._stopIceGatheringTimeout=function(){clearInterval(this._iceGatheringTimeoutId)},a.prototype._updateAudioOutputs=function(){var t=Array.from(this.sinkIds).filter(function(_){return!this.outputs.has(_)},this),r=Array.from(this.outputs.keys()).filter(function(_){return!this.sinkIds.has(_)},this),s=this,m=t.map(this._createAudioOutput,this);return Promise.all(m).then(function(){return Promise.all(r.map(s._removeAudioOutput,s))})},a.prototype._createAudio=function(t){var r=new Audio(t);return this.onaudio(r),r},a.prototype._createAudioOutput=function(t){var r=null;this._mediaStreamSource&&(r=this._audioContext.createMediaStreamDestination(),this._mediaStreamSource.connect(r));var s=this._createAudio();n(s,r&&r.stream?r.stream:this.pcStream);var m=this;return s.setSinkId(t).then(function(){return s.play()}).then(function(){m.outputs.set(t,{audio:s,dest:r})})},a.prototype._removeAudioOutputs=function(){return this._masterAudio&&typeof this._masterAudioDeviceId<"u"&&(this._disableOutput(this,this._masterAudioDeviceId),this.outputs.delete(this._masterAudioDeviceId),this._masterAudioDeviceId=null,this._masterAudio.paused||this._masterAudio.pause(),typeof this._masterAudio.srcObject<"u"?this._masterAudio.srcObject=null:this._masterAudio.src="",this._masterAudio=null),Array.from(this.outputs.keys()).map(this._removeAudioOutput,this)},a.prototype._disableOutput=function(t,r){var s=t.outputs.get(r);s&&(s.audio&&(s.audio.pause(),s.audio.src=""),s.dest&&s.dest.disconnect())},a.prototype._reassignMasterOutput=function(t,r){var s=t.outputs.get(r);t.outputs.delete(r);var m=this,_=Array.from(t.outputs.keys())[0]||"default";return s.audio.setSinkId(_).then(function(){m._disableOutput(t,_),t.outputs.set(_,s),t._masterAudioDeviceId=_}).catch(function(){t.outputs.set(r,s),m._log.info("Could not reassign master output. Attempted to roll back.")})},a.prototype._removeAudioOutput=function(t){return this._masterAudioDeviceId===t?this._reassignMasterOutput(this,t):(this._disableOutput(this,t),this.outputs.delete(t),Promise.resolve())},a.prototype._onAddTrack=function(t,r){var s=t._masterAudio=this._createAudio();n(s,r),s.play();var m=Array.from(t.outputs.keys())[0]||"default";t._masterAudioDeviceId=m,t.outputs.set(m,{audio:s});try{t._mediaStreamSource=t._audioContext.createMediaStreamSource(r)}catch(_){this._log.warn("Unable to create a MediaStreamSource from onAddTrack",_),this._mediaStreamSource=null}t.pcStream=r,t._updateAudioOutputs()},a.prototype._fallbackOnAddTrack=function(t,r){var s=document&&document.createElement("audio");s.autoplay=!0,n(s,r)||t._log.info("Error attaching stream to element."),t.outputs.set("default",{audio:s})},a.prototype._setEncodingParameters=function(e){if(!(!e||!this._sender||typeof this._sender.getParameters!="function"||typeof this._sender.setParameters!="function")){var t=this._sender.getParameters();!t.priority&&!(t.encodings&&t.encodings.length)||(t.priority="high",t.encodings&&t.encodings.length&&t.encodings.forEach(function(r){r.priority="high",r.networkPriority="high"}),this._sender.setParameters(t))}},a.prototype._setupPeerConnection=function(e,t){var r=this,s=this,m=new(this.options.rtcpcFactory||l.default)({RTCPeerConnection:this.options.RTCPeerConnection});m.create(e,t),v(m.pc,this.stream);var _="ontrack"in m.pc?"ontrack":"onaddstream";return m.pc[_]=function(E){var I=s._remoteStream=E.stream||E.streams[0];typeof m.pc.getSenders=="function"&&(r._sender=m.pc.getSenders()[0]),s._isSinkSupported?s._onAddTrack(s,I):s._fallbackOnAddTrack(s,I),s._startPollingVolume()},m},a.prototype._maybeSetIceAggressiveNomination=function(e){return this.options.forceAggressiveIceNomination?S.setIceAggressiveNomination(e):e},a.prototype._setupChannel=function(){var e=this,t=this.version.pc;this.version.pc.onopen=function(){e.status="open",e.onopen()},this.version.pc.onstatechange=function(){e.version.pc&&e.version.pc.readyState==="stable"&&(e.status="open",e.onopen())},this.version.pc.onsignalingstatechange=function(){var r=t.signalingState;e._log.info('signalingState is "'+r+'"'),e.version.pc&&e.version.pc.signalingState==="stable"&&(e.status="open",e.onopen()),e.onsignalingstatechange(t.signalingState)},t.onconnectionstatechange=function(r){var s=t.connectionState;if(!s&&r&&r.target){var m=r.target;s=m.connectionState||m.connectionState_,e._log.info("pc.connectionState not detected. Using target PC. State="+s)}s?e._log.info('pc.connectionState is "'+s+'"'):e._log.warn('onconnectionstatechange detected but state is "'+s+'"'),e.onpcconnectionstatechange(s),e._onMediaConnectionStateChange(s)},t.onicecandidate=function(r){var s=r.candidate;s&&(e._hasIceCandidates=!0,e.onicecandidate(s),e._setupRTCIceTransportListener()),e._log.info("ICE Candidate: "+JSON.stringify(s))},t.onicegatheringstatechange=function(){var r=t.iceGatheringState;r==="gathering"?e._startIceGatheringTimeout():r==="complete"&&(e._stopIceGatheringTimeout(),e._hasIceCandidates||e._onIceGatheringFailure(b),e._hasIceCandidates&&e._hasIceGatheringFailures&&e._startIceGatheringTimeout()),e._log.info('pc.iceGatheringState is "'+t.iceGatheringState+'"'),e.onicegatheringstatechange(r)},t.oniceconnectionstatechange=function(){e._log.info('pc.iceConnectionState is "'+t.iceConnectionState+'"'),e.oniceconnectionstatechange(t.iceConnectionState),e._onMediaConnectionStateChange(t.iceConnectionState)}},a.prototype._initializeMediaStream=function(e,t){return this.status==="open"?!1:this.pstream.status==="disconnected"?(this.onerror({info:{code:31e3,message:"Cannot establish connection. Client is disconnected",twilioError:new y.SignalingErrors.ConnectionDisconnected}}),this.close(),!1):(this.version=this._setupPeerConnection(e,t),this._setupChannel(),!0)},a.prototype._removeReconnectionListeners=function(){this.pstream&&(this.pstream.removeListener("answer",this._onAnswerOrRinging),this.pstream.removeListener("hangup",this._onHangup))},a.prototype._setupRTCDtlsTransportListener=function(){var e=this,t=this.getRTCDtlsTransport();if(!(!t||t.onstatechange)){var r=function(){e._log.info('dtlsTransportState is "'+t.state+'"'),e.ondtlstransportstatechange(t.state)};r(),t.onstatechange=r}},a.prototype._setupRTCIceTransportListener=function(){var e=this,t=this._getRTCIceTransport();!t||t.onselectedcandidatepairchange||(t.onselectedcandidatepairchange=function(){return e.onselectedcandidatepairchange(t.getSelectedCandidatePair())})},a.prototype.iceRestart=function(){var e=this;this._log.info("Attempting to restart ICE..."),this._hasIceCandidates=!1,this.version.createOffer(this.options.maxAverageBitrate,this.codecPreferences,{iceRestart:!0}).then(function(){e._removeReconnectionListeners(),e._onAnswerOrRinging=function(t){if(e._removeReconnectionListeners(),!t.sdp||e.version.pc.signalingState!=="have-local-offer"){var r="Invalid state or param during ICE Restart:"+("hasSdp:"+!!t.sdp+", signalingState:"+e.version.pc.signalingState);e._log.info(r);return}var s=e._maybeSetIceAggressiveNomination(t.sdp);e._answerSdp=s,e.status!=="closed"&&e.version.processAnswer(e.codecPreferences,s,null,function(m){var _=m&&m.message?m.message:m;e._log.info("Failed to process answer during ICE Restart. Error: "+_)})},e._onHangup=function(){e._log.info("Received hangup during ICE Restart"),e._removeReconnectionListeners()},e.pstream.on("answer",e._onAnswerOrRinging),e.pstream.on("hangup",e._onHangup),e.pstream.reinvite(e.version.getSDP(),e.callSid)}).catch(function(t){var r=t&&t.message?t.message:t;e._log.info("Failed to createOffer during ICE Restart. Error: "+r),e.onfailed(r)})},a.prototype.makeOutgoingCall=function(e,t,r,s,m,_){var E=this;if(!this._initializeMediaStream(s,m))return;var I=this;this.callSid=r;function M(){I.options&&I._setEncodingParameters(I.options.dscp),_(I.version.pc)}function R(f){var C=f.message||f;I.onerror({info:{code:31e3,message:"Error processing answer: "+C,twilioError:new y.MediaErrors.ClientRemoteDescFailed}})}this._onAnswerOrRinging=function(f){if(f.sdp){var C=E._maybeSetIceAggressiveNomination(f.sdp);I._answerSdp=C,I.status!=="closed"&&I.version.processAnswer(E.codecPreferences,C,M,R),I.pstream.removeListener("answer",I._onAnswerOrRinging),I.pstream.removeListener("ringing",I._onAnswerOrRinging)}},this.pstream.on("answer",this._onAnswerOrRinging),this.pstream.on("ringing",this._onAnswerOrRinging);function x(){I.status!=="closed"&&(I.pstream.invite(I.version.getSDP(),I.callSid,I.options.preflight,t),I._setupRTCDtlsTransportListener())}function D(f){var C=f.message||f;I.onerror({info:{code:31e3,message:"Error creating the offer: "+C,twilioError:new y.MediaErrors.ClientLocalDescFailed}})}this.version.createOffer(this.options.maxAverageBitrate,this.codecPreferences,{audio:!0},x,D)},a.prototype.answerIncomingCall=function(e,t,r,s,m){if(!this._initializeMediaStream(r,s))return;t=this._maybeSetIceAggressiveNomination(t),this._answerSdp=t.replace(/^a=setup:actpass$/gm,"a=setup:passive"),this.callSid=e;var _=this;function E(){_.status!=="closed"&&(_.pstream.answer(_.version.getSDP(),e),_.options&&_._setEncodingParameters(_.options.dscp),m(_.version.pc),_._setupRTCDtlsTransportListener())}function I(M){var R=M.message||M;_.onerror({info:{code:31e3,message:"Error creating the answer: "+R,twilioError:new y.MediaErrors.ClientRemoteDescFailed}})}this.version.processSDP(this.options.maxAverageBitrate,this.codecPreferences,t,{audio:!0},E,I)},a.prototype.close=function(){this.version&&this.version.pc&&(this.version.pc.signalingState!=="closed"&&this.version.pc.close(),this.version.pc=null),this.stream&&(this.mute(!1),this._stopStream(this.stream)),this.stream=null,this._removeReconnectionListeners(),this._stopIceGatheringTimeout(),Promise.all(this._removeAudioOutputs()).catch(function(){}),this._mediaStreamSource&&this._mediaStreamSource.disconnect(),this._inputAnalyser&&this._inputAnalyser.disconnect(),this._outputAnalyser&&this._outputAnalyser.disconnect(),this._inputAnalyser2&&this._inputAnalyser2.disconnect(),this._outputAnalyser2&&this._outputAnalyser2.disconnect(),this.status="closed",this.onclose()},a.prototype.reject=function(e){this.callSid=e},a.prototype.ignore=function(e){this.callSid=e},a.prototype.mute=function(e){if(this.isMuted=e,!!this.stream)if(this._sender&&this._sender.track)this._sender.track.enabled=!e;else{var t=typeof this.stream.getAudioTracks=="function"?this.stream.getAudioTracks():this.stream.audioTracks;t.forEach(function(r){r.enabled=!e})}},a.prototype.getOrCreateDTMFSender=function(){if(this._dtmfSender||this._dtmfSenderUnsupported)return this._dtmfSender||null;var t=this,r=this.version.pc;if(!r)return this._log.info("No RTCPeerConnection available to call createDTMFSender on"),null;if(typeof r.getSenders=="function"&&(typeof RTCDTMFSender=="function"||typeof RTCDtmfSender=="function")){var s=r.getSenders().find(function(_){return _.dtmf});if(s)return this._log.info("Using RTCRtpSender#dtmf"),this._dtmfSender=s.dtmf,this._dtmfSender}if(typeof r.createDTMFSender=="function"&&typeof r.getLocalStreams=="function"){var m=r.getLocalStreams().map(function(_){var E=t._getAudioTracks(_);return E&&E[0]})[0];return m?(this._log.info("Creating RTCDTMFSender"),this._dtmfSender=r.createDTMFSender(m),this._dtmfSender):(this._log.info("No local audio MediaStreamTrack available on the RTCPeerConnection to pass to createDTMFSender"),null)}return this._log.info("RTCPeerConnection does not support RTCDTMFSender"),this._dtmfSenderUnsupported=!0,null},a.prototype.getRTCDtlsTransport=function(){var t=this.version&&this.version.pc&&typeof this.version.pc.getSenders=="function"&&this.version.pc.getSenders()[0];return t&&t.transport||null},a.prototype._canStopMediaStreamTrack=function(){return typeof MediaStreamTrack.prototype.stop=="function"},a.prototype._getAudioTracks=function(e){return typeof e.getAudioTracks=="function"?e.getAudioTracks():e.audioTracks},a.prototype._getRTCIceTransport=function(){var t=this.getRTCDtlsTransport();return t&&t.iceTransport||null},a.protocol=function(){return l.default.test()?new l.default:null}();function v(e,t){typeof e.addTrack=="function"?t.getAudioTracks().forEach(function(r){e.addTrack(r,t)}):e.addStream(t)}function o(e){var t=typeof MediaStream<"u"?new MediaStream:new webkitMediaStream;return e.getAudioTracks().forEach(t.addTrack,t),t}function i(e,t){typeof e.removeTrack=="function"?e.getSenders().forEach(function(r){e.removeTrack(r)}):e.removeStream(t)}function n(e,t){if(typeof e.srcObject<"u")e.srcObject=t;else if(typeof e.mozSrcObject<"u")e.mozSrcObject=t;else if(typeof e.src<"u"){var r=e.options.window||window;e.src=(r.URL||r.webkitURL).createObjectURL(t)}else return!1;return!0}a.enabled=l.default.test(),w.default=a},{"../errors":14,"../log":17,"../util":37,"./rtcpc":29,"./sdp":30}],29:[function(O,F,w){(function(y){(function(){Object.defineProperty(w,"__esModule",{value:!0});var p=O("../log"),d=O("../util"),l=O("./sdp"),S=O("rtcpeerconnection-shim");function g(u){if(typeof window>"u"){this.log.info("No RTCPeerConnection implementation available. The window object was not found.");return}u&&u.RTCPeerConnection?this.RTCPeerConnection=u.RTCPeerConnection:d.isLegacyEdge()?this.RTCPeerConnection=new S(typeof window<"u"?window:y):typeof window.RTCPeerConnection=="function"?this.RTCPeerConnection=window.RTCPeerConnection:typeof window.webkitRTCPeerConnection=="function"?this.RTCPeerConnection=webkitRTCPeerConnection:typeof window.mozRTCPeerConnection=="function"?(this.RTCPeerConnection=mozRTCPeerConnection,window.RTCSessionDescription=mozRTCSessionDescription,window.RTCIceCandidate=mozRTCIceCandidate):this.log.info("No RTCPeerConnection implementation available")}g.prototype.create=function(u,a){this.log=p.default.getInstance(),this.pc=new this.RTCPeerConnection(a,u)},g.prototype.createModernConstraints=function(u){if(typeof u>"u")return null;var a=Object.assign({},u);return typeof webkitRTCPeerConnection<"u"&&!d.isLegacyEdge()?(a.mandatory={},typeof u.audio<"u"&&(a.mandatory.OfferToReceiveAudio=u.audio),typeof u.video<"u"&&(a.mandatory.OfferToReceiveVideo=u.video)):(typeof u.audio<"u"&&(a.offerToReceiveAudio=u.audio),typeof u.video<"u"&&(a.offerToReceiveVideo=u.video)),delete a.audio,delete a.video,a},g.prototype.createOffer=function(u,a,v,o,i){var n=this;return v=this.createModernConstraints(v),h(this.pc.createOffer,this.pc)(v).then(function(e){if(!n.pc)return Promise.resolve();var t=l.setMaxAverageBitrate(e.sdp,u);return T(n.pc.setLocalDescription,n.pc)(new RTCSessionDescription({sdp:l.setCodecPreferences(t,a),type:"offer"}))}).then(o,i)},g.prototype.createAnswer=function(u,a,v,o,i){var n=this;return v=this.createModernConstraints(v),h(this.pc.createAnswer,this.pc)(v).then(function(e){if(!n.pc)return Promise.resolve();var t=l.setMaxAverageBitrate(e.sdp,u);return T(n.pc.setLocalDescription,n.pc)(new RTCSessionDescription({sdp:l.setCodecPreferences(t,a),type:"answer"}))}).then(o,i)},g.prototype.processSDP=function(u,a,v,o,i,n){var e=this;v=l.setCodecPreferences(v,a);var t=new RTCSessionDescription({sdp:v,type:"offer"});return T(this.pc.setRemoteDescription,this.pc)(t).then(function(){e.createAnswer(u,a,o,i,n)})},g.prototype.getSDP=function(){return this.pc.localDescription.sdp},g.prototype.processAnswer=function(u,a,v,o){return this.pc?(a=l.setCodecPreferences(a,u),T(this.pc.setRemoteDescription,this.pc)(new RTCSessionDescription({sdp:a,type:"answer"})).then(v,o)):Promise.resolve()},g.test=function(){if(typeof navigator=="object"){var u=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.getUserMedia;if(d.isLegacyEdge(navigator))return!1;if(u&&typeof window.RTCPeerConnection=="function")return!0;if(u&&typeof window.webkitRTCPeerConnection=="function")return!0;if(u&&typeof window.mozRTCPeerConnection=="function"){try{var a=new window.mozRTCPeerConnection;if(typeof a.getLocalStreams!="function")return!1}catch{return!1}return!0}else if(typeof RTCIceGatherer<"u")return!0}return!1};function b(u,a,v,o){return function(){var i=Array.prototype.slice.call(arguments);return new Promise(function(n){var e=u.apply(a,i);if(!o){n(e);return}if(typeof e=="object"&&typeof e.then=="function")n(e);else throw new Error}).catch(function(){return new Promise(function(n,e){u.apply(a,v?[n,e].concat(i):i.concat([n,e]))})})}}function h(u,a){return b(u,a,!0,!0)}function T(u,a){return b(u,a,!1,!1)}w.default=g}).call(this)}).call(this,typeof $<"u"?$:typeof self<"u"?self:typeof window<"u"?window:{})},{"../log":17,"../util":37,"./sdp":30,"rtcpeerconnection-shim":46}],30:[function(O,F,w){Object.defineProperty(w,"__esModule",{value:!0}),w.setMaxAverageBitrate=w.setIceAggressiveNomination=w.setCodecPreferences=w.getPreferredCodecInfo=void 0;var y=O("../util"),p={0:"PCMU",8:"PCMA"},d=111,l=51e4,S=6e3;function g(e){var t=/a=rtpmap:(\d+) (\S+)/m.exec(e)||[null,"",""],r=t[1],s=t[2],m=new RegExp("a=fmtp:"+r+" (\\S+)","m"),_=m.exec(e)||[null,""],E=_[1];return{codecName:s,codecParams:E}}w.getPreferredCodecInfo=g;function b(e){return y.isChrome(window,window.navigator)?e.split(`
`).filter(function(t){return t.indexOf("a=ice-lite")===-1}).join(`
`):e}w.setIceAggressiveNomination=b;function h(e,t){if(typeof t!="number"||t<S||t>l)return e;var r=/a=rtpmap:(\d+) opus/m.exec(e),s=r&&r.length?r[1]:d,m=new RegExp("a=fmtp:"+s),_=e.split(`
`).map(function(E){return m.test(E)?E+(";maxaveragebitrate="+t):E});return _.join(`
`)}w.setMaxAverageBitrate=h;function T(e,t){var r=u(e),s=e.split(`\r
m=`)[0];return[s].concat(r.map(function(m){if(!/^m=(audio|video)/.test(m))return m;var _=m.match(/^m=(audio|video)/)[1],E=a(m),I=v(E,t),M=o(I,m),R=E.get("pcma")||[],x=E.get("pcmu")||[],D=_==="audio"?new Set(R.concat(x)):new Set;return D.has(I[0])?M.replace(/\r\nb=(AS|TIAS):([0-9]+)/g,""):M})).join(`\r
`)}w.setCodecPreferences=T;function u(e,t,r){return e.replace(/\r\n\r\n$/,`\r
`).split(`\r
m=`).slice(1).map(function(s){return"m="+s}).filter(function(s){var m=new RegExp("m="+(t||".*"),"gm"),_=new RegExp("a="+(r||".*"),"gm");return m.test(s)&&_.test(s)})}function a(e){return Array.from(i(e)).reduce(function(t,r){var s=r[0],m=r[1],_=t.get(m)||[];return t.set(m,_.concat(s))},new Map)}function v(e,t){t=t.map(function(_){return _.toLowerCase()});var r=y.flatMap(t,function(_){return e.get(_)||[]}),s=y.difference(Array.from(e.keys()),t),m=y.flatMap(s,function(_){return e.get(_)});return r.concat(m)}function o(e,t){var r=t.split(`\r
`),s=r[0],m=r.slice(1);return s=s.replace(/([0-9]+\s?)+$/,e.join(" ")),[s].concat(m).join(`\r
`)}function i(e){return n(e).reduce(function(t,r){var s=new RegExp("a=rtpmap:"+r+" ([^/]+)"),m=e.match(s),_=m?m[1].toLowerCase():p[r]?p[r].toLowerCase():"";return t.set(r,_)},new Map)}function n(e){var t=e.split(`\r
`)[0],r=t.match(/([0-9]+)/g);return r?r.slice(1).map(function(s){return parseInt(s,10)}):[]}},{"../util":37}],31:[function(O,F,w){var y=this&&this.__spreadArrays||function(){for(var v=0,o=0,i=arguments.length;o<i;o++)v+=arguments[o].length;for(var n=Array(v),e=0,o=0;o<i;o++)for(var t=arguments[o],r=0,s=t.length;r<s;r++,e++)n[e]=t[r];return n};Object.defineProperty(w,"__esModule",{value:!0}),w.getRTCIceCandidateStatsReport=w.getRTCStats=void 0;var p=O("../errors"),d=O("./mockrtcstatsreport"),l="PeerConnection is null",S="WebRTC statistics are unsupported";function g(v,o){return typeof v.get=="function"?v.get(o):v.find(function(i){return i.id===o})}function b(v){if(!v)return Promise.reject(new p.InvalidArgumentError(l));if(typeof v.getStats!="function")return Promise.reject(new p.NotSupportedError(S));var o;try{o=v.getStats()}catch{o=new Promise(function(n){return v.getStats(n)}).then(d.default.fromRTCStatsResponse)}return o}function h(v,o){return o=Object.assign({createRTCSample:a},o),b(v).then(o.createRTCSample)}w.getRTCStats=h;function T(v){return b(v).then(function(o){var i=Array.from(o.values()).reduce(function(_,E){switch(["candidatePairs","localCandidates","remoteCandidates"].forEach(function(I){_[I]||(_[I]=[])}),E.type){case"candidate-pair":_.candidatePairs.push(E);break;case"local-candidate":_.localCandidates.push(E);break;case"remote-candidate":_.remoteCandidates.push(E);break;case"transport":E.selectedCandidatePairId&&(_.transport=E);break}return _},{}),n=i.candidatePairs,e=i.localCandidates,t=i.remoteCandidates,r=i.transport,s=n.find(function(_){return _.selected||r&&_.id===r.selectedCandidatePairId}),m;return s&&(m={localCandidate:e.find(function(_){return _.id===s.localCandidateId}),remoteCandidate:t.find(function(_){return _.id===s.remoteCandidateId})}),{iceCandidateStats:y(e,t),selectedIceCandidatePairStats:m}})}w.getRTCIceCandidateStatsReport=T;function u(){}function a(v){var o=null,i=new u,n;Array.from(v.values()).forEach(function(m){if(!m.isRemote){var _=m.type.replace("-","");if(n=n||m.timestamp,m.remoteId){var E=g(v,m.remoteId);E&&E.roundTripTime&&(i.rtt=E.roundTripTime*1e3)}switch(_){case"inboundrtp":i.timestamp=i.timestamp||m.timestamp,i.jitter=m.jitter*1e3,i.packetsLost=m.packetsLost,i.packetsReceived=m.packetsReceived,i.bytesReceived=m.bytesReceived;break;case"outboundrtp":if(i.timestamp=m.timestamp,i.packetsSent=m.packetsSent,i.bytesSent=m.bytesSent,m.codecId){var I=g(v,m.codecId);i.codecName=I?I.mimeType&&I.mimeType.match(/(.*\/)?(.*)/)[2]:m.codecId}break;case"transport":o=m.id;break}}}),i.timestamp||(i.timestamp=n);var e=g(v,o);if(!e)return i;var t=g(v,e.selectedCandidatePairId);if(!t)return i;var r=g(v,t.localCandidateId),s=g(v,t.remoteCandidateId);return i.rtt||(i.rtt=t&&t.currentRoundTripTime*1e3),Object.assign(i,{localAddress:r&&(r.address||r.ip),remoteAddress:s&&(s.address||s.ip)}),i}},{"../errors":14,"./mockrtcstatsreport":26}],32:[function(O,F,w){Object.defineProperty(w,"__esModule",{value:!0});var y=O("events");function p(){Object.defineProperties(this,{_eventEmitter:{value:new y.EventEmitter},_handlers:{value:{}}})}p.prototype.dispatchEvent=function(l){return this._eventEmitter.emit(l.type,l)},p.prototype.addEventListener=function(){var l;return(l=this._eventEmitter).addListener.apply(l,arguments)},p.prototype.removeEventListener=function(){var l;return(l=this._eventEmitter).removeListener.apply(l,arguments)},p.prototype._defineEventHandler=function(l){var S=this;Object.defineProperty(this,"on"+l,{get:function(){return S._handlers[l]},set:function(g){var b=S._handlers[l];b&&(typeof g=="function"||typeof g>"u"||g===null)&&(S._handlers[l]=null,S.removeEventListener(l,b)),typeof g=="function"&&(S._handlers[l]=g,S.addEventListener(l,g))}})},w.default=p},{events:40}],33:[function(O,F,w){Object.defineProperty(w,"__esModule",{value:!0});var y=function(){function p(d){Object.defineProperties(this,{deviceId:{get:function(){return d.deviceId}},groupId:{get:function(){return d.groupId}},kind:{get:function(){return d.kind}},label:{get:function(){return d.label}}})}return p}();w.default=y},{}],34:[function(O,F,w){var y=this&&this.__extends||function(){var i=function(n,e){return i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,r){t.__proto__=r}||function(t,r){for(var s in r)Object.prototype.hasOwnProperty.call(r,s)&&(t[s]=r[s])},i(n,e)};return function(n,e){i(n,e);function t(){this.constructor=n}n.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}}();Object.defineProperty(w,"__esModule",{value:!0});var p=O("./eventtarget"),d=500,l=null,S=function(i){y(n,i);function n(){var e=i.call(this)||this;e._defineEventHandler("devicechange"),e._defineEventHandler("deviceinfochange");var t=[];return Object.defineProperties(e,{_deviceChangeIsNative:{value:a(e,"devicechange")},_deviceInfoChangeIsNative:{value:a(e,"deviceinfochange")},_knownDevices:{value:t},_pollInterval:{value:null,writable:!0}}),typeof l.enumerateDevices=="function"&&l.enumerateDevices().then(function(r){r.sort(v).forEach(function(s){return t.push(s)})}),e._eventEmitter.on("newListener",(function(s){s!=="devicechange"&&s!=="deviceinfochange"||(this._pollInterval=this._pollInterval||setInterval(T.bind(null,this),d))}).bind(e)),e._eventEmitter.on("removeListener",(function(){this._pollInterval&&!h(this)&&(clearInterval(this._pollInterval),this._pollInterval=null)}).bind(e)),e}return n}(p.default);S.prototype.enumerateDevices=function(){return l&&typeof l.enumerateDevices=="function"?l.enumerateDevices.apply(l,arguments):null},S.prototype.getUserMedia=function(){return l.getUserMedia.apply(l,arguments)};function g(i,n){if(i=i.filter(function(t){return t.kind==="audioinput"||t.kind==="audiooutput"}),n=n.filter(function(t){return t.kind==="audioinput"||t.kind==="audiooutput"}),n.some(function(t){return!t.deviceId})&&i.some(function(t){return!!t.deviceId}))return!0;var e=n.reduce(function(t,r){return t.set(r.deviceId+"-"+r.kind,r.label)},new Map);return i.some(function(t){var r=e.get(t.deviceId+"-"+t.kind);return typeof r<"u"&&r!==t.label})}function b(i,n){return i.length!==n.length||u("deviceId",i,n)}function h(i){return["devicechange","deviceinfochange"].reduce(function(n,e){return n+i._eventEmitter.listenerCount(e)},0)>0}function T(i){l.enumerateDevices().then(function(n){var e=i._knownDevices,t=e.slice();[].splice.apply(e,[0,e.length].concat(n.sort(v))),!i._deviceChangeIsNative&&b(e,t)&&i.dispatchEvent(new Event("devicechange")),!i._deviceInfoChangeIsNative&&g(e,t)&&i.dispatchEvent(new Event("deviceinfochange"))})}function u(i,n,e){return n.some(function(t,r){return t[i]!==e[r][i]})}function a(i,n){var e="on"+n;function t(r){i.dispatchEvent(r)}return e in l?("addEventListener"in l?l.addEventListener(n,t):l[e]=t,!0):!1}function v(i,n){return i.deviceId<n.deviceId}var o=function(){return l=typeof navigator<"u"?navigator.mediaDevices:null,l?new S:null};w.default=o},{"./eventtarget":32}],35:[function(O,F,w){Object.defineProperty(w,"__esModule",{value:!0});var y=O("./asyncQueue"),p=O("./audioplayer/audioplayer"),d=O("./errors");function l(g,b,h){if(!(this instanceof l))return new l(g,b,h);if(!g||!b)throw new d.InvalidArgumentError("name and url are required arguments");h=Object.assign({AudioFactory:typeof Audio<"u"?Audio:null,maxDuration:0,shouldLoop:!1},h),h.AudioPlayer=h.audioContext?p.default.bind(p.default,h.audioContext):h.AudioFactory,Object.defineProperties(this,{_Audio:{value:h.AudioPlayer},_activeEls:{value:new Map},_isSinkSupported:{value:h.AudioFactory!==null&&typeof h.AudioFactory.prototype.setSinkId=="function"},_maxDuration:{value:h.maxDuration},_maxDurationTimeout:{value:null,writable:!0},_operations:{value:new y.AsyncQueue},_playPromise:{value:null,writable:!0},_shouldLoop:{value:h.shouldLoop},_sinkIds:{value:["default"]},isPlaying:{enumerable:!0,get:function(){return!!this._playPromise}},name:{enumerable:!0,value:g},url:{enumerable:!0,value:b}}),this._Audio&&this._play(!0,!1)}function S(g){g&&(g.pause(),g.src="",g.srcObject=null,g.load())}l.prototype._playAudioElement=function(b,h,T){var u=this,a=this._activeEls.get(b);if(!a)throw new d.InvalidArgumentError('sinkId: "'+b+`" doesn't have an audio element`);return a.muted=!!h,a.loop=!!T,a.play().then(function(){return a}).catch(function(v){throw S(a),u._activeEls.delete(b),v})},l.prototype._play=function(b,h){this.isPlaying&&this._stop(),this._maxDuration>0&&(this._maxDurationTimeout=setTimeout(this._stop.bind(this),this._maxDuration)),h=typeof h=="boolean"?h:this._shouldLoop;var T=this,u=this._playPromise=Promise.all(this._sinkIds.map(function(v){if(!T._Audio)return Promise.resolve();var o=T._activeEls.get(v);return o?T._playAudioElement(v,b,h):(o=new T._Audio(T.url),typeof o.setAttribute=="function"&&o.setAttribute("crossorigin","anonymous"),new Promise(function(i){o.addEventListener("canplaythrough",i)}).then(function(){return(T._isSinkSupported?o.setSinkId(v):Promise.resolve()).then(function(){return T._activeEls.set(v,o),T._playPromise?T._playAudioElement(v,b,h):Promise.resolve()})}))}));return u},l.prototype._stop=function(){var b=this;this._activeEls.forEach(function(h,T){b._sinkIds.includes(T)?(h.pause(),h.currentTime=0):(S(h),b._activeEls.delete(T))}),clearTimeout(this._maxDurationTimeout),this._playPromise=null,this._maxDurationTimeout=null},l.prototype.setSinkIds=function(b){this._isSinkSupported&&(b=b.forEach?b:[b],[].splice.apply(this._sinkIds,[0,this._sinkIds.length].concat(b)))},l.prototype.stop=function(){var b=this;this._operations.enqueue(function(){return b._stop(),Promise.resolve()})},l.prototype.play=function(){var b=this;return this._operations.enqueue(function(){return b._play()})},w.default=l},{"./asyncQueue":2,"./audioplayer/audioplayer":4,"./errors":14}],36:[function(O,F,w){var y=this&&this.__extends||function(){var m=function(_,E){return m=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(I,M){I.__proto__=M}||function(I,M){for(var R in M)Object.prototype.hasOwnProperty.call(M,R)&&(I[R]=M[R])},m(_,E)};return function(_,E){m(_,E);function I(){this.constructor=_}_.prototype=E===null?Object.create(E):(I.prototype=E.prototype,new I)}}(),p=this&&this.__assign||function(){return p=Object.assign||function(m){for(var _,E=1,I=arguments.length;E<I;E++){_=arguments[E];for(var M in _)Object.prototype.hasOwnProperty.call(_,M)&&(m[M]=_[M])}return m},p.apply(this,arguments)},d=this&&this.__spreadArrays||function(){for(var m=0,_=0,E=arguments.length;_<E;_++)m+=arguments[_].length;for(var I=Array(m),M=0,_=0;_<E;_++)for(var R=arguments[_],x=0,D=R.length;x<D;x++,M++)I[M]=R[x];return I};Object.defineProperty(w,"__esModule",{value:!0});var l=O("events"),S=O("./errors"),g=O("./rtc/mos"),b=O("./rtc/stats"),h=O("./util"),T=5,u=0,a=3,v=1e3,o=5*1e3,i={audioInputLevel:{minStandardDeviation:327.67,sampleCount:10},audioOutputLevel:{minStandardDeviation:327.67,sampleCount:10},bytesReceived:{clearCount:2,min:1,raiseCount:3,sampleCount:3},bytesSent:{clearCount:2,min:1,raiseCount:3,sampleCount:3},jitter:{max:30},mos:{min:3},packetsLostFraction:[{max:1},{clearValue:1,maxAverage:3,sampleCount:7}],rtt:{max:400}};function n(m,_){return _.reduce(function(E,I){return E+=I>m?1:0},0)}function e(m,_){return _.reduce(function(E,I){return E+=I<m?1:0},0)}function t(m){if(m.length<=0)return null;var _=m.reduce(function(M,R){return M+R},0)/m.length,E=m.map(function(M){return Math.pow(M-_,2)}),I=Math.sqrt(E.reduce(function(M,R){return M+R},0)/E.length);return I}function r(m){return m.reduce(function(_,E){return d(_,E)},[])}var s=function(m){y(_,m);function _(E){var I=m.call(this)||this;I._activeWarnings=new Map,I._currentStreaks=new Map,I._inputVolumes=[],I._outputVolumes=[],I._sampleBuffer=[],I._supplementalSampleBuffers={audioInputLevel:[],audioOutputLevel:[]},I._warningsEnabled=!0,E=E||{},I._getRTCStats=E.getRTCStats||b.getRTCStats,I._mos=E.Mos||g.default,I._peerConnection=E.peerConnection,I._thresholds=p(p({},i),E.thresholds);var M=Object.values(I._thresholds).map(function(R){return R.sampleCount}).filter(function(R){return!!R});return I._maxSampleCount=Math.max.apply(Math,d([T],M)),I._peerConnection&&I.enable(I._peerConnection),I}return _.prototype.addVolumes=function(E,I){this._inputVolumes.push(E),this._outputVolumes.push(I)},_.prototype.disable=function(){return this._sampleInterval&&(clearInterval(this._sampleInterval),delete this._sampleInterval),this},_.prototype.disableWarnings=function(){return this._warningsEnabled&&this._activeWarnings.clear(),this._warningsEnabled=!1,this},_.prototype.enable=function(E){if(E){if(this._peerConnection&&E!==this._peerConnection)throw new S.InvalidArgumentError("Attempted to replace an existing PeerConnection in StatsMonitor.enable");this._peerConnection=E}if(!this._peerConnection)throw new S.InvalidArgumentError("Can not enable StatsMonitor without a PeerConnection");return this._sampleInterval=this._sampleInterval||setInterval(this._fetchSample.bind(this),v),this},_.prototype.enableWarnings=function(){return this._warningsEnabled=!0,this},_.prototype.hasActiveWarning=function(E,I){var M=E+":"+I;return!!this._activeWarnings.get(M)},_.prototype._addSample=function(E){var I=this._sampleBuffer;I.push(E),I.length>this._maxSampleCount&&I.splice(0,I.length-this._maxSampleCount)},_.prototype._clearWarning=function(E,I,M){var R=E+":"+I,x=this._activeWarnings.get(R);!x||Date.now()-x.timeRaised<o||(this._activeWarnings.delete(R),this.emit("warning-cleared",p(p({},M),{name:E,threshold:{name:I,value:this._thresholds[E][I]}})))},_.prototype._createSample=function(E,I){var M=I&&I.totals.bytesSent||0,R=I&&I.totals.bytesReceived||0,x=I&&I.totals.packetsSent||0,D=I&&I.totals.packetsReceived||0,f=I&&I.totals.packetsLost||0,C=E.bytesSent-M,k=E.bytesReceived-R,c=E.packetsSent-x,P=E.packetsReceived-D,U=E.packetsLost-f,B=P+U,A=B>0?U/B*100:0,L=E.packetsReceived+E.packetsLost,j=L>0?E.packetsLost/L*100:100,N=typeof E.rtt=="number"||!I?E.rtt:I.rtt,H=this._inputVolumes.splice(0);this._supplementalSampleBuffers.audioInputLevel.push(H);var G=this._outputVolumes.splice(0);return this._supplementalSampleBuffers.audioOutputLevel.push(G),{audioInputLevel:Math.round(h.average(H)),audioOutputLevel:Math.round(h.average(G)),bytesReceived:k,bytesSent:C,codecName:E.codecName,jitter:E.jitter,mos:this._mos.calculate(N,E.jitter,I&&A),packetsLost:U,packetsLostFraction:A,packetsReceived:P,packetsSent:c,rtt:N,timestamp:E.timestamp,totals:{bytesReceived:E.bytesReceived,bytesSent:E.bytesSent,packetsLost:E.packetsLost,packetsLostFraction:j,packetsReceived:E.packetsReceived,packetsSent:E.packetsSent}}},_.prototype._fetchSample=function(){var E=this;this._getSample().then(function(I){E._addSample(I),E._raiseWarnings(),E.emit("sample",I)}).catch(function(I){E.disable(),E.emit("error",I)})},_.prototype._getSample=function(){var E=this;return this._getRTCStats(this._peerConnection).then(function(I){var M=null;return E._sampleBuffer.length&&(M=E._sampleBuffer[E._sampleBuffer.length-1]),E._createSample(I,M)})},_.prototype._raiseWarning=function(E,I,M){var R=E+":"+I;if(!this._activeWarnings.has(R)){this._activeWarnings.set(R,{timeRaised:Date.now()});var x=this._thresholds[E],D;if(Array.isArray(x)){var f=x.find(function(C){return I in C});f&&(D=f[I])}else D=this._thresholds[E][I];this.emit("warning",p(p({},M),{name:E,threshold:{name:I,value:D}}))}},_.prototype._raiseWarnings=function(){var E=this;this._warningsEnabled&&Object.keys(this._thresholds).forEach(function(I){return E._raiseWarningsForStat(I)})},_.prototype._raiseWarningsForStat=function(E){var I=this,M=Array.isArray(this._thresholds[E])?this._thresholds[E]:[this._thresholds[E]];M.forEach(function(R){var x=I._sampleBuffer,D=R.clearCount||u,f=R.raiseCount||a,C=R.sampleCount||I._maxSampleCount,k=x.slice(-C),c=k.map(function(V){return V[E]}),P=c.some(function(V){return typeof V>"u"||V===null});if(!P){var U;if(typeof R.max=="number"&&(U=n(R.max,c),U>=f?I._raiseWarning(E,"max",{values:c,samples:k}):U<=D&&I._clearWarning(E,"max",{values:c,samples:k})),typeof R.min=="number"&&(U=e(R.min,c),U>=f?I._raiseWarning(E,"min",{values:c,samples:k}):U<=D&&I._clearWarning(E,"min",{values:c,samples:k})),typeof R.maxDuration=="number"&&x.length>1){k=x.slice(-2);var B=k[0][E],A=k[1][E],L=I._currentStreaks.get(E)||0,j=B===A?L+1:0;I._currentStreaks.set(E,j),j>=R.maxDuration?I._raiseWarning(E,"maxDuration",{value:j}):j===0&&I._clearWarning(E,"maxDuration",{value:L})}if(typeof R.minStandardDeviation=="number"){var N=I._supplementalSampleBuffers[E];if(!N||N.length<R.sampleCount)return;N.length>R.sampleCount&&N.splice(0,N.length-R.sampleCount);var H=r(N.slice(-C)),G=t(H);if(typeof G!="number")return;G<R.minStandardDeviation?I._raiseWarning(E,"minStandardDeviation",{value:G}):I._clearWarning(E,"minStandardDeviation",{value:G})}[["maxAverage",function(V,W){return V>W}],["minAverage",function(V,W){return V<W}]].forEach(function(V){var W=V[0],z=V[1];if(typeof R[W]=="number"&&c.length>=C){var q=h.average(c);z(q,R[W])?I._raiseWarning(E,W,{values:c,samples:k}):z(q,R.clearValue||R[W])||I._clearWarning(E,W,{values:c,samples:k})}})}})},_}(l.EventEmitter);w.default=s},{"./errors":14,"./rtc/mos":27,"./rtc/stats":31,"./util":37,events:40}],37:[function(O,F,w){(function(y){(function(){Object.defineProperty(w,"__esModule",{value:!0}),w.flatMap=w.queryToJson=w.isUnifiedPlanDefault=w.isSafari=w.isLegacyEdge=w.isFirefox=w.isChrome=w.isElectron=w.difference=w.average=w.Exception=void 0;function p(i){if(!(this instanceof p))return new p(i);this.message=i}p.prototype.toString=function(){return"Twilio.Exception: "+this.message};function d(i){return i&&i.length?i.reduce(function(n,e){return n+e})/i.length:0}w.average=d;function l(i,n,e){e=e||function(r){return r};var t=new Set(n.map(e));return i.filter(function(r){return!t.has(e(r))})}w.difference=l;function S(i){return!!i.userAgent.match("Electron")}w.isElectron=S;function g(i,n){var e=!!n.userAgent.match("CriOS"),t=!!n.userAgent.match("HeadlessChrome"),r=typeof i.chrome<"u"&&n.vendor==="Google Inc."&&n.userAgent.indexOf("OPR")===-1&&n.userAgent.indexOf("Edge")===-1;return e||S(n)||r||t}w.isChrome=g;function b(i){return i=i||(typeof window>"u"?y.navigator:window.navigator),!!i&&typeof i.userAgent=="string"&&/firefox|fxios/i.test(i.userAgent)}w.isFirefox=b;function h(i){return i=i||(typeof window>"u"?y.navigator:window.navigator),!!i&&typeof i.userAgent=="string"&&/edge\/\d+/i.test(i.userAgent)}w.isLegacyEdge=h;function T(i){return!!i.vendor&&i.vendor.indexOf("Apple")!==-1&&i.userAgent&&i.userAgent.indexOf("CriOS")===-1&&i.userAgent.indexOf("FxiOS")===-1}w.isSafari=T;function u(i,n,e,t){if(typeof i>"u"||typeof n>"u"||typeof e>"u"||typeof t>"u"||typeof e.prototype>"u"||typeof t.prototype>"u")return!1;if(g(i,n)&&e.prototype.addTransceiver){var r=new e,s=!0;try{r.addTransceiver("audio")}catch{s=!1}return r.close(),s}else{if(b(n))return!0;if(T(n))return"currentDirection"in t.prototype}return!1}w.isUnifiedPlanDefault=u;function a(i){return i?i.split("&").reduce(function(n,e){var t=e.split("="),r=t[0],s=decodeURIComponent((t[1]||"").replace(/\+/g,"%20"));return r&&(n[r]=s),n},{}):""}w.queryToJson=a;function v(i,n){var e=i instanceof Map||i instanceof Set?Array.from(i.values()):i;return n=n||function(t){return t},e.reduce(function(t,r){var s=n(r);return t.concat(s)},[])}w.flatMap=v;var o=p;w.Exception=o}).call(this)}).call(this,typeof $<"u"?$:typeof self<"u"?self:typeof window<"u"?window:{})},{}],38:[function(O,F,w){Object.defineProperty(w,"__esModule",{value:!0}),w.generateVoiceEventSid=void 0;var y=O("md5"),p=O("../twilio/errors");function d(){if(typeof window!="object")throw new p.NotSupportedError("This platform is not supported.");var S=window.crypto;if(typeof S!="object")throw new p.NotSupportedError("The `crypto` module is not available on this platform.");if(typeof(S.randomUUID||S.getRandomValues)>"u")throw new p.NotSupportedError("Neither `crypto.randomUUID` or `crypto.getRandomValues` are available on this platform.");var g=window.Uint32Array;if(typeof g>"u")throw new p.NotSupportedError("The `Uint32Array` module is not available on this platform.");var b=typeof S.randomUUID=="function"?function(){return S.randomUUID()}:function(){return S.getRandomValues(new Uint32Array(32)).toString()};return y(b())}function l(){return"KX"+d()}w.generateVoiceEventSid=l},{"../twilio/errors":14,md5:45}],39:[function(O,F,w){var y=this&&this.__extends||function(){var t=function(r,s){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(m,_){m.__proto__=_}||function(m,_){for(var E in _)Object.prototype.hasOwnProperty.call(_,E)&&(m[E]=_[E])},t(r,s)};return function(r,s){t(r,s);function m(){this.constructor=r}r.prototype=s===null?Object.create(s):(m.prototype=s.prototype,new m)}}(),p=this&&this.__assign||function(){return p=Object.assign||function(t){for(var r,s=1,m=arguments.length;s<m;s++){r=arguments[s];for(var _ in r)Object.prototype.hasOwnProperty.call(r,_)&&(t[_]=r[_])}return t},p.apply(this,arguments)};Object.defineProperty(w,"__esModule",{value:!0}),w.WSTransportState=void 0;var d=O("events"),l=O("./backoff"),S=O("./errors"),g=O("./log"),b=globalThis.WebSocket,h=1e4,T=5e3,u=15e3,a=15e3,v=1/0,o=1e3,i=2e4,n;(function(t){t.Connecting="connecting",t.Closed="closed",t.Open="open"})(n=w.WSTransportState||(w.WSTransportState={}));var e=function(t){y(r,t);function r(s,m){m===void 0&&(m={});var _=t.call(this)||this;return _.state=n.Closed,_._backoffStartTime={preferred:null,primary:null},_._connectedUri=null,_._log=g.default.getInstance(),_._shouldFallback=!1,_._uriIndex=0,_._moveUriIndex=function(){_._uriIndex++,_._uriIndex>=_._uris.length&&(_._uriIndex=0)},_._onSocketClose=function(E){if(_._log.info("Received websocket close event code: "+E.code+". Reason: "+E.reason),E.code===1006||E.code===1015){_.emit("error",{code:31005,message:E.reason||"Websocket connection to Twilio's signaling servers were unexpectedly ended. If this is happening consistently, there may be an issue resolving the hostname provided. If a region or an edge is being specified in Device setup, ensure it is valid.",twilioError:new S.SignalingErrors.ConnectionError});var I=_.state===n.Open||_._previousState===n.Open;(_._shouldFallback||!I)&&_._moveUriIndex(),_._shouldFallback=!0}_._closeSocket()},_._onSocketError=function(E){_._log.info("WebSocket received error: "+E.message),_.emit("error",{code:31e3,message:E.message||"WSTransport socket error",twilioError:new S.SignalingErrors.ConnectionDisconnected})},_._onSocketMessage=function(E){if(_._setHeartbeatTimeout(),_._socket&&E.data===`
`){_._socket.send(`
`);return}_.emit("message",E)},_._onSocketOpen=function(){_._log.info("WebSocket opened successfully."),_._timeOpened=Date.now(),_._shouldFallback=!1,_._setState(n.Open),clearTimeout(_._connectTimeout),_._resetBackoffs(),_._setHeartbeatTimeout(),_.emit("open")},_._options=p(p({},r.defaultConstructorOptions),m),_._uris=s,_._backoff=_._setupBackoffs(),_}return r.prototype.close=function(){this._log.info("WSTransport.close() called..."),this._close()},r.prototype.open=function(){if(this._log.info("WSTransport.open() called..."),this._socket&&(this._socket.readyState===b.CONNECTING||this._socket.readyState===b.OPEN)){this._log.info("WebSocket already open.");return}this._preferredUri?this._connect(this._preferredUri):this._connect(this._uris[this._uriIndex])},r.prototype.send=function(s){if(!this._socket||this._socket.readyState!==b.OPEN)return!1;try{this._socket.send(s)}catch(m){return this._log.info("Error while sending message:",m.message),this._closeSocket(),!1}return!0},r.prototype.updatePreferredURI=function(s){this._preferredUri=s},r.prototype.updateURIs=function(s){typeof s=="string"&&(s=[s]),this._uris=s,this._uriIndex=0},r.prototype._close=function(){this._setState(n.Closed),this._closeSocket()},r.prototype._closeSocket=function(){if(clearTimeout(this._connectTimeout),clearTimeout(this._heartbeatTimeout),this._log.info("Closing and cleaning up WebSocket..."),!this._socket){this._log.info("No WebSocket to clean up.");return}this._socket.removeEventListener("close",this._onSocketClose),this._socket.removeEventListener("error",this._onSocketError),this._socket.removeEventListener("message",this._onSocketMessage),this._socket.removeEventListener("open",this._onSocketOpen),(this._socket.readyState===b.CONNECTING||this._socket.readyState===b.OPEN)&&this._socket.close(),this._timeOpened&&Date.now()-this._timeOpened>h&&this._resetBackoffs(),this.state!==n.Closed&&this._performBackoff(),delete this._socket,this.emit("close")},r.prototype._connect=function(s,m){var _=this;this._log.info(typeof m=="number"?"Attempting to reconnect (retry #"+m+")...":"Attempting to connect..."),this._closeSocket(),this._setState(n.Connecting),this._connectedUri=s;try{this._socket=new this._options.WebSocket(this._connectedUri)}catch(E){this._log.info("Could not connect to endpoint:",E.message),this._close(),this.emit("error",{code:31e3,message:E.message||"Could not connect to "+this._connectedUri,twilioError:new S.SignalingErrors.ConnectionDisconnected});return}this._socket.addEventListener("close",this._onSocketClose),this._socket.addEventListener("error",this._onSocketError),this._socket.addEventListener("message",this._onSocketMessage),this._socket.addEventListener("open",this._onSocketOpen),delete this._timeOpened,this._connectTimeout=setTimeout(function(){_._log.info("WebSocket connection attempt timed out."),_._moveUriIndex(),_._closeSocket()},this._options.connectTimeoutMs)},r.prototype._performBackoff=function(){this._preferredUri?(this._log.info("Preferred URI set; backing off."),this._backoff.preferred.backoff()):(this._log.info("Preferred URI not set; backing off."),this._backoff.primary.backoff())},r.prototype._resetBackoffs=function(){this._backoff.preferred.reset(),this._backoff.primary.reset(),this._backoffStartTime.preferred=null,this._backoffStartTime.primary=null},r.prototype._setHeartbeatTimeout=function(){var s=this;clearTimeout(this._heartbeatTimeout),this._heartbeatTimeout=setTimeout(function(){s._log.info("No messages received in "+u/1e3+" seconds. Reconnecting..."),s._shouldFallback=!0,s._closeSocket()},u)},r.prototype._setState=function(s){this._previousState=this.state,this.state=s},r.prototype._setupBackoffs=function(){var s=this,m={factor:2,jitter:.4,max:this._options.maxPreferredDelayMs,min:100};this._log.info("Initializing preferred transport backoff using config: ",m);var _=new l.default(m);_.on("backoff",function(M,R){if(s.state===n.Closed){s._log.info("Preferred backoff initiated but transport state is closed; not attempting a connection.");return}s._log.info("Will attempt to reconnect Websocket to preferred URI in "+R+"ms"),M===0&&(s._backoffStartTime.preferred=Date.now(),s._log.info("Preferred backoff start; "+s._backoffStartTime.preferred))}),_.on("ready",function(M,R){if(s.state===n.Closed){s._log.info("Preferred backoff ready but transport state is closed; not attempting a connection.");return}if(s._backoffStartTime.preferred===null){s._log.info("Preferred backoff start time invalid; not attempting a connection.");return}if(Date.now()-s._backoffStartTime.preferred>s._options.maxPreferredDurationMs){s._log.info("Max preferred backoff attempt time exceeded; falling back to primary backoff."),s._preferredUri=null,s._backoff.primary.backoff();return}if(typeof s._preferredUri!="string"){s._log.info("Preferred URI cleared; falling back to primary backoff."),s._preferredUri=null,s._backoff.primary.backoff();return}s._connect(s._preferredUri,M+1)});var E={factor:2,jitter:.4,max:this._options.maxPrimaryDelayMs,min:this._uris&&this._uris.length>1?Math.floor(Math.random()*4001)+1e3:100};this._log.info("Initializing primary transport backoff using config: ",E);var I=new l.default(E);return I.on("backoff",function(M,R){if(s.state===n.Closed){s._log.info("Primary backoff initiated but transport state is closed; not attempting a connection.");return}s._log.info("Will attempt to reconnect WebSocket in "+R+"ms"),M===0&&(s._backoffStartTime.primary=Date.now(),s._log.info("Primary backoff start; "+s._backoffStartTime.primary))}),I.on("ready",function(M,R){if(s.state===n.Closed){s._log.info("Primary backoff ready but transport state is closed; not attempting a connection.");return}if(s._backoffStartTime.primary===null){s._log.info("Primary backoff start time invalid; not attempting a connection.");return}if(Date.now()-s._backoffStartTime.primary>s._options.maxPrimaryDurationMs){s._log.info("Max primary backoff attempt time exceeded; not attempting a connection.");return}s._connect(s._uris[s._uriIndex],M+1)}),{preferred:_,primary:I}},Object.defineProperty(r.prototype,"uri",{get:function(){return this._connectedUri},enumerable:!1,configurable:!0}),r.defaultConstructorOptions={WebSocket:b,connectTimeoutMs:T,maxPreferredDelayMs:o,maxPreferredDurationMs:a,maxPrimaryDelayMs:i,maxPrimaryDurationMs:v},r}(d.EventEmitter);w.default=e},{"./backoff":7,"./errors":14,"./log":17,events:40}],40:[function(O,F,w){var y=Object.create||E,p=Object.keys||I,d=Function.prototype.bind||M;function l(){(!this._events||!Object.prototype.hasOwnProperty.call(this,"_events"))&&(this._events=y(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0}F.exports=l,l.EventEmitter=l,l.prototype._events=void 0,l.prototype._maxListeners=void 0;var S=10,g;try{var b={};Object.defineProperty&&Object.defineProperty(b,"x",{value:0}),g=b.x===0}catch{g=!1}g?Object.defineProperty(l,"defaultMaxListeners",{enumerable:!0,get:function(){return S},set:function(R){if(typeof R!="number"||R<0||R!==R)throw new TypeError('"defaultMaxListeners" must be a positive number');S=R}}):l.defaultMaxListeners=S,l.prototype.setMaxListeners=function(x){if(typeof x!="number"||x<0||isNaN(x))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=x,this};function h(R){return R._maxListeners===void 0?l.defaultMaxListeners:R._maxListeners}l.prototype.getMaxListeners=function(){return h(this)};function T(R,x,D){if(x)R.call(D);else for(var f=R.length,C=m(R,f),k=0;k<f;++k)C[k].call(D)}function u(R,x,D,f){if(x)R.call(D,f);else for(var C=R.length,k=m(R,C),c=0;c<C;++c)k[c].call(D,f)}function a(R,x,D,f,C){if(x)R.call(D,f,C);else for(var k=R.length,c=m(R,k),P=0;P<k;++P)c[P].call(D,f,C)}function v(R,x,D,f,C,k){if(x)R.call(D,f,C,k);else for(var c=R.length,P=m(R,c),U=0;U<c;++U)P[U].call(D,f,C,k)}function o(R,x,D,f){if(x)R.apply(D,f);else for(var C=R.length,k=m(R,C),c=0;c<C;++c)k[c].apply(D,f)}l.prototype.emit=function(x){var D,f,C,k,c,P,U=x==="error";if(P=this._events,P)U=U&&P.error==null;else if(!U)return!1;if(U){if(arguments.length>1&&(D=arguments[1]),D instanceof Error)throw D;var B=new Error('Unhandled "error" event. ('+D+")");throw B.context=D,B}if(f=P[x],!f)return!1;var A=typeof f=="function";switch(C=arguments.length,C){case 1:T(f,A,this);break;case 2:u(f,A,this,arguments[1]);break;case 3:a(f,A,this,arguments[1],arguments[2]);break;case 4:v(f,A,this,arguments[1],arguments[2],arguments[3]);break;default:for(k=new Array(C-1),c=1;c<C;c++)k[c-1]=arguments[c];o(f,A,this,k)}return!0};function i(R,x,D,f){var C,k,c;if(typeof D!="function")throw new TypeError('"listener" argument must be a function');if(k=R._events,k?(k.newListener&&(R.emit("newListener",x,D.listener?D.listener:D),k=R._events),c=k[x]):(k=R._events=y(null),R._eventsCount=0),!c)c=k[x]=D,++R._eventsCount;else if(typeof c=="function"?c=k[x]=f?[D,c]:[c,D]:f?c.unshift(D):c.push(D),!c.warned&&(C=h(R),C&&C>0&&c.length>C)){c.warned=!0;var P=new Error("Possible EventEmitter memory leak detected. "+c.length+' "'+String(x)+'" listeners added. Use emitter.setMaxListeners() to increase limit.');P.name="MaxListenersExceededWarning",P.emitter=R,P.type=x,P.count=c.length,typeof console=="object"&&console.warn&&console.warn("%s: %s",P.name,P.message)}return R}l.prototype.addListener=function(x,D){return i(this,x,D,!1)},l.prototype.on=l.prototype.addListener,l.prototype.prependListener=function(x,D){return i(this,x,D,!0)};function n(){if(!this.fired)switch(this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length){case 0:return this.listener.call(this.target);case 1:return this.listener.call(this.target,arguments[0]);case 2:return this.listener.call(this.target,arguments[0],arguments[1]);case 3:return this.listener.call(this.target,arguments[0],arguments[1],arguments[2]);default:for(var R=new Array(arguments.length),x=0;x<R.length;++x)R[x]=arguments[x];this.listener.apply(this.target,R)}}function e(R,x,D){var f={fired:!1,wrapFn:void 0,target:R,type:x,listener:D},C=d.call(n,f);return C.listener=D,f.wrapFn=C,C}l.prototype.once=function(x,D){if(typeof D!="function")throw new TypeError('"listener" argument must be a function');return this.on(x,e(this,x,D)),this},l.prototype.prependOnceListener=function(x,D){if(typeof D!="function")throw new TypeError('"listener" argument must be a function');return this.prependListener(x,e(this,x,D)),this},l.prototype.removeListener=function(x,D){var f,C,k,c,P;if(typeof D!="function")throw new TypeError('"listener" argument must be a function');if(C=this._events,!C)return this;if(f=C[x],!f)return this;if(f===D||f.listener===D)--this._eventsCount===0?this._events=y(null):(delete C[x],C.removeListener&&this.emit("removeListener",x,f.listener||D));else if(typeof f!="function"){for(k=-1,c=f.length-1;c>=0;c--)if(f[c]===D||f[c].listener===D){P=f[c].listener,k=c;break}if(k<0)return this;k===0?f.shift():s(f,k),f.length===1&&(C[x]=f[0]),C.removeListener&&this.emit("removeListener",x,P||D)}return this},l.prototype.removeAllListeners=function(x){var D,f,C;if(f=this._events,!f)return this;if(!f.removeListener)return arguments.length===0?(this._events=y(null),this._eventsCount=0):f[x]&&(--this._eventsCount===0?this._events=y(null):delete f[x]),this;if(arguments.length===0){var k=p(f),c;for(C=0;C<k.length;++C)c=k[C],c!=="removeListener"&&this.removeAllListeners(c);return this.removeAllListeners("removeListener"),this._events=y(null),this._eventsCount=0,this}if(D=f[x],typeof D=="function")this.removeListener(x,D);else if(D)for(C=D.length-1;C>=0;C--)this.removeListener(x,D[C]);return this};function t(R,x,D){var f=R._events;if(!f)return[];var C=f[x];return C?typeof C=="function"?D?[C.listener||C]:[C]:D?_(C):m(C,C.length):[]}l.prototype.listeners=function(x){return t(this,x,!0)},l.prototype.rawListeners=function(x){return t(this,x,!1)},l.listenerCount=function(R,x){return typeof R.listenerCount=="function"?R.listenerCount(x):r.call(R,x)},l.prototype.listenerCount=r;function r(R){var x=this._events;if(x){var D=x[R];if(typeof D=="function")return 1;if(D)return D.length}return 0}l.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};function s(R,x){for(var D=x,f=D+1,C=R.length;f<C;D+=1,f+=1)R[D]=R[f];R.pop()}function m(R,x){for(var D=new Array(x),f=0;f<x;++f)D[f]=R[f];return D}function _(R){for(var x=new Array(R.length),D=0;D<x.length;++D)x[D]=R[D].listener||R[D];return x}function E(R){var x=function(){};return x.prototype=R,new x}function I(R){for(var x in R)Object.prototype.hasOwnProperty.call(R,x);return x}function M(R){var x=this;return function(){return x.apply(R,arguments)}}},{}],41:[function(O,F,w){var y={utf8:{stringToBytes:function(p){return y.bin.stringToBytes(unescape(encodeURIComponent(p)))},bytesToString:function(p){return decodeURIComponent(escape(y.bin.bytesToString(p)))}},bin:{stringToBytes:function(p){for(var d=[],l=0;l<p.length;l++)d.push(p.charCodeAt(l)&255);return d},bytesToString:function(p){for(var d=[],l=0;l<p.length;l++)d.push(String.fromCharCode(p[l]));return d.join("")}}};F.exports=y},{}],42:[function(O,F,w){(function(){var y="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",p={rotl:function(d,l){return d<<l|d>>>32-l},rotr:function(d,l){return d<<32-l|d>>>l},endian:function(d){if(d.constructor==Number)return p.rotl(d,8)&16711935|p.rotl(d,24)&4278255360;for(var l=0;l<d.length;l++)d[l]=p.endian(d[l]);return d},randomBytes:function(d){for(var l=[];d>0;d--)l.push(Math.floor(Math.random()*256));return l},bytesToWords:function(d){for(var l=[],S=0,g=0;S<d.length;S++,g+=8)l[g>>>5]|=d[S]<<24-g%32;return l},wordsToBytes:function(d){for(var l=[],S=0;S<d.length*32;S+=8)l.push(d[S>>>5]>>>24-S%32&255);return l},bytesToHex:function(d){for(var l=[],S=0;S<d.length;S++)l.push((d[S]>>>4).toString(16)),l.push((d[S]&15).toString(16));return l.join("")},hexToBytes:function(d){for(var l=[],S=0;S<d.length;S+=2)l.push(parseInt(d.substr(S,2),16));return l},bytesToBase64:function(d){for(var l=[],S=0;S<d.length;S+=3)for(var g=d[S]<<16|d[S+1]<<8|d[S+2],b=0;b<4;b++)S*8+b*6<=d.length*8?l.push(y.charAt(g>>>6*(3-b)&63)):l.push("=");return l.join("")},base64ToBytes:function(d){d=d.replace(/[^A-Z0-9+\/]/gi,"");for(var l=[],S=0,g=0;S<d.length;g=++S%4)g!=0&&l.push((y.indexOf(d.charAt(S-1))&Math.pow(2,-2*g+8)-1)<<g*2|y.indexOf(d.charAt(S))>>>6-g*2);return l}};F.exports=p})()},{}],43:[function(O,F,w){F.exports=function(d){return d!=null&&(y(d)||p(d)||!!d._isBuffer)};function y(d){return!!d.constructor&&typeof d.constructor.isBuffer=="function"&&d.constructor.isBuffer(d)}function p(d){return typeof d.readFloatLE=="function"&&typeof d.slice=="function"&&y(d.slice(0,0))}},{}],44:[function(O,F,w){(function(y,p){typeof F=="object"&&F.exports?F.exports=p():y.log=p()})(this,function(){var y=function(){},p="undefined",d=typeof window!==p&&typeof window.navigator!==p&&/Trident\/|MSIE /.test(window.navigator.userAgent),l=["trace","debug","info","warn","error"];function S(n,e){var t=n[e];if(typeof t.bind=="function")return t.bind(n);try{return Function.prototype.bind.call(t,n)}catch{return function(){return Function.prototype.apply.apply(t,[n,arguments])}}}function g(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function b(n){return n==="debug"&&(n="log"),typeof console===p?!1:n==="trace"&&d?g:console[n]!==void 0?S(console,n):console.log!==void 0?S(console,"log"):y}function h(n,e){for(var t=0;t<l.length;t++){var r=l[t];this[r]=t<n?y:this.methodFactory(r,n,e)}this.log=this.debug}function T(n,e,t){return function(){typeof console!==p&&(h.call(this,e,t),this[n].apply(this,arguments))}}function u(n,e,t){return b(n)||T.apply(this,arguments)}function a(n,e,t){var r=this,s,m="loglevel";n&&(m+=":"+n);function _(M){var R=(l[M]||"silent").toUpperCase();if(typeof window!==p){try{window.localStorage[m]=R;return}catch{}try{window.document.cookie=encodeURIComponent(m)+"="+R+";"}catch{}}}function E(){var M;if(typeof window!==p){try{M=window.localStorage[m]}catch{}if(typeof M===p)try{var R=window.document.cookie,x=R.indexOf(encodeURIComponent(m)+"=");x!==-1&&(M=/^([^;]+)/.exec(R.slice(x))[1])}catch{}return r.levels[M]===void 0&&(M=void 0),M}}r.name=n,r.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},r.methodFactory=t||u,r.getLevel=function(){return s},r.setLevel=function(M,R){if(typeof M=="string"&&r.levels[M.toUpperCase()]!==void 0&&(M=r.levels[M.toUpperCase()]),typeof M=="number"&&M>=0&&M<=r.levels.SILENT){if(s=M,R!==!1&&_(M),h.call(r,M,n),typeof console===p&&M<r.levels.SILENT)return"No console available for logging"}else throw"log.setLevel() called with invalid level: "+M},r.setDefaultLevel=function(M){E()||r.setLevel(M,!1)},r.enableAll=function(M){r.setLevel(r.levels.TRACE,M)},r.disableAll=function(M){r.setLevel(r.levels.SILENT,M)};var I=E();I==null&&(I=e??"WARN"),r.setLevel(I,!1)}var v=new a,o={};v.getLogger=function(e){if(typeof e!="string"||e==="")throw new TypeError("You must supply a name when creating a logger.");var t=o[e];return t||(t=o[e]=new a(e,v.getLevel(),v.methodFactory)),t};var i=typeof window!==p?window.log:void 0;return v.noConflict=function(){return typeof window!==p&&window.log===v&&(window.log=i),v},v.getLoggers=function(){return o},v})},{}],45:[function(O,F,w){(function(){var y=O("crypt"),p=O("charenc").utf8,d=O("is-buffer"),l=O("charenc").bin,S=function(g,b){g.constructor==String?b&&b.encoding==="binary"?g=l.stringToBytes(g):g=p.stringToBytes(g):d(g)?g=Array.prototype.slice.call(g,0):!Array.isArray(g)&&g.constructor!==Uint8Array&&(g=g.toString());for(var h=y.bytesToWords(g),T=g.length*8,u=1732584193,a=-271733879,v=-1732584194,o=271733878,i=0;i<h.length;i++)h[i]=(h[i]<<8|h[i]>>>24)&16711935|(h[i]<<24|h[i]>>>8)&4278255360;h[T>>>5]|=128<<T%32,h[(T+64>>>9<<4)+14]=T;for(var n=S._ff,e=S._gg,t=S._hh,r=S._ii,i=0;i<h.length;i+=16){var s=u,m=a,_=v,E=o;u=n(u,a,v,o,h[i+0],7,-680876936),o=n(o,u,a,v,h[i+1],12,-389564586),v=n(v,o,u,a,h[i+2],17,606105819),a=n(a,v,o,u,h[i+3],22,-1044525330),u=n(u,a,v,o,h[i+4],7,-176418897),o=n(o,u,a,v,h[i+5],12,1200080426),v=n(v,o,u,a,h[i+6],17,-1473231341),a=n(a,v,o,u,h[i+7],22,-45705983),u=n(u,a,v,o,h[i+8],7,1770035416),o=n(o,u,a,v,h[i+9],12,-1958414417),v=n(v,o,u,a,h[i+10],17,-42063),a=n(a,v,o,u,h[i+11],22,-1990404162),u=n(u,a,v,o,h[i+12],7,1804603682),o=n(o,u,a,v,h[i+13],12,-40341101),v=n(v,o,u,a,h[i+14],17,-1502002290),a=n(a,v,o,u,h[i+15],22,1236535329),u=e(u,a,v,o,h[i+1],5,-165796510),o=e(o,u,a,v,h[i+6],9,-1069501632),v=e(v,o,u,a,h[i+11],14,643717713),a=e(a,v,o,u,h[i+0],20,-373897302),u=e(u,a,v,o,h[i+5],5,-701558691),o=e(o,u,a,v,h[i+10],9,38016083),v=e(v,o,u,a,h[i+15],14,-660478335),a=e(a,v,o,u,h[i+4],20,-405537848),u=e(u,a,v,o,h[i+9],5,568446438),o=e(o,u,a,v,h[i+14],9,-1019803690),v=e(v,o,u,a,h[i+3],14,-187363961),a=e(a,v,o,u,h[i+8],20,1163531501),u=e(u,a,v,o,h[i+13],5,-1444681467),o=e(o,u,a,v,h[i+2],9,-51403784),v=e(v,o,u,a,h[i+7],14,1735328473),a=e(a,v,o,u,h[i+12],20,-1926607734),u=t(u,a,v,o,h[i+5],4,-378558),o=t(o,u,a,v,h[i+8],11,-2022574463),v=t(v,o,u,a,h[i+11],16,1839030562),a=t(a,v,o,u,h[i+14],23,-35309556),u=t(u,a,v,o,h[i+1],4,-1530992060),o=t(o,u,a,v,h[i+4],11,1272893353),v=t(v,o,u,a,h[i+7],16,-155497632),a=t(a,v,o,u,h[i+10],23,-1094730640),u=t(u,a,v,o,h[i+13],4,681279174),o=t(o,u,a,v,h[i+0],11,-358537222),v=t(v,o,u,a,h[i+3],16,-722521979),a=t(a,v,o,u,h[i+6],23,76029189),u=t(u,a,v,o,h[i+9],4,-640364487),o=t(o,u,a,v,h[i+12],11,-421815835),v=t(v,o,u,a,h[i+15],16,530742520),a=t(a,v,o,u,h[i+2],23,-995338651),u=r(u,a,v,o,h[i+0],6,-198630844),o=r(o,u,a,v,h[i+7],10,1126891415),v=r(v,o,u,a,h[i+14],15,-1416354905),a=r(a,v,o,u,h[i+5],21,-57434055),u=r(u,a,v,o,h[i+12],6,1700485571),o=r(o,u,a,v,h[i+3],10,-1894986606),v=r(v,o,u,a,h[i+10],15,-1051523),a=r(a,v,o,u,h[i+1],21,-2054922799),u=r(u,a,v,o,h[i+8],6,1873313359),o=r(o,u,a,v,h[i+15],10,-30611744),v=r(v,o,u,a,h[i+6],15,-1560198380),a=r(a,v,o,u,h[i+13],21,1309151649),u=r(u,a,v,o,h[i+4],6,-145523070),o=r(o,u,a,v,h[i+11],10,-1120210379),v=r(v,o,u,a,h[i+2],15,718787259),a=r(a,v,o,u,h[i+9],21,-343485551),u=u+s>>>0,a=a+m>>>0,v=v+_>>>0,o=o+E>>>0}return y.endian([u,a,v,o])};S._ff=function(g,b,h,T,u,a,v){var o=g+(b&h|~b&T)+(u>>>0)+v;return(o<<a|o>>>32-a)+b},S._gg=function(g,b,h,T,u,a,v){var o=g+(b&T|h&~T)+(u>>>0)+v;return(o<<a|o>>>32-a)+b},S._hh=function(g,b,h,T,u,a,v){var o=g+(b^h^T)+(u>>>0)+v;return(o<<a|o>>>32-a)+b},S._ii=function(g,b,h,T,u,a,v){var o=g+(h^(b|~T))+(u>>>0)+v;return(o<<a|o>>>32-a)+b},S._blocksize=16,S._digestsize=16,F.exports=function(g,b){if(g==null)throw new Error("Illegal argument "+g);var h=y.wordsToBytes(S(g,b));return b&&b.asBytes?h:b&&b.asString?l.bytesToString(h):y.bytesToHex(h)}})()},{charenc:41,crypt:42,"is-buffer":43}],46:[function(O,F,w){var y=O("sdp");function p(h,T,u,a,v){var o=y.writeRtpDescription(h.kind,T);if(o+=y.writeIceParameters(h.iceGatherer.getLocalParameters()),o+=y.writeDtlsParameters(h.dtlsTransport.getLocalParameters(),u==="offer"?"actpass":v||"active"),o+="a=mid:"+h.mid+`\r
`,h.rtpSender&&h.rtpReceiver?o+=`a=sendrecv\r
`:h.rtpSender?o+=`a=sendonly\r
`:h.rtpReceiver?o+=`a=recvonly\r
`:o+=`a=inactive\r
`,h.rtpSender){var i=h.rtpSender._initialTrackId||h.rtpSender.track.id;h.rtpSender._initialTrackId=i;var n="msid:"+(a?a.id:"-")+" "+i+`\r
`;o+="a="+n,o+="a=ssrc:"+h.sendEncodingParameters[0].ssrc+" "+n,h.sendEncodingParameters[0].rtx&&(o+="a=ssrc:"+h.sendEncodingParameters[0].rtx.ssrc+" "+n,o+="a=ssrc-group:FID "+h.sendEncodingParameters[0].ssrc+" "+h.sendEncodingParameters[0].rtx.ssrc+`\r
`)}return o+="a=ssrc:"+h.sendEncodingParameters[0].ssrc+" cname:"+y.localCName+`\r
`,h.rtpSender&&h.sendEncodingParameters[0].rtx&&(o+="a=ssrc:"+h.sendEncodingParameters[0].rtx.ssrc+" cname:"+y.localCName+`\r
`),o}function d(h,T){var u=!1;return h=JSON.parse(JSON.stringify(h)),h.filter(function(a){if(a&&(a.urls||a.url)){var v=a.urls||a.url;a.url&&!a.urls&&console.warn("RTCIceServer.url is deprecated! Use urls instead.");var o=typeof v=="string";return o&&(v=[v]),v=v.filter(function(i){var n=i.indexOf("turn:")===0&&i.indexOf("transport=udp")!==-1&&i.indexOf("turn:[")===-1&&!u;return n?(u=!0,!0):i.indexOf("stun:")===0&&T>=14393&&i.indexOf("?transport=udp")===-1}),delete a.url,a.urls=o?v[0]:v,!!v.length}})}function l(h,T){var u={codecs:[],headerExtensions:[],fecMechanisms:[]},a=function(o,i){o=parseInt(o,10);for(var n=0;n<i.length;n++)if(i[n].payloadType===o||i[n].preferredPayloadType===o)return i[n]},v=function(o,i,n,e){var t=a(o.parameters.apt,n),r=a(i.parameters.apt,e);return t&&r&&t.name.toLowerCase()===r.name.toLowerCase()};return h.codecs.forEach(function(o){for(var i=0;i<T.codecs.length;i++){var n=T.codecs[i];if(o.name.toLowerCase()===n.name.toLowerCase()&&o.clockRate===n.clockRate){if(o.name.toLowerCase()==="rtx"&&o.parameters&&n.parameters.apt&&!v(o,n,h.codecs,T.codecs))continue;n=JSON.parse(JSON.stringify(n)),n.numChannels=Math.min(o.numChannels,n.numChannels),u.codecs.push(n),n.rtcpFeedback=n.rtcpFeedback.filter(function(e){for(var t=0;t<o.rtcpFeedback.length;t++)if(o.rtcpFeedback[t].type===e.type&&o.rtcpFeedback[t].parameter===e.parameter)return!0;return!1});break}}}),h.headerExtensions.forEach(function(o){for(var i=0;i<T.headerExtensions.length;i++){var n=T.headerExtensions[i];if(o.uri===n.uri){u.headerExtensions.push(n);break}}}),u}function S(h,T,u){return{offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[T][h].indexOf(u)!==-1}function g(h,T){var u=h.getRemoteCandidates().find(function(a){return T.foundation===a.foundation&&T.ip===a.ip&&T.port===a.port&&T.priority===a.priority&&T.protocol===a.protocol&&T.type===a.type});return u||h.addRemoteCandidate(T),!u}function b(h,T){var u=new Error(T);return u.name=h,u}F.exports=function(h,T){function u(n,e){e.addTrack(n),e.dispatchEvent(new h.MediaStreamTrackEvent("addtrack",{track:n}))}function a(n,e){e.removeTrack(n),e.dispatchEvent(new h.MediaStreamTrackEvent("removetrack",{track:n}))}function v(n,e,t,r){var s=new Event("track");s.track=e,s.receiver=t,s.transceiver={receiver:t},s.streams=r,h.setTimeout(function(){n._dispatchEvent("track",s)})}var o=function(n){var e=this,t=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach(function(s){e[s]=t[s].bind(t)}),this.canTrickleIceCandidates=null,this.needNegotiation=!1,this.localStreams=[],this.remoteStreams=[],this.localDescription=null,this.remoteDescription=null,this.signalingState="stable",this.iceConnectionState="new",this.iceGatheringState="new",n=JSON.parse(JSON.stringify(n||{})),this.usingBundle=n.bundlePolicy==="max-bundle",n.rtcpMuxPolicy==="negotiate")throw b("NotSupportedError","rtcpMuxPolicy 'negotiate' is not supported");switch(n.rtcpMuxPolicy||(n.rtcpMuxPolicy="require"),n.iceTransportPolicy){case"all":case"relay":break;default:n.iceTransportPolicy="all";break}switch(n.bundlePolicy){case"balanced":case"max-compat":case"max-bundle":break;default:n.bundlePolicy="balanced";break}if(n.iceServers=d(n.iceServers||[],T),this._iceGatherers=[],n.iceCandidatePoolSize)for(var r=n.iceCandidatePoolSize;r>0;r--)this._iceGatherers.push(new h.RTCIceGatherer({iceServers:n.iceServers,gatherPolicy:n.iceTransportPolicy}));else n.iceCandidatePoolSize=0;this._config=n,this.transceivers=[],this._sdpSessionId=y.generateSessionId(),this._sdpSessionVersion=0,this._dtlsRole=void 0,this._isClosed=!1};o.prototype.onicecandidate=null,o.prototype.onaddstream=null,o.prototype.ontrack=null,o.prototype.onremovestream=null,o.prototype.onsignalingstatechange=null,o.prototype.oniceconnectionstatechange=null,o.prototype.onicegatheringstatechange=null,o.prototype.onnegotiationneeded=null,o.prototype.ondatachannel=null,o.prototype._dispatchEvent=function(n,e){this._isClosed||(this.dispatchEvent(e),typeof this["on"+n]=="function"&&this["on"+n](e))},o.prototype._emitGatheringStateChange=function(){var n=new Event("icegatheringstatechange");this._dispatchEvent("icegatheringstatechange",n)},o.prototype.getConfiguration=function(){return this._config},o.prototype.getLocalStreams=function(){return this.localStreams},o.prototype.getRemoteStreams=function(){return this.remoteStreams},o.prototype._createTransceiver=function(n){var e=this.transceivers.length>0,t={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:n,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,associatedRemoteMediaStreams:[],wantReceive:!0};if(this.usingBundle&&e)t.iceTransport=this.transceivers[0].iceTransport,t.dtlsTransport=this.transceivers[0].dtlsTransport;else{var r=this._createIceAndDtlsTransports();t.iceTransport=r.iceTransport,t.dtlsTransport=r.dtlsTransport}return this.transceivers.push(t),t},o.prototype.addTrack=function(n,e){if(this._isClosed)throw b("InvalidStateError","Attempted to call addTrack on a closed peerconnection.");var t=this.transceivers.find(function(m){return m.track===n});if(t)throw b("InvalidAccessError","Track already exists.");for(var r,s=0;s<this.transceivers.length;s++)!this.transceivers[s].track&&this.transceivers[s].kind===n.kind&&(r=this.transceivers[s]);return r||(r=this._createTransceiver(n.kind)),this._maybeFireNegotiationNeeded(),this.localStreams.indexOf(e)===-1&&this.localStreams.push(e),r.track=n,r.stream=e,r.rtpSender=new h.RTCRtpSender(n,r.dtlsTransport),r.rtpSender},o.prototype.addStream=function(n){var e=this;if(T>=15025)n.getTracks().forEach(function(r){e.addTrack(r,n)});else{var t=n.clone();n.getTracks().forEach(function(r,s){var m=t.getTracks()[s];r.addEventListener("enabled",function(_){m.enabled=_.enabled})}),t.getTracks().forEach(function(r){e.addTrack(r,t)})}},o.prototype.removeTrack=function(n){if(this._isClosed)throw b("InvalidStateError","Attempted to call removeTrack on a closed peerconnection.");if(!(n instanceof h.RTCRtpSender))throw new TypeError("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.");var e=this.transceivers.find(function(s){return s.rtpSender===n});if(!e)throw b("InvalidAccessError","Sender was not created by this connection.");var t=e.stream;e.rtpSender.stop(),e.rtpSender=null,e.track=null,e.stream=null;var r=this.transceivers.map(function(s){return s.stream});r.indexOf(t)===-1&&this.localStreams.indexOf(t)>-1&&this.localStreams.splice(this.localStreams.indexOf(t),1),this._maybeFireNegotiationNeeded()},o.prototype.removeStream=function(n){var e=this;n.getTracks().forEach(function(t){var r=e.getSenders().find(function(s){return s.track===t});r&&e.removeTrack(r)})},o.prototype.getSenders=function(){return this.transceivers.filter(function(n){return!!n.rtpSender}).map(function(n){return n.rtpSender})},o.prototype.getReceivers=function(){return this.transceivers.filter(function(n){return!!n.rtpReceiver}).map(function(n){return n.rtpReceiver})},o.prototype._createIceGatherer=function(n,e){var t=this;if(e&&n>0)return this.transceivers[0].iceGatherer;if(this._iceGatherers.length)return this._iceGatherers.shift();var r=new h.RTCIceGatherer({iceServers:this._config.iceServers,gatherPolicy:this._config.iceTransportPolicy});return Object.defineProperty(r,"state",{value:"new",writable:!0}),this.transceivers[n].bufferedCandidateEvents=[],this.transceivers[n].bufferCandidates=function(s){var m=!s.candidate||Object.keys(s.candidate).length===0;r.state=m?"completed":"gathering",t.transceivers[n].bufferedCandidateEvents!==null&&t.transceivers[n].bufferedCandidateEvents.push(s)},r.addEventListener("localcandidate",this.transceivers[n].bufferCandidates),r},o.prototype._gather=function(n,e){var t=this,r=this.transceivers[e].iceGatherer;if(!r.onlocalcandidate){var s=this.transceivers[e].bufferedCandidateEvents;this.transceivers[e].bufferedCandidateEvents=null,r.removeEventListener("localcandidate",this.transceivers[e].bufferCandidates),r.onlocalcandidate=function(m){if(!(t.usingBundle&&e>0)){var _=new Event("icecandidate");_.candidate={sdpMid:n,sdpMLineIndex:e};var E=m.candidate,I=!E||Object.keys(E).length===0;if(I)(r.state==="new"||r.state==="gathering")&&(r.state="completed");else{r.state==="new"&&(r.state="gathering"),E.component=1;var M=y.writeCandidate(E);_.candidate=Object.assign(_.candidate,y.parseCandidate(M)),_.candidate.candidate=M}var R=y.getMediaSections(t.localDescription.sdp);I?R[_.candidate.sdpMLineIndex]+=`a=end-of-candidates\r
`:R[_.candidate.sdpMLineIndex]+="a="+_.candidate.candidate+`\r
`,t.localDescription.sdp=y.getDescription(t.localDescription.sdp)+R.join("");var x=t.transceivers.every(function(D){return D.iceGatherer&&D.iceGatherer.state==="completed"});t.iceGatheringState!=="gathering"&&(t.iceGatheringState="gathering",t._emitGatheringStateChange()),I||t._dispatchEvent("icecandidate",_),x&&(t._dispatchEvent("icecandidate",new Event("icecandidate")),t.iceGatheringState="complete",t._emitGatheringStateChange())}},h.setTimeout(function(){s.forEach(function(m){r.onlocalcandidate(m)})},0)}},o.prototype._createIceAndDtlsTransports=function(){var n=this,e=new h.RTCIceTransport(null);e.onicestatechange=function(){n._updateConnectionState()};var t=new h.RTCDtlsTransport(e);return t.ondtlsstatechange=function(){n._updateConnectionState()},t.onerror=function(){Object.defineProperty(t,"state",{value:"failed",writable:!0}),n._updateConnectionState()},{iceTransport:e,dtlsTransport:t}},o.prototype._disposeIceAndDtlsTransports=function(n){var e=this.transceivers[n].iceGatherer;e&&(delete e.onlocalcandidate,delete this.transceivers[n].iceGatherer);var t=this.transceivers[n].iceTransport;t&&(delete t.onicestatechange,delete this.transceivers[n].iceTransport);var r=this.transceivers[n].dtlsTransport;r&&(delete r.ondtlsstatechange,delete r.onerror,delete this.transceivers[n].dtlsTransport)},o.prototype._transceive=function(n,e,t){var r=l(n.localCapabilities,n.remoteCapabilities);e&&n.rtpSender&&(r.encodings=n.sendEncodingParameters,r.rtcp={cname:y.localCName,compound:n.rtcpParameters.compound},n.recvEncodingParameters.length&&(r.rtcp.ssrc=n.recvEncodingParameters[0].ssrc),n.rtpSender.send(r)),t&&n.rtpReceiver&&r.codecs.length>0&&(n.kind==="video"&&n.recvEncodingParameters&&T<15019&&n.recvEncodingParameters.forEach(function(s){delete s.rtx}),n.recvEncodingParameters.length?r.encodings=n.recvEncodingParameters:r.encodings=[{}],r.rtcp={compound:n.rtcpParameters.compound},n.rtcpParameters.cname&&(r.rtcp.cname=n.rtcpParameters.cname),n.sendEncodingParameters.length&&(r.rtcp.ssrc=n.sendEncodingParameters[0].ssrc),n.rtpReceiver.receive(r))},o.prototype.setLocalDescription=function(n){var e=this;if(["offer","answer"].indexOf(n.type)===-1)return Promise.reject(b("TypeError",'Unsupported type "'+n.type+'"'));if(!S("setLocalDescription",n.type,e.signalingState)||e._isClosed)return Promise.reject(b("InvalidStateError","Can not set local "+n.type+" in state "+e.signalingState));var t,r;if(n.type==="offer")t=y.splitSections(n.sdp),r=t.shift(),t.forEach(function(m,_){var E=y.parseRtpParameters(m);e.transceivers[_].localCapabilities=E}),e.transceivers.forEach(function(m,_){e._gather(m.mid,_)});else if(n.type==="answer"){t=y.splitSections(e.remoteDescription.sdp),r=t.shift();var s=y.matchPrefix(r,"a=ice-lite").length>0;t.forEach(function(m,_){var E=e.transceivers[_],I=E.iceGatherer,M=E.iceTransport,R=E.dtlsTransport,x=E.localCapabilities,D=E.remoteCapabilities,f=y.isRejected(m)&&y.matchPrefix(m,"a=bundle-only").length===0;if(!f&&!E.isDatachannel){var C=y.getIceParameters(m,r),k=y.getDtlsParameters(m,r);s&&(k.role="server"),(!e.usingBundle||_===0)&&(e._gather(E.mid,_),M.state==="new"&&M.start(I,C,s?"controlling":"controlled"),R.state==="new"&&R.start(k));var c=l(x,D);e._transceive(E,c.codecs.length>0,!1)}})}return e.localDescription={type:n.type,sdp:n.sdp},n.type==="offer"?e._updateSignalingState("have-local-offer"):e._updateSignalingState("stable"),Promise.resolve()},o.prototype.setRemoteDescription=function(n){var e=this;if(["offer","answer"].indexOf(n.type)===-1)return Promise.reject(b("TypeError",'Unsupported type "'+n.type+'"'));if(!S("setRemoteDescription",n.type,e.signalingState)||e._isClosed)return Promise.reject(b("InvalidStateError","Can not set remote "+n.type+" in state "+e.signalingState));var t={};e.remoteStreams.forEach(function(M){t[M.id]=M});var r=[],s=y.splitSections(n.sdp),m=s.shift(),_=y.matchPrefix(m,"a=ice-lite").length>0,E=y.matchPrefix(m,"a=group:BUNDLE ").length>0;e.usingBundle=E;var I=y.matchPrefix(m,"a=ice-options:")[0];return I?e.canTrickleIceCandidates=I.substr(14).split(" ").indexOf("trickle")>=0:e.canTrickleIceCandidates=!1,s.forEach(function(M,R){var x=y.splitLines(M),D=y.getKind(M),f=y.isRejected(M)&&y.matchPrefix(M,"a=bundle-only").length===0,C=x[0].substr(2).split(" ")[2],k=y.getDirection(M,m),c=y.parseMsid(M),P=y.getMid(M)||y.generateIdentifier();if(D==="application"&&C==="DTLS/SCTP"){e.transceivers[R]={mid:P,isDatachannel:!0};return}var U,B,A,L,j,N,H,G,V,W=y.parseRtpParameters(M),z,q;f||(z=y.getIceParameters(M,m),q=y.getDtlsParameters(M,m),q.role="client"),H=y.parseRtpEncodingParameters(M);var X=y.parseRtcpParameters(M),Y=y.matchPrefix(M,"a=end-of-candidates",m).length>0,ee=y.matchPrefix(M,"a=candidate:").map(function(K){return y.parseCandidate(K)}).filter(function(K){return K.component===1});if((n.type==="offer"||n.type==="answer")&&!f&&E&&R>0&&e.transceivers[R]&&(e._disposeIceAndDtlsTransports(R),e.transceivers[R].iceGatherer=e.transceivers[0].iceGatherer,e.transceivers[R].iceTransport=e.transceivers[0].iceTransport,e.transceivers[R].dtlsTransport=e.transceivers[0].dtlsTransport,e.transceivers[R].rtpSender&&e.transceivers[R].rtpSender.setTransport(e.transceivers[0].dtlsTransport),e.transceivers[R].rtpReceiver&&e.transceivers[R].rtpReceiver.setTransport(e.transceivers[0].dtlsTransport)),n.type==="offer"&&!f){U=e.transceivers[R]||e._createTransceiver(D),U.mid=P,U.iceGatherer||(U.iceGatherer=e._createIceGatherer(R,E)),ee.length&&U.iceTransport.state==="new"&&(Y&&(!E||R===0)?U.iceTransport.setRemoteCandidates(ee):ee.forEach(function(K){g(U.iceTransport,K)})),G=h.RTCRtpReceiver.getCapabilities(D),T<15019&&(G.codecs=G.codecs.filter(function(K){return K.name!=="rtx"})),N=U.sendEncodingParameters||[{ssrc:(2*R+2)*1001}];var ie=!1;if(k==="sendrecv"||k==="sendonly"){if(ie=!U.rtpReceiver,j=U.rtpReceiver||new h.RTCRtpReceiver(U.dtlsTransport,D),ie){var te;V=j.track,c&&c.stream==="-"||(c?(t[c.stream]||(t[c.stream]=new h.MediaStream,Object.defineProperty(t[c.stream],"id",{get:function(){return c.stream}})),Object.defineProperty(V,"id",{get:function(){return c.track}}),te=t[c.stream]):(t.default||(t.default=new h.MediaStream),te=t.default)),te&&(u(V,te),U.associatedRemoteMediaStreams.push(te)),r.push([V,j,te])}}else U.rtpReceiver&&U.rtpReceiver.track&&(U.associatedRemoteMediaStreams.forEach(function(K){var oe=K.getTracks().find(function(se){return se.id===U.rtpReceiver.track.id});oe&&a(oe,K)}),U.associatedRemoteMediaStreams=[]);U.localCapabilities=G,U.remoteCapabilities=W,U.rtpReceiver=j,U.rtcpParameters=X,U.sendEncodingParameters=N,U.recvEncodingParameters=H,e._transceive(e.transceivers[R],!1,ie)}else n.type==="answer"&&!f&&(U=e.transceivers[R],B=U.iceGatherer,A=U.iceTransport,L=U.dtlsTransport,j=U.rtpReceiver,N=U.sendEncodingParameters,G=U.localCapabilities,e.transceivers[R].recvEncodingParameters=H,e.transceivers[R].remoteCapabilities=W,e.transceivers[R].rtcpParameters=X,ee.length&&A.state==="new"&&((_||Y)&&(!E||R===0)?A.setRemoteCandidates(ee):ee.forEach(function(K){g(U.iceTransport,K)})),(!E||R===0)&&(A.state==="new"&&A.start(B,z,"controlling"),L.state==="new"&&L.start(q)),e._transceive(U,k==="sendrecv"||k==="recvonly",k==="sendrecv"||k==="sendonly"),j&&(k==="sendrecv"||k==="sendonly")?(V=j.track,c?(t[c.stream]||(t[c.stream]=new h.MediaStream),u(V,t[c.stream]),r.push([V,j,t[c.stream]])):(t.default||(t.default=new h.MediaStream),u(V,t.default),r.push([V,j,t.default]))):delete U.rtpReceiver)}),e._dtlsRole===void 0&&(e._dtlsRole=n.type==="offer"?"active":"passive"),e.remoteDescription={type:n.type,sdp:n.sdp},n.type==="offer"?e._updateSignalingState("have-remote-offer"):e._updateSignalingState("stable"),Object.keys(t).forEach(function(M){var R=t[M];if(R.getTracks().length){if(e.remoteStreams.indexOf(R)===-1){e.remoteStreams.push(R);var x=new Event("addstream");x.stream=R,h.setTimeout(function(){e._dispatchEvent("addstream",x)})}r.forEach(function(D){var f=D[0],C=D[1];R.id===D[2].id&&v(e,f,C,[R])})}}),r.forEach(function(M){M[2]||v(e,M[0],M[1],[])}),h.setTimeout(function(){e&&e.transceivers&&e.transceivers.forEach(function(M){M.iceTransport&&M.iceTransport.state==="new"&&M.iceTransport.getRemoteCandidates().length>0&&(console.warn("Timeout for addRemoteCandidate. Consider sending an end-of-candidates notification"),M.iceTransport.addRemoteCandidate({}))})},4e3),Promise.resolve()},o.prototype.close=function(){this.transceivers.forEach(function(n){n.iceTransport&&n.iceTransport.stop(),n.dtlsTransport&&n.dtlsTransport.stop(),n.rtpSender&&n.rtpSender.stop(),n.rtpReceiver&&n.rtpReceiver.stop()}),this._isClosed=!0,this._updateSignalingState("closed")},o.prototype._updateSignalingState=function(n){this.signalingState=n;var e=new Event("signalingstatechange");this._dispatchEvent("signalingstatechange",e)},o.prototype._maybeFireNegotiationNeeded=function(){var n=this;this.signalingState!=="stable"||this.needNegotiation===!0||(this.needNegotiation=!0,h.setTimeout(function(){if(n.needNegotiation){n.needNegotiation=!1;var e=new Event("negotiationneeded");n._dispatchEvent("negotiationneeded",e)}},0))},o.prototype._updateConnectionState=function(){var n,e={new:0,closed:0,connecting:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach(function(r){e[r.iceTransport.state]++,e[r.dtlsTransport.state]++}),e.connected+=e.completed,n="new",e.failed>0?n="failed":e.connecting>0||e.checking>0?n="connecting":e.disconnected>0?n="disconnected":e.new>0?n="new":(e.connected>0||e.completed>0)&&(n="connected"),n!==this.iceConnectionState){this.iceConnectionState=n;var t=new Event("iceconnectionstatechange");this._dispatchEvent("iceconnectionstatechange",t)}},o.prototype.createOffer=function(){var n=this;if(n._isClosed)return Promise.reject(b("InvalidStateError","Can not call createOffer after close"));var e=n.transceivers.filter(function(_){return _.kind==="audio"}).length,t=n.transceivers.filter(function(_){return _.kind==="video"}).length,r=arguments[0];if(r){if(r.mandatory||r.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");r.offerToReceiveAudio!==void 0&&(r.offerToReceiveAudio===!0?e=1:r.offerToReceiveAudio===!1?e=0:e=r.offerToReceiveAudio),r.offerToReceiveVideo!==void 0&&(r.offerToReceiveVideo===!0?t=1:r.offerToReceiveVideo===!1?t=0:t=r.offerToReceiveVideo)}for(n.transceivers.forEach(function(_){_.kind==="audio"?(e--,e<0&&(_.wantReceive=!1)):_.kind==="video"&&(t--,t<0&&(_.wantReceive=!1))});e>0||t>0;)e>0&&(n._createTransceiver("audio"),e--),t>0&&(n._createTransceiver("video"),t--);var s=y.writeSessionBoilerplate(n._sdpSessionId,n._sdpSessionVersion++);n.transceivers.forEach(function(_,E){var I=_.track,M=_.kind,R=_.mid||y.generateIdentifier();_.mid=R,_.iceGatherer||(_.iceGatherer=n._createIceGatherer(E,n.usingBundle));var x=h.RTCRtpSender.getCapabilities(M);T<15019&&(x.codecs=x.codecs.filter(function(f){return f.name!=="rtx"})),x.codecs.forEach(function(f){f.name==="H264"&&f.parameters["level-asymmetry-allowed"]===void 0&&(f.parameters["level-asymmetry-allowed"]="1"),_.remoteCapabilities&&_.remoteCapabilities.codecs&&_.remoteCapabilities.codecs.forEach(function(C){f.name.toLowerCase()===C.name.toLowerCase()&&f.clockRate===C.clockRate&&(f.preferredPayloadType=C.payloadType)})}),x.headerExtensions.forEach(function(f){var C=_.remoteCapabilities&&_.remoteCapabilities.headerExtensions||[];C.forEach(function(k){f.uri===k.uri&&(f.id=k.id)})});var D=_.sendEncodingParameters||[{ssrc:(2*E+1)*1001}];I&&T>=15019&&M==="video"&&!D[0].rtx&&(D[0].rtx={ssrc:D[0].ssrc+1}),_.wantReceive&&(_.rtpReceiver=new h.RTCRtpReceiver(_.dtlsTransport,M)),_.localCapabilities=x,_.sendEncodingParameters=D}),n._config.bundlePolicy!=="max-compat"&&(s+="a=group:BUNDLE "+n.transceivers.map(function(_){return _.mid}).join(" ")+`\r
`),s+=`a=ice-options:trickle\r
`,n.transceivers.forEach(function(_,E){s+=p(_,_.localCapabilities,"offer",_.stream,n._dtlsRole),s+=`a=rtcp-rsize\r
`,_.iceGatherer&&n.iceGatheringState!=="new"&&(E===0||!n.usingBundle)&&(_.iceGatherer.getLocalCandidates().forEach(function(I){I.component=1,s+="a="+y.writeCandidate(I)+`\r
`}),_.iceGatherer.state==="completed"&&(s+=`a=end-of-candidates\r
`))});var m=new h.RTCSessionDescription({type:"offer",sdp:s});return Promise.resolve(m)},o.prototype.createAnswer=function(){var n=this;if(n._isClosed)return Promise.reject(b("InvalidStateError","Can not call createAnswer after close"));var e=y.writeSessionBoilerplate(n._sdpSessionId,n._sdpSessionVersion++);n.usingBundle&&(e+="a=group:BUNDLE "+n.transceivers.map(function(s){return s.mid}).join(" ")+`\r
`);var t=y.getMediaSections(n.remoteDescription.sdp).length;n.transceivers.forEach(function(s,m){if(!(m+1>t)){if(s.isDatachannel){e+=`m=application 0 DTLS/SCTP 5000\r
c=IN IP4 0.0.0.0\r
a=mid:`+s.mid+`\r
`;return}if(s.stream){var _;s.kind==="audio"?_=s.stream.getAudioTracks()[0]:s.kind==="video"&&(_=s.stream.getVideoTracks()[0]),_&&T>=15019&&s.kind==="video"&&!s.sendEncodingParameters[0].rtx&&(s.sendEncodingParameters[0].rtx={ssrc:s.sendEncodingParameters[0].ssrc+1})}var E=l(s.localCapabilities,s.remoteCapabilities),I=E.codecs.filter(function(M){return M.name.toLowerCase()==="rtx"}).length;!I&&s.sendEncodingParameters[0].rtx&&delete s.sendEncodingParameters[0].rtx,e+=p(s,E,"answer",s.stream,n._dtlsRole),s.rtcpParameters&&s.rtcpParameters.reducedSize&&(e+=`a=rtcp-rsize\r
`)}});var r=new h.RTCSessionDescription({type:"answer",sdp:e});return Promise.resolve(r)},o.prototype.addIceCandidate=function(n){var e=this,t;return n&&!(n.sdpMLineIndex!==void 0||n.sdpMid)?Promise.reject(new TypeError("sdpMLineIndex or sdpMid required")):new Promise(function(r,s){if(e.remoteDescription)if(!n||n.candidate==="")for(var m=0;m<e.transceivers.length&&!(!e.transceivers[m].isDatachannel&&(e.transceivers[m].iceTransport.addRemoteCandidate({}),t=y.getMediaSections(e.remoteDescription.sdp),t[m]+=`a=end-of-candidates\r
`,e.remoteDescription.sdp=y.getDescription(e.remoteDescription.sdp)+t.join(""),e.usingBundle));m++);else{var _=n.sdpMLineIndex;if(n.sdpMid){for(var E=0;E<e.transceivers.length;E++)if(e.transceivers[E].mid===n.sdpMid){_=E;break}}var I=e.transceivers[_];if(I){if(I.isDatachannel)return r();var M=Object.keys(n.candidate).length>0?y.parseCandidate(n.candidate):{};if(M.protocol==="tcp"&&(M.port===0||M.port===9)||M.component&&M.component!==1)return r();if((_===0||_>0&&I.iceTransport!==e.transceivers[0].iceTransport)&&!g(I.iceTransport,M))return s(b("OperationError","Can not add ICE candidate"));var R=n.candidate.trim();R.indexOf("a=")===0&&(R=R.substr(2)),t=y.getMediaSections(e.remoteDescription.sdp),t[_]+="a="+(M.type?R:"end-of-candidates")+`\r
`,e.remoteDescription.sdp=t.join("")}else return s(b("OperationError","Can not add ICE candidate"))}else return s(b("InvalidStateError","Can not add ICE candidate without a remote description"));r()})},o.prototype.getStats=function(){var n=[];this.transceivers.forEach(function(t){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach(function(r){t[r]&&n.push(t[r].getStats())})});var e=function(t){return{inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[t.type]||t.type};return new Promise(function(t){var r=new Map;Promise.all(n).then(function(s){s.forEach(function(m){Object.keys(m).forEach(function(_){m[_].type=e(m[_]),r.set(_,m[_])})}),t(r)})})};var i=["createOffer","createAnswer"];return i.forEach(function(n){var e=o.prototype[n];o.prototype[n]=function(){var t=arguments;return typeof t[0]=="function"||typeof t[1]=="function"?e.apply(this,[arguments[2]]).then(function(r){typeof t[0]=="function"&&t[0].apply(null,[r])},function(r){typeof t[1]=="function"&&t[1].apply(null,[r])}):e.apply(this,arguments)}}),i=["setLocalDescription","setRemoteDescription","addIceCandidate"],i.forEach(function(n){var e=o.prototype[n];o.prototype[n]=function(){var t=arguments;return typeof t[1]=="function"||typeof t[2]=="function"?e.apply(this,arguments).then(function(){typeof t[1]=="function"&&t[1].apply(null)},function(r){typeof t[2]=="function"&&t[2].apply(null,[r])}):e.apply(this,arguments)}}),["getStats"].forEach(function(n){var e=o.prototype[n];o.prototype[n]=function(){var t=arguments;return typeof t[1]=="function"?e.apply(this,arguments).then(function(){typeof t[1]=="function"&&t[1].apply(null)}):e.apply(this,arguments)}}),o}},{sdp:47}],47:[function(O,F,w){var y={};y.generateIdentifier=function(){return Math.random().toString(36).substr(2,10)},y.localCName=y.generateIdentifier(),y.splitLines=function(p){return p.trim().split(`
`).map(function(d){return d.trim()})},y.splitSections=function(p){var d=p.split(`
m=`);return d.map(function(l,S){return(S>0?"m="+l:l).trim()+`\r
`})},y.getDescription=function(p){var d=y.splitSections(p);return d&&d[0]},y.getMediaSections=function(p){var d=y.splitSections(p);return d.shift(),d},y.matchPrefix=function(p,d){return y.splitLines(p).filter(function(l){return l.indexOf(d)===0})},y.parseCandidate=function(p){var d;p.indexOf("a=candidate:")===0?d=p.substring(12).split(" "):d=p.substring(10).split(" ");for(var l={foundation:d[0],component:parseInt(d[1],10),protocol:d[2].toLowerCase(),priority:parseInt(d[3],10),ip:d[4],address:d[4],port:parseInt(d[5],10),type:d[7]},S=8;S<d.length;S+=2)switch(d[S]){case"raddr":l.relatedAddress=d[S+1];break;case"rport":l.relatedPort=parseInt(d[S+1],10);break;case"tcptype":l.tcpType=d[S+1];break;case"ufrag":l.ufrag=d[S+1],l.usernameFragment=d[S+1];break;default:l[d[S]]=d[S+1];break}return l},y.writeCandidate=function(p){var d=[];d.push(p.foundation),d.push(p.component),d.push(p.protocol.toUpperCase()),d.push(p.priority),d.push(p.address||p.ip),d.push(p.port);var l=p.type;return d.push("typ"),d.push(l),l!=="host"&&p.relatedAddress&&p.relatedPort&&(d.push("raddr"),d.push(p.relatedAddress),d.push("rport"),d.push(p.relatedPort)),p.tcpType&&p.protocol.toLowerCase()==="tcp"&&(d.push("tcptype"),d.push(p.tcpType)),(p.usernameFragment||p.ufrag)&&(d.push("ufrag"),d.push(p.usernameFragment||p.ufrag)),"candidate:"+d.join(" ")},y.parseIceOptions=function(p){return p.substr(14).split(" ")},y.parseRtpMap=function(p){var d=p.substr(9).split(" "),l={payloadType:parseInt(d.shift(),10)};return d=d[0].split("/"),l.name=d[0],l.clockRate=parseInt(d[1],10),l.channels=d.length===3?parseInt(d[2],10):1,l.numChannels=l.channels,l},y.writeRtpMap=function(p){var d=p.payloadType;p.preferredPayloadType!==void 0&&(d=p.preferredPayloadType);var l=p.channels||p.numChannels||1;return"a=rtpmap:"+d+" "+p.name+"/"+p.clockRate+(l!==1?"/"+l:"")+`\r
`},y.parseExtmap=function(p){var d=p.substr(9).split(" ");return{id:parseInt(d[0],10),direction:d[0].indexOf("/")>0?d[0].split("/")[1]:"sendrecv",uri:d[1]}},y.writeExtmap=function(p){return"a=extmap:"+(p.id||p.preferredId)+(p.direction&&p.direction!=="sendrecv"?"/"+p.direction:"")+" "+p.uri+`\r
`},y.parseFmtp=function(p){for(var d={},l,S=p.substr(p.indexOf(" ")+1).split(";"),g=0;g<S.length;g++)l=S[g].trim().split("="),d[l[0].trim()]=l[1];return d},y.writeFmtp=function(p){var d="",l=p.payloadType;if(p.preferredPayloadType!==void 0&&(l=p.preferredPayloadType),p.parameters&&Object.keys(p.parameters).length){var S=[];Object.keys(p.parameters).forEach(function(g){p.parameters[g]?S.push(g+"="+p.parameters[g]):S.push(g)}),d+="a=fmtp:"+l+" "+S.join(";")+`\r
`}return d},y.parseRtcpFb=function(p){var d=p.substr(p.indexOf(" ")+1).split(" ");return{type:d.shift(),parameter:d.join(" ")}},y.writeRtcpFb=function(p){var d="",l=p.payloadType;return p.preferredPayloadType!==void 0&&(l=p.preferredPayloadType),p.rtcpFeedback&&p.rtcpFeedback.length&&p.rtcpFeedback.forEach(function(S){d+="a=rtcp-fb:"+l+" "+S.type+(S.parameter&&S.parameter.length?" "+S.parameter:"")+`\r
`}),d},y.parseSsrcMedia=function(p){var d=p.indexOf(" "),l={ssrc:parseInt(p.substr(7,d-7),10)},S=p.indexOf(":",d);return S>-1?(l.attribute=p.substr(d+1,S-d-1),l.value=p.substr(S+1)):l.attribute=p.substr(d+1),l},y.parseSsrcGroup=function(p){var d=p.substr(13).split(" ");return{semantics:d.shift(),ssrcs:d.map(function(l){return parseInt(l,10)})}},y.getMid=function(p){var d=y.matchPrefix(p,"a=mid:")[0];if(d)return d.substr(6)},y.parseFingerprint=function(p){var d=p.substr(14).split(" ");return{algorithm:d[0].toLowerCase(),value:d[1]}},y.getDtlsParameters=function(p,d){var l=y.matchPrefix(p+d,"a=fingerprint:");return{role:"auto",fingerprints:l.map(y.parseFingerprint)}},y.writeDtlsParameters=function(p,d){var l="a=setup:"+d+`\r
`;return p.fingerprints.forEach(function(S){l+="a=fingerprint:"+S.algorithm+" "+S.value+`\r
`}),l},y.parseCryptoLine=function(p){var d=p.substr(9).split(" ");return{tag:parseInt(d[0],10),cryptoSuite:d[1],keyParams:d[2],sessionParams:d.slice(3)}},y.writeCryptoLine=function(p){return"a=crypto:"+p.tag+" "+p.cryptoSuite+" "+(typeof p.keyParams=="object"?y.writeCryptoKeyParams(p.keyParams):p.keyParams)+(p.sessionParams?" "+p.sessionParams.join(" "):"")+`\r
`},y.parseCryptoKeyParams=function(p){if(p.indexOf("inline:")!==0)return null;var d=p.substr(7).split("|");return{keyMethod:"inline",keySalt:d[0],lifeTime:d[1],mkiValue:d[2]?d[2].split(":")[0]:void 0,mkiLength:d[2]?d[2].split(":")[1]:void 0}},y.writeCryptoKeyParams=function(p){return p.keyMethod+":"+p.keySalt+(p.lifeTime?"|"+p.lifeTime:"")+(p.mkiValue&&p.mkiLength?"|"+p.mkiValue+":"+p.mkiLength:"")},y.getCryptoParameters=function(p,d){var l=y.matchPrefix(p+d,"a=crypto:");return l.map(y.parseCryptoLine)},y.getIceParameters=function(p,d){var l=y.matchPrefix(p+d,"a=ice-ufrag:")[0],S=y.matchPrefix(p+d,"a=ice-pwd:")[0];return l&&S?{usernameFragment:l.substr(12),password:S.substr(10)}:null},y.writeIceParameters=function(p){return"a=ice-ufrag:"+p.usernameFragment+`\r
a=ice-pwd:`+p.password+`\r
`},y.parseRtpParameters=function(p){for(var d={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},l=y.splitLines(p),S=l[0].split(" "),g=3;g<S.length;g++){var b=S[g],h=y.matchPrefix(p,"a=rtpmap:"+b+" ")[0];if(h){var T=y.parseRtpMap(h),u=y.matchPrefix(p,"a=fmtp:"+b+" ");switch(T.parameters=u.length?y.parseFmtp(u[0]):{},T.rtcpFeedback=y.matchPrefix(p,"a=rtcp-fb:"+b+" ").map(y.parseRtcpFb),d.codecs.push(T),T.name.toUpperCase()){case"RED":case"ULPFEC":d.fecMechanisms.push(T.name.toUpperCase());break}}}return y.matchPrefix(p,"a=extmap:").forEach(function(a){d.headerExtensions.push(y.parseExtmap(a))}),d},y.writeRtpDescription=function(p,d){var l="";l+="m="+p+" ",l+=d.codecs.length>0?"9":"0",l+=" UDP/TLS/RTP/SAVPF ",l+=d.codecs.map(function(g){return g.preferredPayloadType!==void 0?g.preferredPayloadType:g.payloadType}).join(" ")+`\r
`,l+=`c=IN IP4 0.0.0.0\r
`,l+=`a=rtcp:9 IN IP4 0.0.0.0\r
`,d.codecs.forEach(function(g){l+=y.writeRtpMap(g),l+=y.writeFmtp(g),l+=y.writeRtcpFb(g)});var S=0;return d.codecs.forEach(function(g){g.maxptime>S&&(S=g.maxptime)}),S>0&&(l+="a=maxptime:"+S+`\r
`),l+=`a=rtcp-mux\r
`,d.headerExtensions&&d.headerExtensions.forEach(function(g){l+=y.writeExtmap(g)}),l},y.parseRtpEncodingParameters=function(p){var d=[],l=y.parseRtpParameters(p),S=l.fecMechanisms.indexOf("RED")!==-1,g=l.fecMechanisms.indexOf("ULPFEC")!==-1,b=y.matchPrefix(p,"a=ssrc:").map(function(v){return y.parseSsrcMedia(v)}).filter(function(v){return v.attribute==="cname"}),h=b.length>0&&b[0].ssrc,T,u=y.matchPrefix(p,"a=ssrc-group:FID").map(function(v){var o=v.substr(17).split(" ");return o.map(function(i){return parseInt(i,10)})});u.length>0&&u[0].length>1&&u[0][0]===h&&(T=u[0][1]),l.codecs.forEach(function(v){if(v.name.toUpperCase()==="RTX"&&v.parameters.apt){var o={ssrc:h,codecPayloadType:parseInt(v.parameters.apt,10)};h&&T&&(o.rtx={ssrc:T}),d.push(o),S&&(o=JSON.parse(JSON.stringify(o)),o.fec={ssrc:h,mechanism:g?"red+ulpfec":"red"},d.push(o))}}),d.length===0&&h&&d.push({ssrc:h});var a=y.matchPrefix(p,"b=");return a.length&&(a[0].indexOf("b=TIAS:")===0?a=parseInt(a[0].substr(7),10):a[0].indexOf("b=AS:")===0?a=parseInt(a[0].substr(5),10)*1e3*.95-16e3:a=void 0,d.forEach(function(v){v.maxBitrate=a})),d},y.parseRtcpParameters=function(p){var d={},l=y.matchPrefix(p,"a=ssrc:").map(function(b){return y.parseSsrcMedia(b)}).filter(function(b){return b.attribute==="cname"})[0];l&&(d.cname=l.value,d.ssrc=l.ssrc);var S=y.matchPrefix(p,"a=rtcp-rsize");d.reducedSize=S.length>0,d.compound=S.length===0;var g=y.matchPrefix(p,"a=rtcp-mux");return d.mux=g.length>0,d},y.parseMsid=function(p){var d,l=y.matchPrefix(p,"a=msid:");if(l.length===1)return d=l[0].substr(7).split(" "),{stream:d[0],track:d[1]};var S=y.matchPrefix(p,"a=ssrc:").map(function(g){return y.parseSsrcMedia(g)}).filter(function(g){return g.attribute==="msid"});if(S.length>0)return d=S[0].value.split(" "),{stream:d[0],track:d[1]}},y.parseSctpDescription=function(p){var d=y.parseMLine(p),l=y.matchPrefix(p,"a=max-message-size:"),S;l.length>0&&(S=parseInt(l[0].substr(19),10)),isNaN(S)&&(S=65536);var g=y.matchPrefix(p,"a=sctp-port:");if(g.length>0)return{port:parseInt(g[0].substr(12),10),protocol:d.fmt,maxMessageSize:S};var b=y.matchPrefix(p,"a=sctpmap:");if(b.length>0){var h=y.matchPrefix(p,"a=sctpmap:")[0].substr(10).split(" ");return{port:parseInt(h[0],10),protocol:h[1],maxMessageSize:S}}},y.writeSctpDescription=function(p,d){var l=[];return p.protocol!=="DTLS/SCTP"?l=["m="+p.kind+" 9 "+p.protocol+" "+d.protocol+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctp-port:"+d.port+`\r
`]:l=["m="+p.kind+" 9 "+p.protocol+" "+d.port+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctpmap:"+d.port+" "+d.protocol+` 65535\r
`],d.maxMessageSize!==void 0&&l.push("a=max-message-size:"+d.maxMessageSize+`\r
`),l.join("")},y.generateSessionId=function(){return Math.random().toString().substr(2,21)},y.writeSessionBoilerplate=function(p,d,l){var S,g=d!==void 0?d:2;p?S=p:S=y.generateSessionId();var b=l||"thisisadapterortc";return`v=0\r
o=`+b+" "+S+" "+g+` IN IP4 127.0.0.1\r
s=-\r
t=0 0\r
`},y.writeMediaSection=function(p,d,l,S){var g=y.writeRtpDescription(p.kind,d);if(g+=y.writeIceParameters(p.iceGatherer.getLocalParameters()),g+=y.writeDtlsParameters(p.dtlsTransport.getLocalParameters(),l==="offer"?"actpass":"active"),g+="a=mid:"+p.mid+`\r
`,p.direction?g+="a="+p.direction+`\r
`:p.rtpSender&&p.rtpReceiver?g+=`a=sendrecv\r
`:p.rtpSender?g+=`a=sendonly\r
`:p.rtpReceiver?g+=`a=recvonly\r
`:g+=`a=inactive\r
`,p.rtpSender){var b="msid:"+S.id+" "+p.rtpSender.track.id+`\r
`;g+="a="+b,g+="a=ssrc:"+p.sendEncodingParameters[0].ssrc+" "+b,p.sendEncodingParameters[0].rtx&&(g+="a=ssrc:"+p.sendEncodingParameters[0].rtx.ssrc+" "+b,g+="a=ssrc-group:FID "+p.sendEncodingParameters[0].ssrc+" "+p.sendEncodingParameters[0].rtx.ssrc+`\r
`)}return g+="a=ssrc:"+p.sendEncodingParameters[0].ssrc+" cname:"+y.localCName+`\r
`,p.rtpSender&&p.sendEncodingParameters[0].rtx&&(g+="a=ssrc:"+p.sendEncodingParameters[0].rtx.ssrc+" cname:"+y.localCName+`\r
`),g},y.getDirection=function(p,d){for(var l=y.splitLines(p),S=0;S<l.length;S++)switch(l[S]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return l[S].substr(2)}return d?y.getDirection(d):"sendrecv"},y.getKind=function(p){var d=y.splitLines(p),l=d[0].split(" ");return l[0].substr(2)},y.isRejected=function(p){return p.split(" ",2)[1]==="0"},y.parseMLine=function(p){var d=y.splitLines(p),l=d[0].substr(2).split(" ");return{kind:l[0],port:parseInt(l[1],10),protocol:l[2],fmt:l.slice(3).join(" ")}},y.parseOLine=function(p){var d=y.matchPrefix(p,"o=")[0],l=d.substr(2).split(" ");return{username:l[0],sessionId:l[1],sessionVersion:parseInt(l[2],10),netType:l[3],addressType:l[4],address:l[5]}},y.isValidSDP=function(p){if(typeof p!="string"||p.length===0)return!1;for(var d=y.splitLines(p),l=0;l<d.length;l++)if(d[l].length<2||d[l].charAt(1)!=="=")return!1;return!0},typeof F=="object"&&(F.exports=y)},{}]},{},[1]),Q=ne(1);{var J=Z.Twilio=Z.Twilio||{};J.Call=J.Call||Q.Call,J.Device=J.Device||Q.Device,J.PStream=J.PStream||Q.PStream,J.PreflightTest=J.PreflightTest||Q.PreflightTest,J.Logger=J.Logger||Q.Logger}})(typeof window<"u"?window:typeof $<"u"?$:$)})();const le=ce(ae),fe=ue({__proto__:null,default:le},[ae]);export{fe as t};
